<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>טריווBIO - ניהול</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* --- General Styles --- */
      :root {
        --bg-color: #f5f7fa;
        --text-color: #2d3748;
        --card-bg: #ffffff;
        --card-border: #e2e8f0;
        --button-bg: #a3bffa;
        --button-hover-bg: #7f9cf5;
        --button-text: white;
        --input-bg: #e2e8f0;
        --input-border: #cbd5e0;
        --accent-color: #7f9cf5;
        --success-color: #48bb78;
        --danger-color: #f56565;
        --link-color: #5a67d8;
        --disabled-bg: #cbd5e0;
        --disabled-text: #a0aec0;
        --icon-color: #4a5568;
        --modal-overlay-bg: rgba(0, 0, 0, 0.6);
        --preview-item-bg: #edf2f7;
        --preview-item-border: #cbd5e0;
        --error-list-item-bg: #fff5f5;
        --error-list-item-border: #fc8181;
        --error-list-item-text: #c53030;
      }

      body.dark-mode {
        --bg-color: #1a202c;
        --text-color: #e2e8f0;
        --card-bg: #2d3748;
        --card-border: #4a5568;
        --button-bg: #4a5568;
        --button-hover-bg: #2d3748;
        --button-text: #e2e8f0;
        --input-bg: #4a5568;
        --input-border: #718096;
        --accent-color: #63b3ed;
        --success-color: #68d391;
        --danger-color: #fc8181;
        --link-color: #63b3ed;
        --disabled-bg: #4a5568;
        --disabled-text: #718096;
        --icon-color: #a0aec0;
        --modal-overlay-bg: rgba(0, 0, 0, 0.7);
        --preview-item-bg: #4a5568;
        --preview-item-border: #718096;
        --error-list-item-bg: #4a2121;
        --error-list-item-border: #fc8181;
        --error-list-item-text: #fc8181;
      }

      body {
        font-family: "Noto Sans Hebrew", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 0;
        transition: background-color 0.3s, color 0.3s;
        line-height: 1.6;
        box-sizing: border-box;
      }
      *,
      *::before,
      *::after {
        box-sizing: inherit;
      }

      .container {
        max-width: 900px;
        margin: 20px auto;
        padding: 15px;
      }

      /* --- Header --- */
      header {
        display: flex;
        justify-content: center; /* Keeps title centered */
        align-items: center;
        position: relative; /* Needed for absolute positioning of children */
        margin-bottom: 20px;
        padding: 10px 0; /* Add some padding */
        min-height: 50px; /* Ensure minimum height */
        /* Remove flex-wrap and gap if not needed with absolute positioning */
        /* flex-wrap: wrap; */
        /* gap: 10px; */
      }

      header h1 {
        font-size: 1.8rem;
        margin: 0;
        /* Remove order */
        /* order: 2; */
        /* Title will center automatically between absolutely positioned elements */
        padding: 0 50px; /* Add padding to prevent overlap on smaller screens */
        text-align: center;
      }

      /* --- Theme Toggle (Right) --- */
      header .switch {
        position: absolute;
        right: 15px; /* Position on the right */
        top: 50%;
        transform: translateY(-50%);
        /* Remove order */
        /* order: 1; */
        z-index: 2; /* Ensure it's clickable */
      }

      /* --- User Info Container (Left) --- */
      #admin-user-info {
        position: absolute;
        left: 15px; /* Position on the left */
        top: 50%;
        transform: translateY(-50%);
        text-align: left; /* Align text to the left */
        z-index: 2; /* Ensure it's clickable */
      }

      #admin-username-display {
        font-size: 0.9rem;
        font-weight: bold;
        color: var(--text-color);
        display: block; /* Make it a block element */
        margin-bottom: 4px; /* Space between username and button */
        max-width: 180px; /* Prevent very long emails from breaking layout */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #admin-user-info #logout-btn {
        /* Remove order */
        /* order: 3; */
        display: block; /* Make button block level */
        margin: 0; /* Remove default button margin */
        padding: 5px 10px; /* Adjust padding if needed */
        font-size: 0.85rem; /* Slightly smaller font */
      }

      /* --- Responsive Adjustments for Header --- */
      @media (max-width: 700px) {
        header h1 {
          font-size: 1.5rem;
          padding: 0 40px; /* Adjust padding */
        }
        #admin-username-display {
          font-size: 0.8rem;
          max-width: 120px;
        }
        #admin-user-info #logout-btn {
          padding: 4px 8px;
          font-size: 0.8rem;
        }
        header .switch {
          right: 10px;
        }
        #admin-user-info {
          left: 10px;
        }
      }

      @media (max-width: 500px) {
        header {
          min-height: 70px; /* Increase height to accommodate elements potentially wrapping */
          padding-top: 15px;
          padding-bottom: 15px;
        }
        header h1 {
          font-size: 1.3rem;
          padding: 0 10px; /* Reduce padding further */
          position: relative; /* Allow slight adjustment */
          top: 10px; /* Push title down slightly if needed */
          width: 100%; /* Take full width below buttons */
          order: 2; /* Ensure title is below */
        }
        header .switch {
          top: 10px; /* Position near top */
          transform: none;
          right: 10px;
          order: 1; /* Slider first */
        }
        #admin-user-info {
          top: 10px; /* Position near top */
          transform: none;
          left: 10px;
          order: 0; /* User info first */
        }
        #admin-username-display {
          max-width: 100px;
        }
      }

      /* --- Ensure existing styles for .switch, .slider, .theme-icon remain the same --- */
      /* ... (keep existing styles for the switch appearance) ... */

      h1 {
        font-size: 1.8rem;
        margin: 0;
        order: 2;
      }
      header .switch {
        order: 1;
      }
      header #logout-btn {
        order: 3;
      }

      /* --- Theme Toggle --- */
      .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 5px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--accent-color);
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }
      .theme-icon {
        width: 20px;
        height: 20px;
        transition: opacity 0.4s;
      }
      .sun {
        opacity: 1;
      }
      .moon {
        opacity: 0;
      }
      input:checked + .slider .sun {
        opacity: 0;
      }
      input:checked + .slider .moon {
        opacity: 1;
      }

      /* --- Buttons --- */
      button {
        font-family: "Noto Sans Hebrew", sans-serif;
        padding: 8px 15px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 0.95rem;
        transition: background-color 0.3s, transform 0.1s, opacity 0.2s;
        margin: 5px;
        vertical-align: middle;
      }
      button:active {
        transform: scale(0.98);
      }
      button:disabled {
        background-color: var(--disabled-bg) !important;
        color: var(--disabled-text) !important;
        cursor: not-allowed;
        transform: none !important;
        opacity: 0.7;
      }
      .btn-primary {
        background-color: var(--button-bg);
        color: var(--button-text);
      }
      .btn-primary:hover:not(:disabled) {
        background-color: var(--button-hover-bg);
      }
      .btn-danger {
        background-color: var(--danger-color);
        color: white;
      }
      .btn-danger:hover:not(:disabled) {
        opacity: 0.85;
      }
      .btn-success {
        background-color: var(--success-color);
        color: white;
      }
      .btn-success:hover:not(:disabled) {
        opacity: 0.85;
      }
      .btn-secondary {
        background-color: #a0aec0;
        color: white;
      }
      .btn-secondary:hover:not(:disabled) {
        background-color: #718096;
      }
      body.dark-mode .btn-secondary {
        background-color: #4a5568;
        color: var(--button-text);
      }
      body.dark-mode .btn-secondary:hover:not(:disabled) {
        background-color: #2d3748;
      }
      .btn-icon {
        padding: 5px;
        background-color: transparent;
        border: 1px solid var(--input-border);
        color: var(--icon-color);
        line-height: 1;
        transition: background-color 0.2s, border-color 0.2s, color 0.2s,
          box-shadow 0.2s;
        margin: 0;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .btn-icon:hover:not(:disabled) {
        background-color: var(--input-bg);
        border-color: var(--accent-color);
        color: var(--accent-color);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .btn-icon svg {
        vertical-align: middle;
        width: 16px;
        height: 16px;
      }
      .btn-round {
        border-radius: 50%;
        width: 34px;
        height: 34px;
        display: inline-flex;
        justify-content: center;
        align-items: center;
      }
      #refresh-dashboard-btn.refreshing svg {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* --- Auth Section --- */
      #auth-section {
        text-align: center;
        padding: 40px 20px;
      }
      #auth-section p {
        margin-bottom: 20px;
        font-size: 1.1rem;
      }

      /* --- Admin Content --- */
      #admin-content {
        display: none;
      }
      .card {
        background-color: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 10px;
        padding: 0;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        overflow: hidden;
      }
      body.dark-mode .card {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      }

      /* --- Collapsible Section Styles --- */
      .collapsible-section .card-header-collapsible {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 15px 20px;
        border-bottom: 1px solid var(--card-border);
        background-color: var(--card-bg);
        position: relative;
        gap: 15px;
      }
      .collapsible-section .card-header-collapsible h2 {
        margin: 0;
        font-size: 1.2rem;
        flex-grow: 1;
      }
      .collapsible-section .toggle-icon {
        font-size: 1.6rem;
        font-weight: bold;
        line-height: 1;
        color: var(--icon-color);
        flex-shrink: 0;
        width: 20px;
        text-align: center;
        order: -1;
        margin-left: 10px;
      } /* RTL: margin-left */
      .collapsible-section .collapsible-content {
        display: none;
        padding: 15px 20px;
        border-top: none;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out, padding-top 0.4s ease-out,
          padding-bottom 0.4s ease-out;
        background-color: var(--card-bg);
      }
      .collapsible-section.is-open .card-header-collapsible {
        border-bottom-color: transparent;
      }
      .collapsible-section.is-open .collapsible-content {
        display: block;
        max-height: 2500px;
      }
      .collapsible-section
        .card-header-collapsible
        > *:not(h2):not(.toggle-icon) {
        margin-right: auto;
        flex-shrink: 0;
      } /* RTL: margin-right */

      /* --- Dashboard Styles --- */
      #dashboard-date {
        font-size: 0.8em;
        font-weight: normal;
        color: var(--disabled-text);
        margin-right: 10px;
      }
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        text-align: center;
      }
      .stat-item .stat-icon {
        display: inline-block;
        margin-left: 8px;
        font-size: 1.2em;
        vertical-align: middle;
      }
      .stat-item h3 {
        margin: 0 0 8px 0;
        font-size: 0.9rem;
        color: var(--text-color);
        opacity: 0.8;
        font-weight: normal;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1.3;
        vertical-align: middle;
      }
      .stat-item p {
        margin: 0;
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--accent-color);
        line-height: 1.1;
      }

      /* --- Leaderboard Styles --- */
      .leaderboard-note {
        font-size: 0.8rem;
        color: var(--disabled-text);
        font-weight: normal;
        margin-right: 5px;
      } /* RTL: margin-right */
      #leaderboard-enhanced-display table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }
      #leaderboard-enhanced-display th,
      #leaderboard-enhanced-display td {
        padding: 10px 8px;
        text-align: right;
        border-bottom: 1px solid var(--card-border);
        vertical-align: middle;
      }
      #leaderboard-enhanced-display th {
        font-weight: bold;
        background-color: var(--input-bg);
        white-space: nowrap;
      }
      body.dark-mode #leaderboard-enhanced-display th {
        background-color: #3a475a;
      }
      #leaderboard-enhanced-display td.rank-col {
        width: 40px;
        text-align: center;
        font-weight: bold;
        color: var(--disabled-text);
      }
      #leaderboard-enhanced-display td.name-col {
        font-weight: 500;
      }
      #leaderboard-enhanced-display td.score-col,
      #leaderboard-enhanced-display td.correct-col {
        width: 90px;
        text-align: center;
        font-weight: bold;
        direction: ltr;
      }
      #leaderboard-enhanced-display td.score-col {
        color: var(--accent-color);
      }
      #leaderboard-enhanced-display td.correct-col {
        color: var(--success-color);
      }
      #leaderboard-enhanced-display tr:last-child td {
        border-bottom: none;
      }
      #leaderboard-enhanced-display tr:hover {
        background-color: var(--input-bg);
        opacity: 0.9;
      }
      body.dark-mode #leaderboard-enhanced-display tr:hover {
        background-color: #3a475a;
      }

      /* --- User Management Styles --- */
      #user-filter-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--card-border);
        padding-bottom: 15px;
        align-items: flex-end;
      }
      #user-filter-controls > div {
        flex-grow: 1;
        min-width: 150px;
      } /* Ensure filters don't get too small */
      #user-filter-controls label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.9rem;
        font-weight: bold;
      }
      #user-filter-controls input[type="search"],
      #user-filter-controls select {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--input-border);
        background-color: var(--input-bg);
        color: var(--text-color);
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 0.95rem;
      }
      #user-filter-controls button {
        padding: 8px 12px;
        white-space: nowrap;
        flex-shrink: 0;
        align-self: flex-end;
      }

      #user-list-container table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
        table-layout: fixed;
      }
      #user-list-container th,
      #user-list-container td {
        padding: 10px 8px;
        text-align: right;
        border-bottom: 1px solid var(--card-border);
        vertical-align: middle;
        word-wrap: break-word;
      }
      #user-list-container th {
        font-weight: bold;
        background-color: var(--input-bg);
        white-space: nowrap;
        font-family: "Noto Sans Hebrew", sans-serif; /* Ensure consistent font */
        font-size: 0.95rem; /* Ensure consistent font */
      }
      body.dark-mode #user-list-container th {
        background-color: #3a475a;
      }
      #user-list-container tr:last-child td {
        border-bottom: none;
      }
      #user-list-container tr:hover {
        background-color: var(--input-bg);
        opacity: 0.9;
      }
      body.dark-mode #user-list-container tr:hover {
        background-color: #3a475a;
      }

      /* Specific Column Headers - Inherit font, set alignment/width */
      #user-list-container th.nickname-header {
        /* Default text-align: right from general th */
      }
      #user-list-container th.uid-header {
        text-align: left;
        padding-right: 10px !important;
        width: 160px;
      } /* RTL: Still align UID left */
      #user-list-container th.actions-header {
        text-align: left;
        width: 190px;
      } /* RTL: Align actions left */

      /* Specific Data Cells */
      .nickname-cell {
        width: auto;
      }
      .nickname-cell .nickname-edit {
        display: none;
        width: calc(100% - 10px);
        padding: 5px;
        border: 1px solid var(--input-border);
        background-color: var(--card-bg);
        color: var(--text-color);
        border-radius: 4px;
        font-size: inherit;
        box-sizing: border-box;
      }
      .nickname-cell.editing .nickname-display {
        display: none;
      }
      .nickname-cell.editing .nickname-edit {
        display: inline-block;
      }
      .uid-cell {
        width: 160px; /* Match header width */
        font-family: monospace; /* Keep monospace for UID data */
        font-size: 0.8em; /* Keep smaller font for UID data */
        color: var(--disabled-text);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        direction: ltr; /* Keep LTR for UID */
        text-align: left; /* Keep left align for UID */
        padding-right: 10px !important; /* RTL: Match header padding */
        vertical-align: middle; /* Ensure vertical alignment */
      }
      .actions-cell {
        width: 190px;
        white-space: nowrap;
        text-align: left;
      } /* RTL: Keep actions aligned left */
      .actions-cell button {
        margin-right: 5px;
        font-size: 0.85rem;
        padding: 4px 8px;
        vertical-align: middle;
      } /* RTL: margin-right */
      .actions-cell .btn-save-user,
      .actions-cell .btn-cancel-edit-user {
        display: none;
      }
      .actions-cell.editing .btn-edit-user,
      .actions-cell.editing .btn-delete-user {
        display: none;
      }
      .actions-cell.editing .btn-save-user,
      .actions-cell.editing .btn-cancel-edit-user {
        display: inline-block;
      }
      #no-users-message {
        padding: 20px;
        text-align: center;
        color: var(--disabled-text);
      }
      body.dark-mode #no-users-message {
        color: var(--disabled-bg);
      }

      /* --- Questions Section --- */
      #questions-section .card-header-collapsible #add-question-btn,
      #questions-section .card-header-collapsible #import-questions-btn {
        margin-left: 5px;
        margin-right: auto;
      } /* RTL */

      #filter-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--card-border);
        padding-bottom: 15px;
        align-items: flex-end;
      }
      #filter-controls > div {
        flex-grow: 1;
      }
      .filter-group-topic-clear {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        flex-grow: 1;
      }
      .topic-select-wrapper {
        flex-grow: 1;
      }
      #filter-controls label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.9rem;
        font-weight: bold;
      }
      #filter-controls input[type="search"],
      #filter-controls select {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--input-border);
        background-color: var(--input-bg);
        color: var(--text-color);
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 0.95rem;
        margin: 0;
      }
      #filter-controls button#clear-filters-btn {
        padding: 8px 12px;
        white-space: nowrap;
        margin: 0;
        flex-shrink: 0;
      }
      #questions-list .question-item {
        border-bottom: 1px solid var(--card-border);
        padding: 15px 0;
      }
      #questions-list .question-item:last-child {
        border-bottom: none;
      }
      .question-summary {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
      }
      .question-text {
        flex-grow: 1;
        font-size: 1rem;
        margin: 0;
      }
      .question-actions button {
        font-size: 0.85rem;
        padding: 5px 10px;
        margin-right: 5px;
      } /* RTL */
      .question-actions {
        flex-shrink: 0;
      }
      .question-details {
        font-size: 0.8rem;
        color: var(--disabled-text);
        margin-top: 5px;
        display: block;
        direction: rtl;
        text-align: right;
      }
      body.dark-mode .question-details {
        color: var(--disabled-bg);
      }
      .topic-link,
      .tag-link {
        color: var(--link-color);
        cursor: pointer;
        text-decoration: none;
        margin: 0 2px;
        display: inline-block;
        padding: 1px 4px;
        border-radius: 4px;
        transition: background-color 0.2s, color 0.2s;
      }
      .topic-link:hover,
      .tag-link:hover {
        text-decoration: underline;
        background-color: var(--input-bg);
      }
      .creation-date {
        font-size: 0.75em;
        color: var(--disabled-text);
        margin-right: 5px;
        opacity: 0.8;
        display: inline-block;
        direction: ltr;
      }

      /* --- Modals (Question Form & Import) --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--modal-overlay-bg);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 15px;
        box-sizing: border-box;
      }
      .modal-container {
        background-color: var(--card-bg);
        padding: 25px;
        border-radius: 10px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
      }
      .modal-container h3 {
        margin-top: 0;
        margin-bottom: 20px;
        text-align: center;
      }
      .modal-close-btn {
        position: absolute;
        top: 10px;
        left: 15px;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-color);
        cursor: pointer;
        padding: 5px;
        line-height: 1;
        z-index: 1;
      }
      /* Question Form Specific */
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .form-group input[type="text"],
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--input-border);
        background-color: var(--input-bg);
        color: var(--text-color);
        border-radius: 5px;
        font-size: 1rem;
        box-sizing: border-box;
      }
      .form-group textarea {
        min-height: 80px;
        resize: vertical;
      }
      .answer-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      .answer-group input[type="text"] {
        flex-grow: 1;
      }
      .answer-group input[type="radio"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        margin-left: 5px;
        flex-shrink: 0;
      } /* RTL */
      .answer-group button {
        padding: 3px 8px !important;
        font-size: 1rem !important;
        line-height: 1;
        margin: 0 0 0 5px !important;
        flex-shrink: 0;
      } /* RTL */
      .form-actions {
        text-align: center;
        margin-top: 20px;
      }
      /* Import Modal Specific */
      #import-modal-container {
        max-width: 750px;
      }
      #bulk-import-area {
        width: 100%;
        min-height: 250px;
        resize: vertical;
        font-family: monospace;
        direction: rtl; /* Keep LTR for code-like input */
        text-align: right;
        padding: 10px;
        border: 1px solid var(--input-border);
        background-color: var(--input-bg);
        color: var(--text-color);
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 0.9rem;
        line-height: 1.4;
        white-space: pre;
      }
      #bulk-import-area::placeholder {
        white-space: pre-wrap;
        opacity: 0.6;
        font-family: "Noto Sans Hebrew", sans-serif;
        direction: rtl;
        text-align: right;
        font-size: 0.9rem;
        line-height: 1.5;
        color: var(--disabled-text);
      }
      body.dark-mode #bulk-import-area::placeholder {
        color: var(--disabled-text);
      }
      #import-feedback,
      #import-preview {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--card-border);
        max-height: 250px;
        overflow-y: auto;
      }
      #import-feedback h4,
      #import-preview h4 {
        margin: 0 0 10px 0;
        font-size: 1rem;
      }
      #import-error-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      #import-error-list li {
        background-color: var(--error-list-item-bg);
        color: var(--error-list-item-text);
        border: 1px solid var(--error-list-item-border);
        padding: 5px 8px;
        margin-bottom: 5px;
        border-radius: 4px;
        font-size: 0.9rem;
      }
      #import-preview .preview-item {
        background-color: var(--preview-item-bg);
        border: 1px solid var(--preview-item-border);
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 5px;
        font-size: 0.9rem;
      }
      #import-preview .preview-item p {
        margin: 0 0 5px 0;
      }
      #import-preview .preview-item strong {
        font-weight: bold;
      }
      #import-preview .preview-item .correct {
        color: var(--success-color);
        font-weight: bold;
      }
      #import-preview .preview-item .details {
        font-size: 0.8rem;
        color: var(--disabled-text);
      }
      .import-actions {
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 10px;
      }
      .import-actions .left-actions {
        display: flex;
        gap: 10px;
      }

      /* --- Loading / Messages --- */
      #loading,
      #access-denied,
      #general-error {
        text-align: center;
        padding: 30px;
        font-size: 1.1rem;
        display: none;
      }
      #loading p,
      #access-denied p,
      #general-error p {
        margin: 0;
      }
      #no-results-message {
        padding: 20px;
        text-align: center;
        color: var(--disabled-text);
        display: none;
      }
      body.dark-mode #no-results-message {
        color: var(--disabled-bg);
      }
      .error-text {
        color: var(--danger-color);
        font-weight: bold;
      }

      /* --- Pagination Controls --- */
      .pagination-controls {
        text-align: center;
        margin-top: 20px;
        display: none;
      }
      .pagination-controls span {
        margin: 0 15px;
        vertical-align: middle;
        direction: ltr;
      }
      .pagination-controls button {
        padding: 8px 15px;
      }
      #user-pagination-controls {
        margin-top: 15px;
      }

      /* --- Responsive --- */
      @media (max-width: 768px) {
        #user-list-container th.uid-header,
        .uid-cell {
          width: 120px;
          font-size: 0.75em;
        }
        #user-list-container th.actions-header,
        .actions-cell {
          width: auto;
          white-space: normal;
        }
        .actions-cell button {
          margin-bottom: 5px;
        }
        #user-filter-controls {
          flex-direction: column;
          align-items: stretch;
          gap: 10px;
        }
        #user-filter-controls button {
          align-self: center;
          width: 50%;
        }
      }
      @media (max-width: 700px) {
        #filter-controls > div {
          min-width: 100%;
        }
        .filter-group-topic-clear {
          width: 100%;
        }
        .dashboard-grid {
          grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
          gap: 15px;
        }
        .stat-item p {
          font-size: 1.6rem;
        }
        .stat-item h3 {
          font-size: 0.85rem;
        }
        #leaderboard-enhanced-display th,
        #leaderboard-enhanced-display td {
          padding: 8px 5px;
          font-size: 0.9rem;
        }
        #leaderboard-enhanced-display td.score-col,
        #leaderboard-enhanced-display td.correct-col {
          width: 70px;
        }
        #user-list-container th,
        #user-list-container td {
          padding: 8px 5px;
          font-size: 0.9rem;
        }
        .collapsible-section .card-header-collapsible h2 {
          font-size: 1.1rem;
        }
        #import-modal-container {
          max-width: 95%;
        }
      }
      @media (max-width: 600px) {
        h1 {
          font-size: 1.5rem;
        }
        header {
          justify-content: space-around;
        }
        .question-summary {
          flex-direction: column;
          align-items: stretch;
        }
        .question-actions {
          text-align: right;
          margin-top: 10px;
        }
        .modal-container {
          padding: 15px;
        }
        .modal-close-btn {
          top: 5px;
          left: 10px;
        }
        .answer-group label {
          display: none;
        }
        .collapsible-section .card-header-collapsible {
          padding: 10px 15px;
          gap: 10px;
        }
        .collapsible-section .toggle-icon {
          font-size: 1.4rem;
          margin-left: 5px;
          margin-right: 0;
        } /* RTL */
        .collapsible-content {
          padding: 10px 15px;
        }
        .btn-round {
          width: 30px;
          height: 30px;
        }
        .btn-icon svg {
          width: 14px;
          height: 14px;
        }
        .pagination-controls span {
          margin: 0 8px;
        }
        .pagination-controls button {
          padding: 6px 10px;
        }
        .actions-cell button {
          font-size: 0.8rem;
          padding: 3px 6px;
          margin-right: 3px;
          margin-bottom: 3px;
        } /* RTL */
        #user-list-container th.uid-header,
        .uid-cell {
          width: 90px;
          font-size: 0.7em;
        } /* Adjust width if needed */
        #user-list-container table {
          table-layout: auto;
        } /* Let table decide layout on small screens */
        #questions-section .card-header-collapsible #add-question-btn,
        #questions-section .card-header-collapsible #import-questions-btn {
          padding: 6px 10px;
          font-size: 0.9rem;
          margin-right: 5px;
          margin-left: 0;
        } /* RTL */
        #bulk-import-area {
          min-height: 150px;
          font-size: 0.8rem;
        }
        #bulk-import-area::placeholder {
          font-size: 0.8rem;
        }
        .import-actions {
          flex-direction: column;
        }
        .import-actions .left-actions {
          order: 1;
          justify-content: center;
        }
        #confirm-import-btn {
          order: 2;
          width: 100%;
        }
      }
      @media (max-width: 500px) {
        .dashboard-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        /* Keep UID visible based on earlier request, remove display:none */
        #user-list-container th.uid-header {
          /* display: none; */
        }
        .uid-cell {
          display: table-cell !important; /* Ensure it stays visible */
          width: auto; /* Allow flexible width */
          font-size: 0.75em; /* Keep smaller size */
          white-space: nowrap; /* Prevent wrapping */
          overflow: hidden;
          text-overflow: ellipsis;
        }
        #questions-section .card-header-collapsible {
          flex-wrap: wrap;
        }
        #questions-section .card-header-collapsible h2 {
          width: 100%;
          margin-bottom: 10px;
          order: 1;
        }
        #questions-section .card-header-collapsible .toggle-icon {
          order: 0;
        }
        #questions-section
          .card-header-collapsible
          > *:not(h2):not(.toggle-icon) {
          margin-right: 0;
          order: 2;
        }
        #questions-section .card-header-collapsible #add-question-btn,
        #questions-section .card-header-collapsible #import-questions-btn {
          margin-right: 5px;
        } /* RTL */
      }
    </style>
  </head>
  <body>
    <script>
      // Set theme ASAP
      const initialDarkMode = localStorage.getItem("darkMode") === "true";
      document.body.classList.toggle("dark-mode", initialDarkMode);
    </script>

    <div class="container">
      <header>
        <label class="switch">
          <input type="checkbox" id="theme-toggle" />
          <span class="slider">
            <img
              src="https://img.icons8.com/ios-glyphs/30/ffffff/sun.png"
              alt="שמש"
              class="theme-icon sun"
            />
            <img
              src="https://img.icons8.com/ios-glyphs/30/ffffff/moon-symbol.png"
              alt="ירח"
              class="theme-icon moon"
            />
          </span>
        </label>

        <h1>ניהול טריווBIO</h1>

        <div id="admin-user-info" style="display: none">
          <div id="admin-username-display">טוען...</div>
          <button id="logout-btn" class="btn-danger" style="display: none">
            התנתק
          </button>
        </div>
      </header>

      <main>
        <div id="auth-section" style="display: none">
          <p>יש להתחבר עם חשבון Google מורשה כדי לגשת לניהול.</p>
          <button id="login-btn" class="btn-primary">התחבר עם Google</button>
        </div>
        <div id="loading"><p>טוען...</p></div>
        <div id="access-denied"><p>🚫 אינך מורשה לגשת לעמוד זה.</p></div>
        <div id="general-error">
          <p>⚠️ שגיאה בטעינת הנתונים. בדוק את החיבור או נסה שוב מאוחר יותר.</p>
        </div>

        <div id="admin-content">
          <section id="dashboard-overview" class="card collapsible-section">
            <div
              class="card-header-collapsible"
              role="button"
              tabindex="0"
              aria-expanded="false"
              aria-controls="dashboard-content"
            >
              <span class="toggle-icon" aria-hidden="true">+</span>
              <h2>סקירה כללית <span id="dashboard-date"></span></h2>
              <div id="refresh-dashboard-container">
                <button
                  id="refresh-dashboard-btn"
                  class="btn-icon btn-round"
                  title="רענן נתונים"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    viewBox="0 0 16 16"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"
                    />
                    <path
                      d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"
                    />
                  </svg>
                </button>
              </div>
            </div>
            <div
              class="collapsible-content"
              id="dashboard-content"
              role="region"
              aria-labelledby="dashboard-header"
              aria-hidden="true"
            >
              <div class="dashboard-grid">
                <div class="stat-item">
                  <h3>
                    <span class="stat-icon" title='סה"כ שאלות'>📊</span> סה"כ
                    שאלות
                  </h3>
                  <p id="stat-total-questions">?</p>
                </div>
                <div class="stat-item">
                  <h3>
                    <span class="stat-icon" title="שחקנים רשומים">👥</span>
                    שחקנים רשומים
                  </h3>
                  <p id="stat-total-players">?</p>
                </div>
                <div class="stat-item">
                  <h3>
                    <span class="stat-icon" title="שחקנים פעילים היום">☀️</span>
                    שחקנים פעילים (היום)
                  </h3>
                  <p id="stat-active-players-today">?</p>
                </div>
                <div class="stat-item">
                  <h3>
                    <span class="stat-icon" title="משחקים ששוחקו היום">🎮</span>
                    משחקים ששוחקו (היום)
                  </h3>
                  <p id="stat-games-today">?</p>
                </div>
                <div class="stat-item">
                  <h3>
                    <span class="stat-icon" title="ממוצע ניקוד היום">🎯</span>
                    ממוצע ניקוד (היום)
                  </h3>
                  <p id="stat-avg-score-today">?</p>
                </div>
                <div class="stat-item">
                  <h3>
                    <span
                      class="stat-icon"
                      title="ממוצע תשובות נכונות למשחק (היום)"
                      >✅</span
                    >
                    ממוצע נכונות (היום)
                  </h3>
                  <p id="stat-avg-correct-today">?</p>
                </div>
                <div class="stat-item">
                  <h3>
                    <span class="stat-icon" title="שחקנים חדשים היום">✨</span>
                    שחקנים חדשים (היום)
                  </h3>
                  <p id="stat-new-players-today">?</p>
                </div>
              </div>
            </div>
          </section>

          <section
            id="leaderboard-enhanced-section"
            class="card collapsible-section"
          >
            <div
              class="card-header-collapsible"
              role="button"
              tabindex="0"
              aria-expanded="false"
              aria-controls="leaderboard-content"
            >
              <span class="toggle-icon" aria-hidden="true">+</span>
              <h2>
                לוח דירוג כללי <span class="leaderboard-note">(Top 10)</span>
              </h2>
            </div>
            <div
              class="collapsible-content"
              id="leaderboard-content"
              role="region"
              aria-labelledby="leaderboard-header"
              aria-hidden="true"
            >
              <div id="leaderboard-enhanced-display">
                <p>טוען דירוג...</p>
              </div>
            </div>
          </section>

          <section id="users-section" class="card collapsible-section">
            <div
              class="card-header-collapsible"
              id="users-section-toggle"
              role="button"
              tabindex="0"
              aria-expanded="false"
              aria-controls="users-section-content"
            >
              <span class="toggle-icon" aria-hidden="true">+</span>
              <h2>ניהול משתמשים</h2>
            </div>
            <div
              class="collapsible-content"
              id="users-section-content"
              role="region"
              aria-labelledby="users-section-toggle"
              aria-hidden="true"
            >
              <div id="user-filter-controls">
                <div style="flex-grow: 1">
                  <label for="user-search-input">חיפוש משתמש:</label>
                  <input
                    type="search"
                    id="user-search-input"
                    placeholder="חפש לפי שם, UID..."
                  />
                </div>
                <div style="flex-grow: 1">
                  <label for="user-role-filter">סנן לפי סטטוס:</label>
                  <select id="user-role-filter">
                    <option value="">הכל</option>
                    <option value="admin">אדמין</option>
                    <option value="verified">מאומת (Google)</option>
                  </select>
                </div>
                <button id="clear-user-filters-btn" class="btn-danger">
                  נקה סינונים
                </button>
              </div>
              <div id="user-list-container">
                <p>טוען רשימת משתמשים...</p>
              </div>
              <p id="no-users-message" style="display: none">
                לא נמצאו משתמשים רשומים.
              </p>
              <div
                id="user-pagination-controls"
                class="pagination-controls"
                style="display: none"
              >
                <button id="prev-user-page-btn" class="btn-primary">
                  « קודם
                </button>
                <span id="user-page-info"></span>
                <button id="next-user-page-btn" class="btn-primary">
                  הבא »
                </button>
              </div>
            </div>
          </section>

          <section id="questions-section" class="card collapsible-section">
            <div
              class="card-header-collapsible"
              role="button"
              tabindex="0"
              aria-expanded="false"
              aria-controls="questions-content"
            >
              <span class="toggle-icon" aria-hidden="true">+</span>
              <h2>ניהול שאלות</h2>
              <button id="import-questions-btn" class="btn-secondary">
                ייבוא שאלות...
              </button>
              <button id="add-question-btn" class="btn-success">
                הוסף שאלה +
              </button>
            </div>
            <div
              class="collapsible-content"
              id="questions-content"
              role="region"
              aria-labelledby="questions-header"
              aria-hidden="true"
            >
              <div id="filter-controls">
                <div>
                  <label for="search-input">חיפוש:</label>
                  <input
                    type="search"
                    id="search-input"
                    placeholder="חפש בשאלה, תשובות, נושא, תגיות..."
                  />
                </div>
                <div class="filter-group-topic-clear">
                  <div class="topic-select-wrapper">
                    <label for="topic-filter">סנן לפי נושא:</label>
                    <select id="topic-filter">
                      <option value="">כל הנושאים</option>
                      <option value="human-body">גוף האדם</option>
                      <option value="cell">התא</option>
                      <option value="ecology">אקולוגיה</option>
                    </select>
                  </div>
                  <button id="clear-filters-btn" class="btn-danger">
                    נקה סינונים
                  </button>
                </div>
              </div>

              <div id="questions-list"></div>
              <div id="pagination-controls" class="pagination-controls">
                <button id="prev-page-btn" class="btn-primary">« קודם</button>
                <span id="page-info"></span>
                <button id="next-page-btn" class="btn-primary">הבא »</button>
              </div>
              <p id="no-results-message" style="display: none">
                לא נמצאו שאלות התואמות את הסינון.
              </p>
            </div>
          </section>
        </div>
      </main>

      <div id="question-form-modal" class="modal-overlay">
        <div id="question-form-container" class="modal-container">
          <button id="close-modal-btn" class="modal-close-btn" title="סגור">
            ×
          </button>
          <form id="question-form">
            <h3 id="form-title">הוסף שאלה חדשה</h3>
            <input type="hidden" id="question-id" />
            <div class="form-group">
              <label for="question-text-input">טקסט השאלה:</label
              ><textarea id="question-text-input" required></textarea>
            </div>
            <div class="form-group">
              <label>תשובות (סמן את הנכונה):</label>
              <div id="answers-container"></div>
              <button
                type="button"
                id="add-answer-btn"
                class="btn-primary"
                style="margin-top: 10px"
              >
                הוסף תשובה +
              </button>
            </div>
            <div class="form-group">
              <label for="question-topic">נושא:</label
              ><select id="question-topic" required>
                <option value="" disabled selected>בחר נושא...</option>
                <option value="human-body">גוף האדם</option>
                <option value="cell">התא</option>
                <option value="ecology">אקולוגיה</option>
              </select>
            </div>
            <div class="form-group">
              <label for="question-tags">תגיות (מופרדות בפסיק):</label
              ><input
                type="text"
                id="question-tags"
                placeholder="לדוגמה: מערכת העיכול, אנזימים"
              />
            </div>
            <div class="form-actions">
              <button type="submit" id="save-question-btn" class="btn-primary">
                שמור שאלה</button
              ><button type="button" id="cancel-edit-btn" class="btn-secondary">
                ביטול
              </button>
            </div>
          </form>
        </div>
      </div>

      <div id="import-modal" class="modal-overlay">
        <div id="import-modal-container" class="modal-container">
          <button
            id="close-import-modal-btn"
            class="modal-close-btn"
            title="סגור"
          >
            ×
          </button>
          <h3>ייבוא שאלות מרובות</h3>
          <div class="form-group">
            <label for="bulk-import-area">הדבק שאלות כאן:</label>
            <textarea
              id="bulk-import-area"
              rows="15"
              placeholder="הכנס שאלה אחת או יותר לפי הפורמט הבא:
              שאלה 1
              תשובה א
              תשובה ב
              *תשובה ג (הכוכבית מסמנת תשובה נכונה)
              תשובה ד
              נושא (חייב להיות או התא, או גוף האדם או אקולוגיה)
              תגית א, תגית ב, תגית ג
              
              שאלה 2
              ..."
            ></textarea>
          </div>
          <div class="import-actions">
            <div class="left-actions">
              <button type="button" id="process-import-btn" class="btn-primary">
                1. עבד נתונים
              </button>
              <button type="button" id="clear-import-btn" class="btn-secondary">
                נקה
              </button>
            </div>
            <button
              type="button"
              id="confirm-import-btn"
              class="btn-success"
              style="display: none"
            >
              2. ייבא שאלות תקינות
            </button>
          </div>
          <div id="import-feedback"></div>
          <div id="import-preview"></div>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- Firebase Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyAGFC_TB8iEMvS2PyxeASj1HH4i66AW4UA", // Replace with your actual API key
          authDomain: "trivbio.firebaseapp.com",
          projectId: "trivbio",
          storageBucket: "trivbio.appspot.com", // Corrected bucket name if necessary
          messagingSenderId: "1097087574583",
          appId: "1:1097087574583:web:b36c0441537a1f596215b2",
          measurementId: "G-ZY245YB23E",
          databaseURL: "https://trivbio-default-rtdb.firebaseio.com/", // Often helpful to include
        };
        try {
          if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
          else firebase.app();
        } catch (e) {
          console.error("FATAL: Firebase init failed!", e);
          const li = document.getElementById("loading");
          if (li)
            li.innerHTML = '<p class="error-text">שגיאת Firebase קריטית!</p>';
          return;
        }
        const auth = firebase.auth();
        const database = firebase.database();
        console.log("Admin Firebase initialized");

        // --- DOM Elements ---
        const loginBtn = document.getElementById("login-btn");
        const logoutBtn = document.getElementById("logout-btn");
        const authSect = document.getElementById("auth-section");
        const adminCont = document.getElementById("admin-content");
        const loadInd = document.getElementById("loading");
        const accessDen = document.getElementById("access-denied");
        const genErr = document.getElementById("general-error");
        const themeTog = document.getElementById("theme-toggle");
        const adminContentContainer = document.getElementById("admin-content");
        // Dashboard
        const dashboardOverview = document.getElementById("dashboard-overview");
        const dashboardDate = document.getElementById("dashboard-date");
        const refreshDashboardBtn = document.getElementById(
          "refresh-dashboard-btn"
        );
        const statTotalQuestions = document.getElementById(
          "stat-total-questions"
        );
        const statTotalPlayers = document.getElementById("stat-total-players");
        const statActivePlayersToday = document.getElementById(
          "stat-active-players-today"
        );
        const statGamesToday = document.getElementById("stat-games-today");
        const statAvgScoreToday = document.getElementById(
          "stat-avg-score-today"
        );
        const statAvgCorrectToday = document.getElementById(
          "stat-avg-correct-today"
        );
        const statNewPlayersToday = document.getElementById(
          "stat-new-players-today"
        );
        // Leaderboard
        const leaderboardEnhancedDisplay = document.getElementById(
          "leaderboard-enhanced-display"
        );
        // Users
        const usersSection = document.getElementById("users-section");
        const userListContainer = document.getElementById(
          "user-list-container"
        );
        const noUsersMessage = document.getElementById("no-users-message");
        const userPagCont = document.getElementById("user-pagination-controls");
        const prevUserPBtn = document.getElementById("prev-user-page-btn");
        const nextUserPBtn = document.getElementById("next-user-page-btn");
        const userPageInf = document.getElementById("user-page-info");
        const userSearchInput = document.getElementById("user-search-input");
        const userRoleFilter = document.getElementById("user-role-filter");
        const clearUserFiltersBtn = document.getElementById(
          "clear-user-filters-btn"
        );
        // Questions
        const questionsSection = document.getElementById("questions-section");
        const qListDiv = document.getElementById("questions-list");
        const searchIn = document.getElementById("search-input"); // Question search
        const topicFil = document.getElementById("topic-filter"); // Question topic filter
        const clearFilBtn = document.getElementById("clear-filters-btn"); // Question filter clear
        const noResMsg = document.getElementById("no-results-message"); // Question no results
        const addQBtn = document.getElementById("add-question-btn");
        const pagCont = document.getElementById("pagination-controls"); // Question pagination
        const prevPBtn = document.getElementById("prev-page-btn");
        const nextPBtn = document.getElementById("next-page-btn");
        const pageInf = document.getElementById("page-info");
        // Question Form Modal
        const qFormModal = document.getElementById("question-form-modal");
        const qForm = document.getElementById("question-form");
        const closeModBtn = document.getElementById("close-modal-btn");
        const formTit = document.getElementById("form-title");
        const qIdIn = document.getElementById("question-id");
        const qTextIn = document.getElementById("question-text-input");
        const ansCont = document.getElementById("answers-container");
        const addAnsBtn = document.getElementById("add-answer-btn");
        const qTopicSel = document.getElementById("question-topic");
        const qTagsIn = document.getElementById("question-tags");
        const saveQBtn = document.getElementById("save-question-btn");
        const cancelEdBtn = document.getElementById("cancel-edit-btn");
        // Import Modal
        const importQuestionsBtn = document.getElementById(
          "import-questions-btn"
        );
        const importModal = document.getElementById("import-modal");
        const closeImportModalBtn = document.getElementById(
          "close-import-modal-btn"
        );
        const bulkImportArea = document.getElementById("bulk-import-area");
        const clearImportBtn = document.getElementById("clear-import-btn");
        const processImportBtn = document.getElementById("process-import-btn");
        const importFeedback = document.getElementById("import-feedback");
        const importPreview = document.getElementById("import-preview");
        const confirmImportBtn = document.getElementById("confirm-import-btn");

        const adminUserInfo = document.getElementById("admin-user-info"); // New
        const adminUsernameDisplay = document.getElementById(
          "admin-username-display"
        ); // New

        // --- Global State ---
        let currentAdminUid = null;
        let allQuestions = {}; // Holds all question data fetched
        let allUsers = {}; // Holds all user data fetched
        let adminUids = {}; // Holds UIDs of admins {uid: true}
        let questionsListener = null; // Firebase listener for questions
        let usersListener = null; // Potentially add a listener for users if real-time updates needed
        let filteredQuestionIds = []; // Array of question IDs matching current filters
        let currentQuestionPage = 1; // Current page for question pagination
        const questionsPerPage = 10; // Items per page for questions
        let allUserIds = []; // Array of all user IDs, sorted by join date
        let currentUserPage = 1; // Current page for user pagination
        const usersPerPage = 10; // Items per page for users
        let userSearchValue = ""; // Current user search term
        let userRoleFilterValue = ""; // Current user role filter
        const topicTranslations = {
          "human-body": "גוף האדם",
          cell: "התא",
          ecology: "אקולוגיה",
          unknown: "לא ידוע",
        };
        const hebrewTopicMap = {
          "גוף האדם": "human-body",
          התא: "cell",
          אקולוגיה: "ecology",
        };
        const knownHebrewTopics = Object.keys(hebrewTopicMap);
        const COLLAPSIBLE_STATE_KEY = "adminCollapsibleStates";
        let validQuestionsForImport = []; // Holds questions parsed from import modal

        // --- Helpers ---
        function showEl(el) {
          if (el) el.style.display = "block";
        }
        function showFlexEl(el) {
          if (el) {
            el.style.display = "flex";
            document.body.style.overflow = "hidden";
          }
        }
        function hideEl(el) {
          if (el) el.style.display = "none";
        }
        function debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        }
        function getTodayDateString() {
          return new Date().toISOString().split("T")[0];
        }
        function formatDate(timestamp) {
          if (!timestamp) return "-";
          try {
            const date = new Date(timestamp);
            // Format as YYYY-MM-DD HH:MM
            return (
              date.toLocaleDateString("sv-SE") +
              " " +
              date.toLocaleTimeString("sv-SE", {
                hour: "2-digit",
                minute: "2-digit",
              })
            );
          } catch (e) {
            return "-";
          }
        }

        // --- Theme & Auth ---
        function setTheme(isDarkMode) {
          document.body.classList.toggle("dark-mode", isDarkMode);
        }
        themeTog.checked = document.body.classList.contains("dark-mode");
        themeTog.addEventListener("change", () => {
          const isDarkMode = themeTog.checked;
          setTheme(isDarkMode);
          localStorage.setItem("darkMode", isDarkMode.toString());
          // Save theme preference for admin in DB (optional, requires appropriate rules)
          // if (currentAdminUid) database.ref(`players/${currentAdminUid}/adminDarkMode`).set(isDarkMode).catch(e => console.warn("Theme preference save error", e));
        });

        // --- Load Admin Theme Preference (Optional) ---
        // function loadThemePref(uid) { ... } // As before, if needed

        auth.onAuthStateChanged(async (user) => {
          // --- Reset UI State ---
          hideEl(loadInd);
          hideEl(accessDen);
          hideEl(genErr);
          hideEl(adminCont);
          hideEl(authSect);
          hideEl(logoutBtn);
          hideEl(adminUserInfo); // Hide new container too
          if (adminUsernameDisplay) adminUsernameDisplay.textContent = ""; // Clear username

          // --- Listener Cleanup ---
          if (questionsListener) {
            database.ref("questions").off("value", questionsListener);
            questionsListener = null;
          }
          if (usersListener) {
            database.ref("players").off("value", usersListener);
            usersListener = null;
          }

          // --- Reset Global State ---
          currentAdminUid = null;
          allQuestions = {};
          allUsers = {};
          adminUids = {};
          filteredQuestionIds = [];
          currentQuestionPage = 1;
          allUserIds = [];
          currentUserPage = 1;
          userSearchValue = "";
          userRoleFilterValue = "";
          validQuestionsForImport = [];

          // --- Reset UI Components ---
          resetFilters(false);
          resetUserFilters(false);
          resetDashboardStats();
          if (userListContainer) userListContainer.innerHTML = "";
          hideEl(noUsersMessage);
          hideEl(userPagCont);
          if (qListDiv) qListDiv.innerHTML = "";
          hideEl(noResMsg);
          hideEl(pagCont);
          closeAllCollapsibleSections();
          closeForm();
          closeImportModal();
          // --- End Reset ---

          if (user) {
            currentAdminUid = user.uid;
            console.log(
              "Auth: User:",
              user.uid,
              "Email:",
              user.email,
              "Anon:",
              user.isAnonymous
            );

            if (user.isAnonymous) {
              currentAdminUid = null; // Anonymous users cannot access admin
              showEl(authSect); // Show login prompt
            } else {
              showEl(loadInd); // Show loading while checking admin status
              try {
                const isAdmin = await checkAdmin(user.uid);
                hideEl(loadInd);

                if (isAdmin) {
                  showEl(adminCont); // Show main admin content
                  showEl(adminUserInfo); // Show the user info container
                  if (adminUsernameDisplay) {
                    adminUsernameDisplay.textContent = user.email || user.uid; // Display email or UID
                    adminUsernameDisplay.title = user.email || user.uid; // Add title for long emails
                  }
                  showEl(logoutBtn); // Show logout button inside the container
                  // loadThemePref(user.uid); // Optional
                  loadInitialData(); // Load dashboard, users, questions etc.
                  loadCollapsibleStates(); // Restore UI state
                } else {
                  showEl(accessDen); // Show access denied message
                  showEl(adminUserInfo); // Still show user info container
                  if (adminUsernameDisplay)
                    adminUsernameDisplay.textContent = user.email || user.uid; // Display email
                  showEl(logoutBtn); // Allow logout even if denied access
                }
              } catch (e) {
                console.error("Admin check or data load error:", e);
                hideEl(loadInd);
                if (genErr)
                  genErr.innerHTML = `<p class="error-text">⚠️ שגיאת אימות או טעינת נתונים.</p>`;
                showEl(genErr);
                // Optionally show user info and logout even on error
                showEl(adminUserInfo);
                if (adminUsernameDisplay)
                  adminUsernameDisplay.textContent = user.email || "שגיאה";
                showEl(logoutBtn);
              }
            }
          } else {
            // No user is signed in
            console.log("No user session.");
            hideEl(adminUserInfo); // Hide user info container
            showEl(authSect); // Show login prompt section
          }
        });
        async function checkAdmin(uid) {
          if (!uid) return false;
          const snapshot = await database.ref(`admins/${uid}`).once("value");
          return snapshot.exists() && snapshot.val() === true;
        }

        loginBtn.addEventListener("click", () => {
          const provider = new firebase.auth.GoogleAuthProvider();
          showEl(loadInd);
          hideEl(authSect);
          hideEl(genErr);
          auth.signInWithPopup(provider).catch((error) => {
            console.error("Login Error:", error);
            hideEl(loadInd);
            if (genErr) {
              if (error.code === "auth/popup-closed-by-user")
                genErr.innerHTML = `<p>חלון ההתחברות נסגר.</p>`;
              else if (error.code === "auth/network-request-failed")
                genErr.innerHTML = `<p class="error-text">⚠️ בעיית רשת. נסה שוב.</p>`;
              else
                genErr.innerHTML = `<p class="error-text">⚠️ כשל בתהליך ההתחברות.</p>`;
              showEl(genErr);
            }
            showEl(authSect);
          });
        });

        logoutBtn.addEventListener("click", () => {
          auth.signOut().catch((e) => console.error("Logout Error:", e));
        });

        // --- Data Loading ---
        function loadInitialData() {
          console.log("loadInitialData called");
          loadDashboardData();
          fetchAdminUids().then(() => {
            // Fetch admins first for filtering
            if (usersSection && usersSection.classList.contains("is-open")) {
              loadUsers(); // Load users if section is already open
            }
          });
          loadQuestions(); // Load questions listener
        }

        // --- Dashboard ---
        async function loadDashboardData() {
          console.log("loadDashboardData");
          if (!refreshDashboardBtn) return;
          resetDashboardStats();
          refreshDashboardBtn.disabled = true;
          refreshDashboardBtn.classList.add("refreshing");
          const todayStr = getTodayDateString();
          if (dashboardDate)
            dashboardDate.textContent = `(${todayStr
              .split("-")
              .reverse()
              .join("/")})`;

          const playersRef = database.ref("players");
          const questionsRef = database.ref("questions");
          const dailyResultsRef = database.ref(`gameResults/${todayStr}`);
          const leaderboardRef = database
            .ref("leaderboard")
            .orderByChild("cumulativeScore")
            .limitToLast(10);

          try {
            const [qSnap, pSnap, dSnap, lSnap] = await Promise.all([
              questionsRef.once("value"),
              playersRef.once("value"),
              dailyResultsRef.once("value"),
              leaderboardRef.once("value"),
            ]);

            // Total Questions
            statTotalQuestions.textContent = qSnap.exists()
              ? qSnap.numChildren()
              : "0";

            // Total Players & New Players Today
            let totalPlayersCount = 0;
            let newPlayersTodayCount = 0;
            if (pSnap.exists()) {
              totalPlayersCount = pSnap.numChildren();
              pSnap.forEach((playerSnap) => {
                // Check registrationDate if available, otherwise check createdAt
                const regDate = playerSnap.child("registrationDate").val();
                const createdAt = playerSnap.child("createdAt").val();
                const playerDate =
                  regDate ||
                  (createdAt
                    ? new Date(createdAt).toISOString().split("T")[0]
                    : null);
                if (playerDate === todayStr) {
                  newPlayersTodayCount++;
                }
              });
            }
            statTotalPlayers.textContent = totalPlayersCount;
            statNewPlayersToday.textContent = newPlayersTodayCount;

            // Daily Stats
            let gamesTodayCount = 0;
            let activePlayersTodayIds = new Set();
            let totalScoreToday = 0;
            let totalCorrectToday = 0;
            let totalQuestionsToday = 0; // Count questions in games played today

            if (dSnap.exists()) {
              gamesTodayCount = dSnap.numChildren();
              dSnap.forEach((gameSnap) => {
                const gameData = gameSnap.val();
                if (gameData?.playerId)
                  activePlayersTodayIds.add(gameData.playerId);
                if (typeof gameData?.score === "number")
                  totalScoreToday += gameData.score;
                if (typeof gameData?.correctCount === "number")
                  totalCorrectToday += gameData.correctCount;
                if (typeof gameData?.totalQuestions === "number")
                  totalQuestionsToday += gameData.totalQuestions;
              });
            }
            statGamesToday.textContent = gamesTodayCount;
            statActivePlayersToday.textContent = activePlayersTodayIds.size;
            statAvgScoreToday.textContent =
              gamesTodayCount > 0
                ? (totalScoreToday / gamesTodayCount).toFixed(1)
                : "0";
            // Avg Correct % Today = Total Correct Answers / Total Questions Answered in today's games
            statAvgCorrectToday.textContent =
              totalQuestionsToday > 0
                ? ((totalCorrectToday / totalQuestionsToday) * 100).toFixed(1) +
                  "%"
                : "0%";

            // Leaderboard
            if (lSnap.exists()) renderEnhancedLeaderboard(lSnap.val());
            else
              leaderboardEnhancedDisplay.innerHTML = "<p>אין נתוני דירוג.</p>";
          } catch (error) {
            console.error("Error loading dashboard data:", error);
            // Display error indicators
            [
              statTotalQuestions,
              statTotalPlayers,
              statActivePlayersToday,
              statGamesToday,
              statAvgScoreToday,
              statAvgCorrectToday,
              statNewPlayersToday,
            ].forEach((el) => {
              if (el) el.textContent = "ERR";
            });
            if (leaderboardEnhancedDisplay)
              leaderboardEnhancedDisplay.innerHTML =
                '<p class="error-text">שגיאה בטעינת דירוג.</p>';
          } finally {
            refreshDashboardBtn.disabled = false;
            refreshDashboardBtn.classList.remove("refreshing");
            console.log("Dashboard load complete.");
          }
        }

        function renderEnhancedLeaderboard(data) {
          /* As before */
          const arr = Object.entries(data).map(([playerId, playerData]) => ({
            playerId,
            nickname:
              playerData.nickname ||
              `שחקן...${playerId.substring(playerId.length - 4)}`,
            cumulativeScore: playerData.cumulativeScore || 0,
            // correctCount: playerData.correctCount // Add if needed/available
          }));
          arr.sort((a, b) => b.cumulativeScore - a.cumulativeScore); // Sort descending

          if (arr.length === 0) {
            leaderboardEnhancedDisplay.innerHTML = "<p>אין נתוני דירוג.</p>";
            return;
          }
          const table = document.createElement("table");
          const thead = table.createTHead();
          const tbody = table.createTBody();
          const headerRow = thead.insertRow();
          const columns = [
            { header: "#", className: "rank-col" },
            { header: "שם", className: "name-col" },
            { header: "ניקוד", className: "score-col" },
            // Add more columns if needed
          ];
          columns.forEach((col) => {
            const th = document.createElement("th");
            th.textContent = col.header;
            th.className = col.className || "";
            headerRow.appendChild(th);
          });
          arr.forEach((player, index) => {
            const rank = index + 1;
            const row = tbody.insertRow();
            row.insertCell().outerHTML = `<td class="rank-col">${rank}</td>`;
            row.insertCell().outerHTML = `<td class="name-col">${player.nickname}</td>`;
            row.insertCell().outerHTML = `<td class="score-col">${(
              player.cumulativeScore || 0
            ).toLocaleString()}</td>`;
            // Add more cells if needed
          });
          leaderboardEnhancedDisplay.innerHTML = "";
          leaderboardEnhancedDisplay.appendChild(table);
        }

        function resetDashboardStats() {
          /* As before */
          if (statTotalQuestions) statTotalQuestions.textContent = "?";
          if (statTotalPlayers) statTotalPlayers.textContent = "?";
          if (statActivePlayersToday) statActivePlayersToday.textContent = "?";
          if (statGamesToday) statGamesToday.textContent = "?";
          if (statAvgScoreToday) statAvgScoreToday.textContent = "?";
          if (statAvgCorrectToday) statAvgCorrectToday.textContent = "?";
          if (statNewPlayersToday) statNewPlayersToday.textContent = "?";
          if (leaderboardEnhancedDisplay)
            leaderboardEnhancedDisplay.innerHTML = "<p>טוען...</p>";
          if (dashboardDate) dashboardDate.textContent = "";
        }

        refreshDashboardBtn.addEventListener("click", loadDashboardData);

        // --- User Management (Sorted, Filtered, UID Visible/Truncated) ---
        async function fetchAdminUids() {
          try {
            const adminSnapshot = await database.ref("admins").once("value");
            adminUids = adminSnapshot.exists() ? adminSnapshot.val() : {};
            console.log("Admin UIDs fetched:", Object.keys(adminUids));
          } catch (e) {
            console.error("Error fetching admin UIDs:", e);
            adminUids = {}; // Reset on error
          }
        }

        async function loadUsers() {
          console.log("loadUsers");
          if (!userListContainer || !usersSection) return;
          if (usersSection.classList.contains("is-open") && userListContainer) {
            userListContainer.innerHTML = "<p>טוען משתמשים...</p>";
          }
          hideEl(noUsersMessage);
          hideEl(userPagCont);

          try {
            // Fetch users ordered by createdAt (oldest first)
            const snapshot = await database
              .ref("players")
              .orderByChild("createdAt")
              .once("value");
            if (snapshot.exists()) {
              allUsers = snapshot.val();
              // Reverse keys to get newest first for default display
              allUserIds = Object.keys(allUsers).reverse();
              console.log(
                `Loaded ${allUserIds.length} users, sorted newest first.`
              );
              currentUserPage = 1;
              if (usersSection.classList.contains("is-open")) {
                filterAndRenderUsers(); // Apply filters (if any) and render
              }
            } else {
              allUsers = {};
              allUserIds = [];
              if (usersSection.classList.contains("is-open")) {
                userListContainer.innerHTML = "";
                showEl(noUsersMessage);
              }
              hideEl(userPagCont);
              console.log("No users found.");
            }
          } catch (e) {
            console.error("Error loading users:", e);
            if (
              usersSection.classList.contains("is-open") &&
              userListContainer
            ) {
              userListContainer.innerHTML = `<p class="error-text">שגיאה בטעינת משתמשים.</p>`;
            }
            allUsers = {};
            allUserIds = [];
            hideEl(noUsersMessage);
            hideEl(userPagCont);
          }
        }

        function filterAndRenderUsers() {
          userSearchValue = userSearchInput
            ? userSearchInput.value.toLowerCase().trim()
            : "";
          userRoleFilterValue = userRoleFilter ? userRoleFilter.value : "";

          // Filter the globally sorted (newest first) list of all user IDs
          const filteredUserIds = allUserIds.filter((uid) => {
            const user = allUsers[uid];
            if (!user) return false;

            // Role Filter
            if (userRoleFilterValue) {
              const isAdmin = adminUids[uid] === true;
              if (userRoleFilterValue === "admin" && !isAdmin) return false;
              // Simple 'verified' = logged in with Google (implies not an admin in this logic)
              // This isn't strictly accurate as an admin IS verified via Google,
              // adjust if a different definition of 'verified' is needed.
              if (userRoleFilterValue === "verified" && isAdmin) return false;
              // Add more complex logic here if needed, e.g., checking if user.providerData exists
            }

            // Search Filter (Nickname or UID)
            if (userSearchValue) {
              const nicknameMatch =
                user.nickname &&
                user.nickname.toLowerCase().includes(userSearchValue);
              const uidMatch = uid.toLowerCase().includes(userSearchValue);
              if (!nicknameMatch && !uidMatch) {
                return false;
              }
            }
            return true; // Include user if all filters pass
          });
          renderUserList(filteredUserIds); // Pass the filtered list to render
        }

        function renderUserList(filteredIds) {
          if (!userListContainer) return;
          userListContainer.innerHTML = "";
          hideEl(noUsersMessage);
          hideEl(userPagCont);
          const totalFiltered = filteredIds.length;

          if (totalFiltered === 0) {
            if (userSearchValue || userRoleFilterValue) {
              userListContainer.innerHTML =
                "<p>לא נמצאו משתמשים התואמים לסינון.</p>";
            } else {
              showEl(noUsersMessage); // "לא נמצאו משתמשים רשומים."
            }
            return;
          }

          const totalPages = Math.ceil(totalFiltered / usersPerPage);
          if (currentUserPage < 1) currentUserPage = 1;
          if (currentUserPage > totalPages && totalPages > 0)
            currentUserPage = totalPages;
          const startIndex = (currentUserPage - 1) * usersPerPage;
          const endIndex = startIndex + usersPerPage;
          const idsToDisplay = filteredIds.slice(startIndex, endIndex);

          console.log(
            `Render users page ${currentUserPage}/${totalPages} (from ${totalFiltered} filtered)`
          );
          const table = document.createElement("table");
          const thead = table.createTHead();
          const tbody = table.createTBody();
          const headerRow = thead.insertRow();
          // Define headers
          const headers = [
            { text: "שם", className: "nickname-header" },
            { text: "מזהה (UID)", className: "uid-header" }, // Corrected header text
            { text: "פעולות", className: "actions-header" },
          ];
          headers.forEach((hd) => {
            const th = document.createElement("th");
            th.textContent = hd.text;
            th.className = hd.className || "";
            headerRow.appendChild(th);
          });

          // Create rows
          idsToDisplay.forEach((uid) => {
            const userData = allUsers[uid];
            if (userData) tbody.appendChild(renderUserRow(uid, userData));
          });

          userListContainer.appendChild(table);
          updateUserPaginationControls(totalPages, totalFiltered);
          // Re-attach listener after rebuilding table content
          userListContainer.removeEventListener("click", handleUserActions);
          userListContainer.addEventListener("click", handleUserActions);
        }

        function renderUserRow(uid, userData) {
          const row = document.createElement("tr");
          row.dataset.uid = uid;
          const nickname = userData.nickname || "";
          const originalNicknameDisplay = nickname || "[לא הוגדר]";

          // Nickname Cell
          const nicknameCell = row.insertCell();
          nicknameCell.className = "nickname-cell";
          nicknameCell.innerHTML = `
                    <span class="nickname-display">${originalNicknameDisplay}</span>
                    <input type="text" class="nickname-edit" value="${nickname}" aria-label="ערוך שם משתמש" />`;
          nicknameCell.querySelector(".nickname-edit").dataset.originalValue =
            nickname;

          // UID Cell (Truncated)
          const uidCell = row.insertCell();
          uidCell.className = "uid-cell";
          const shortUid =
            uid.length > 8
              ? `${uid.substring(0, 4)}...${uid.substring(uid.length - 4)}`
              : uid;
          uidCell.textContent = shortUid;
          uidCell.title = uid; // Full UID on hover

          // Actions Cell
          const actionsCell = row.insertCell();
          actionsCell.className = "actions-cell";
          actionsCell.innerHTML = `
                    <button class="btn-edit-user btn-primary" title="ערוך">ערוך</button>
                    <button class="btn-delete-user btn-danger" title="מחק">מחק</button>
                    <button class="btn-save-user btn-success" title="שמור" style="display: none;">שמור</button>
                    <button class="btn-cancel-edit-user btn-secondary" title="בטל" style="display: none;">בטל</button>`;
          return row;
        }

        function updateUserPaginationControls(totalPages, totalFiltered) {
          if (!userPagCont || !userPageInf || !prevUserPBtn || !nextUserPBtn)
            return;
          if (totalPages <= 1) {
            hideEl(userPagCont);
          } else {
            userPageInf.textContent = `עמוד ${currentUserPage}/${totalPages}`;
            prevUserPBtn.disabled = currentUserPage === 1;
            nextUserPBtn.disabled = currentUserPage === totalPages;
            showEl(userPagCont);
          }
        }

        // --- User Action Handling (Edit/Delete Nickname) ---
        function handleUserActions(event) {
          /* Mostly as before */
          const button = event.target.closest("button");
          if (!button) return;
          const row = button.closest("tr");
          if (!row?.dataset?.uid) return;

          const uid = row.dataset.uid;
          const nicknameCell = row.querySelector(".nickname-cell");
          const actionsCell = row.querySelector(".actions-cell");
          const nicknameInput = nicknameCell?.querySelector(".nickname-edit");
          const nicknameDisplay =
            nicknameCell?.querySelector(".nickname-display");
          const saveButton = actionsCell?.querySelector(".btn-save-user");
          const cancelButton = actionsCell?.querySelector(
            ".btn-cancel-edit-user"
          );
          const editButton = actionsCell?.querySelector(".btn-edit-user");
          const deleteButton = actionsCell?.querySelector(".btn-delete-user");

          if (
            !nicknameCell ||
            !actionsCell ||
            !nicknameInput ||
            !nicknameDisplay ||
            !saveButton ||
            !cancelButton ||
            !editButton ||
            !deleteButton
          ) {
            console.error("Missing elements in user row for actions.");
            return;
          }

          if (button.classList.contains("btn-edit-user")) {
            nicknameCell.classList.add("editing");
            actionsCell.classList.add("editing");
            editButton.style.display = "none";
            deleteButton.style.display = "none";
            saveButton.style.display = "inline-block";
            cancelButton.style.display = "inline-block";
            nicknameInput.dataset.originalValue = nicknameInput.value; // Store original value
            nicknameInput.focus();
            nicknameInput.select();
          } else if (button.classList.contains("btn-cancel-edit-user")) {
            nicknameInput.value = nicknameInput.dataset.originalValue; // Restore original value
            nicknameCell.classList.remove("editing");
            actionsCell.classList.remove("editing");
            editButton.style.display = "inline-block";
            deleteButton.style.display = "inline-block";
            saveButton.style.display = "none";
            cancelButton.style.display = "none";
          } else if (button.classList.contains("btn-save-user")) {
            const newNickname = nicknameInput.value.trim();
            const originalNickname = nicknameInput.dataset.originalValue;

            if (newNickname === originalNickname) {
              // No change, just exit edit mode
              nicknameCell.classList.remove("editing");
              actionsCell.classList.remove("editing");
              editButton.style.display = "inline-block";
              deleteButton.style.display = "inline-block";
              saveButton.style.display = "none";
              cancelButton.style.display = "none";
              return;
            }
            if (!newNickname) {
              alert("שם המשתמש אינו יכול להיות ריק.");
              nicknameInput.focus();
              return;
            }
            if (newNickname.length > 25) {
              alert("שם המשתמש ארוך מדי (מקסימום 25 תווים).");
              nicknameInput.focus();
              return;
            }

            setRowButtonsDisabled(row, true);
            updateUserNickname(uid, newNickname)
              .then(() => {
                console.log(`Nickname updated for ${uid}`);
                nicknameDisplay.textContent = newNickname;
                nicknameInput.value = newNickname;
                nicknameInput.dataset.originalValue = newNickname; // Update original value state
                if (allUsers[uid]) allUsers[uid].nickname = newNickname; // Update local cache

                nicknameCell.classList.remove("editing");
                actionsCell.classList.remove("editing");
                editButton.style.display = "inline-block";
                deleteButton.style.display = "inline-block";
                saveButton.style.display = "none";
                cancelButton.style.display = "none";

                // Check if sorting needs update (optional, might be complex)
                // For simplicity, we might skip re-sorting here or trigger a full refresh
                // filterAndRenderUsers(); // Re-filter and render to potentially re-sort
              })
              .catch((error) => {
                console.error(`Error updating nickname for ${uid}:`, error);
                alert(`שגיאה בעדכון שם המשתמש: ${error.message}`);
              })
              .finally(() => {
                setRowButtonsDisabled(row, false);
              });
          } else if (button.classList.contains("btn-delete-user")) {
            const displayName =
              (nicknameDisplay.textContent !== "[לא הוגדר]"
                ? nicknameDisplay.textContent
                : "") || `משתמש ${uid.substring(uid.length - 5)}`;
            if (
              confirm(
                `האם אתה בטוח שברצונך למחוק את המשתמש "${displayName}" (${uid})?\n⚠️ פעולה זו תמחק את כל נתוני המשתמש והיא אינה הפיכה!`
              )
            ) {
              setRowButtonsDisabled(row, true);
              deleteUser(uid)
                .then(() => {
                  console.log(`User ${uid} deleted.`);
                  delete allUsers[uid]; // Remove from local cache
                  allUserIds = allUserIds.filter((id) => id !== uid); // Remove from ID list

                  // Re-render the current page
                  filterAndRenderUsers();

                  // Update dashboard stats (optional, could be done on next refresh)
                  if (
                    statTotalPlayers &&
                    !isNaN(parseInt(statTotalPlayers.textContent))
                  ) {
                    statTotalPlayers.textContent = Math.max(
                      0,
                      parseInt(statTotalPlayers.textContent) - 1
                    );
                  }
                })
                .catch((error) => {
                  console.error(`Error deleting user ${uid}:`, error);
                  alert(`שגיאה במחיקת המשתמש: ${error.message}`);
                  setRowButtonsDisabled(row, false);
                });
            }
          }
        }

        async function updateUserNickname(uid, newNickname) {
          /* As before */
          if (!uid || typeof newNickname !== "string")
            return Promise.reject(
              new Error("Invalid input for nickname update")
            );
          if (newNickname.length > 25)
            return Promise.reject(new Error("Nickname too long"));
          console.log(`Updating nickname for ${uid} to "${newNickname}"`);
          // Update player node
          await database.ref(`players/${uid}/nickname`).set(newNickname);
          // Also update leaderboard node for consistency
          await database
            .ref(`leaderboard/${uid}/nickname`)
            .set(newNickname)
            .catch((e) =>
              console.warn("Leaderboard nickname update failed:", e)
            );
        }
        async function deleteUser(uid) {
          /* As before */
          if (!uid)
            return Promise.reject(new Error("Invalid UID for deletion"));
          console.log(`Deleting user ${uid}`);
          // Add deletion from leaderboard as well
          await database
            .ref(`leaderboard/${uid}`)
            .remove()
            .catch((e) => console.warn("Leaderboard deletion failed:", e));
          // Delete daily results? Might be complex, skip for now unless required.
          // await database.ref(`gameResults/${getTodayDateString()}/${uid}`).remove().catch(e => console.warn("Daily result deletion failed:", e));
          // Delete main player data
          return database.ref(`players/${uid}`).remove();
        }
        function setRowButtonsDisabled(row, disabled) {
          /* As before */
          row
            .querySelectorAll(".actions-cell button")
            .forEach((button) => (button.disabled = disabled));
        }

        // Attach User Filter Listeners
        if (userSearchInput)
          userSearchInput.addEventListener(
            "input",
            debounce(() => {
              currentUserPage = 1;
              filterAndRenderUsers();
            }, 350)
          );
        if (userRoleFilter)
          userRoleFilter.addEventListener("change", () => {
            currentUserPage = 1;
            filterAndRenderUsers();
          });
        if (clearUserFiltersBtn)
          clearUserFiltersBtn.addEventListener("click", () =>
            resetUserFilters(true)
          );

        function resetUserFilters(render = true) {
          if (userSearchInput) userSearchInput.value = "";
          if (userRoleFilter) userRoleFilter.value = "";
          userSearchValue = "";
          userRoleFilterValue = "";
          if (render && usersSection.classList.contains("is-open")) {
            currentUserPage = 1;
            filterAndRenderUsers();
          }
        }

        // --- Questions Management (Sorted by createdAt) ---
        function loadQuestions() {
          if (questionsListener)
            database.ref("questions").off("value", questionsListener);
          const contentArea = document.getElementById("questions-content");
          if (
            contentArea &&
            questionsSection.classList.contains("is-open") &&
            qListDiv
          ) {
            qListDiv.innerHTML = "<p>טוען שאלות...</p>";
          } else if (qListDiv) {
            qListDiv.innerHTML = ""; // Clear if not open
          }
          hideEl(noResMsg);
          hideEl(pagCont);

          // Fetch questions ordered by createdAt (oldest first from Firebase)
          const ref = database.ref("questions").orderByChild("createdAt");
          console.log("Attaching Question listener ordered by createdAt.");

          questionsListener = ref.on(
            "value",
            (snapshot) => {
              allQuestions = snapshot.exists() ? snapshot.val() : {};
              console.log(
                `Loaded ${Object.keys(allQuestions).length} questions.`
              );
              // Keys are now naturally ordered oldest to newest by Firebase
              // We will reverse them after filtering for display

              if (questionsSection.classList.contains("is-open")) {
                filterAndRenderQuestions(); // Apply filters and render
              }
            },
            (error) => {
              console.error("Firebase Error loading questions:", error);
              if (questionsSection.classList.contains("is-open") && qListDiv) {
                qListDiv.innerHTML = `<p class="error-text">שגיאה בטעינת שאלות.</p>`;
              }
              allQuestions = {};
              filteredQuestionIds = [];
              hideEl(noResMsg);
              hideEl(pagCont);
              if (questionsListener) ref.off("value", questionsListener);
              questionsListener = null;
            }
          );
        }

        const debouncedQuestionFilter = debounce(() => {
          currentQuestionPage = 1;
          filterAndRenderQuestions();
        }, 350);
        searchIn.addEventListener("input", debouncedQuestionFilter);
        topicFil.addEventListener("change", () => {
          currentQuestionPage = 1;
          filterAndRenderQuestions();
        });
        clearFilBtn.addEventListener("click", () => resetFilters(true));

        function filterAndRenderQuestions() {
          const searchTerm = searchIn.value.toLowerCase().trim();
          const selectedTopic = topicFil.value;

          // Get keys from the potentially ordered allQuestions object
          let keys = Object.keys(allQuestions);

          // Filter logic
          const filteredKeys = keys.filter((id) => {
            const qData = allQuestions[id];
            if (!qData?.question) return false;

            // Topic filter
            if (selectedTopic && qData.topic !== selectedTopic) {
              return false;
            }

            // Search term filter (in question, answers, tags, topic)
            if (searchTerm) {
              const questionText = qData.question.toLowerCase();
              const answersText = (qData.answers || [])
                .map((a) => String(a).toLowerCase())
                .join(" ");
              const tagsText = (qData.tags || []).map((t) =>
                String(t).trim().toLowerCase()
              );
              const topicText = qData.topic?.toLowerCase() || "";

              const found =
                questionText.includes(searchTerm) ||
                answersText.includes(searchTerm) ||
                topicText.includes(searchTerm) ||
                tagsText.some((tag) => tag.includes(searchTerm));
              if (!found) return false;
            }
            return true;
          });

          // Sort the FILTERED keys DESCENDING (newest first) based on the 'createdAt' field
          filteredQuestionIds = filteredKeys.sort((a, b) => {
            const timeA = allQuestions[a]?.createdAt || 0;
            const timeB = allQuestions[b]?.createdAt || 0;
            return timeB - timeA; // Sort descending (newest timestamp first)
          });

          renderQuestionPage();
        }

        function renderQuestionPage() {
          if (!qListDiv) return;
          const totalFiltered = filteredQuestionIds.length;
          const totalPages = Math.ceil(totalFiltered / questionsPerPage);

          if (currentQuestionPage < 1) currentQuestionPage = 1;
          if (currentQuestionPage > totalPages && totalPages > 0)
            currentQuestionPage = totalPages;

          const startIndex = (currentQuestionPage - 1) * questionsPerPage;
          const endIndex = startIndex + questionsPerPage;
          const idsToDisplay = filteredQuestionIds.slice(startIndex, endIndex);

          qListDiv.innerHTML = "";
          hideEl(noResMsg);

          if (totalFiltered === 0) {
            if (searchIn.value || topicFil.value)
              showEl(noResMsg); // "לא נמצאו שאלות..."
            else qListDiv.innerHTML = "<p>אין שאלות במערכת.</p>";
          } else {
            idsToDisplay.forEach((id) =>
              renderQuestionItem(id, allQuestions[id])
            );
          }
          updateQuestionPaginationControls(totalPages);
        }

        function renderQuestionItem(id, qData) {
          if (!qData?.question || !id) return;
          const itemDiv = document.createElement("div");
          itemDiv.className = "question-item";
          itemDiv.dataset.id = id;

          const summaryDiv = document.createElement("div");
          summaryDiv.className = "question-summary";

          const textP = document.createElement("p");
          textP.className = "question-text";
          textP.textContent = qData.question;

          const actionsDiv = document.createElement("div");
          actionsDiv.className = "question-actions";
          const editBtn = document.createElement("button");
          editBtn.textContent = "ערוך";
          editBtn.className = "btn-primary";
          editBtn.onclick = () => openEditForm(id, qData);
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "מחק";
          deleteBtn.className = "btn-danger";
          deleteBtn.onclick = () => deleteQuestion(id);
          actionsDiv.append(editBtn, deleteBtn);

          summaryDiv.append(textP, actionsDiv);
          itemDiv.append(summaryDiv);

          const detailsSpan = document.createElement("span");
          detailsSpan.className = "question-details";

          // Add Creation Date
          if (qData.createdAt) {
            const dateSpan = document.createElement("span");
            dateSpan.className = "creation-date";
            dateSpan.textContent = `(${formatDate(qData.createdAt)})`;
            dateSpan.title = new Date(qData.createdAt).toLocaleString();
            detailsSpan.appendChild(dateSpan);
          }

          // Topic Link
          const topicKey = qData.topic || "unknown";
          const topicHebrew = topicTranslations[topicKey] || topicKey;
          detailsSpan.appendChild(document.createTextNode(`נושא: `));
          const topicLink = document.createElement("a");
          topicLink.href = "#";
          topicLink.className = "topic-link";
          topicLink.textContent = topicHebrew;
          topicLink.dataset.topic = topicKey;
          topicLink.onclick = (e) => {
            e.preventDefault();
            filterByTopic(topicKey);
          };
          detailsSpan.appendChild(topicLink);

          // Tags Links
          if (Array.isArray(qData.tags) && qData.tags.length > 0) {
            const validTags = qData.tags
              .map((t) => (t ? String(t).trim() : null))
              .filter(Boolean);
            if (validTags.length > 0) {
              detailsSpan.appendChild(document.createTextNode(" | תגיות: "));
              validTags.forEach((tagText, index) => {
                const tagLink = document.createElement("a");
                tagLink.href = "#";
                tagLink.className = "tag-link";
                tagLink.textContent = tagText;
                tagLink.dataset.tag = tagText;
                tagLink.onclick = (e) => {
                  e.preventDefault();
                  filterByTag(tagText);
                };
                detailsSpan.appendChild(tagLink);
                if (index < validTags.length - 1)
                  detailsSpan.appendChild(document.createTextNode(", "));
              });
            }
          }
          itemDiv.appendChild(detailsSpan);
          qListDiv.appendChild(itemDiv);
        }

        function updateQuestionPaginationControls(totalPages) {
          if (totalPages <= 1) {
            hideEl(pagCont);
          } else {
            showEl(pagCont);
            pageInf.textContent = `עמוד ${currentQuestionPage}/${totalPages}`;
            prevPBtn.disabled = currentQuestionPage === 1;
            nextPBtn.disabled = currentQuestionPage === totalPages;
          }
        }

        function filterByTopic(topicKey) {
          topicFil.value = topicKey === "unknown" ? "" : topicKey;
          currentQuestionPage = 1;
          filterAndRenderQuestions();
        }
        function filterByTag(tag) {
          searchIn.value = tag.trim();
          currentQuestionPage = 1;
          filterAndRenderQuestions();
        }
        function resetFilters(render = true) {
          searchIn.value = "";
          topicFil.value = "";
          if (render && questionsSection.classList.contains("is-open")) {
            currentQuestionPage = 1;
            filterAndRenderQuestions();
          }
        }

        // --- Question CRUD (Add/Edit/Delete) ---
        addQBtn.addEventListener("click", openAddForm);
        closeModBtn.addEventListener("click", closeForm);
        cancelEdBtn.addEventListener("click", closeForm);
        addAnsBtn.addEventListener("click", () => addAnswerField());
        qForm.addEventListener("submit", handleFormSubmit);

        function openAddForm() {
          /* As before */
          qForm.reset();
          qIdIn.value = "";
          formTit.textContent = "הוסף שאלה חדשה";
          ansCont.innerHTML = "";
          addAnswerField();
          addAnswerField(); // Start with 2 answers
          qTopicSel.value = "";
          qTagsIn.value = "";
          saveQBtn.textContent = "שמור שאלה";
          cancelEdBtn.textContent = "ביטול";
          showFlexEl(qFormModal);
        }
        function openEditForm(id, qData) {
          /* As before */
          if (!qData) return;
          qForm.reset();
          formTit.textContent = "ערוך שאלה";
          qIdIn.value = id;
          qTextIn.value = qData.question || "";
          qTopicSel.value = qData.topic || "";
          qTagsIn.value = Array.isArray(qData.tags)
            ? qData.tags.join(", ")
            : "";
          ansCont.innerHTML = "";
          if (Array.isArray(qData.answers)) {
            qData.answers.forEach((text, index) =>
              addAnswerField(text, index === qData.correct)
            );
            while (ansCont.children.length < 2) addAnswerField(); // Ensure at least 2
          } else {
            addAnswerField();
            addAnswerField();
          } // Default if no answers array
          saveQBtn.textContent = "שמור שינויים";
          cancelEdBtn.textContent = "ביטול";
          showFlexEl(qFormModal);
        }
        function closeForm() {
          /* As before */
          hideEl(qFormModal);
          document.body.style.overflow = "";
        }
        function addAnswerField(text = "", isCorrect = false) {
          /* As before */
          const currentIndex = ansCont.children.length;
          const div = document.createElement("div");
          div.className = "answer-group";
          const radio = document.createElement("input");
          radio.type = "radio";
          radio.name = "correctAnswer";
          radio.value = currentIndex;
          radio.checked = isCorrect;
          radio.required = true;
          radio.title = `סמן כתשובה נכונה ${currentIndex + 1}`;
          const input = document.createElement("input");
          input.type = "text";
          input.placeholder = `תשובה ${currentIndex + 1}`;
          input.value = text;
          input.required = true;
          input.setAttribute("aria-label", `תשובה ${currentIndex + 1}`);
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.textContent = "×";
          removeBtn.className = "btn-danger";
          removeBtn.title = "הסר תשובה";
          removeBtn.onclick = () => {
            if (ansCont.children.length > 2) div.remove();
            else alert("חובה לפחות 2 תשובות.");
            updateAnswerIndices(); // Renumber remaining answers
          };
          div.append(radio, input, removeBtn);
          ansCont.appendChild(div);
        }
        function updateAnswerIndices() {
          /* As before */
          ansCont.querySelectorAll(".answer-group").forEach((group, index) => {
            const radio = group.querySelector('input[type="radio"]');
            if (radio) radio.value = index;
            const input = group.querySelector('input[type="text"]');
            if (input) input.placeholder = `תשובה ${index + 1}`;
          });
        }

        async function handleFormSubmit(event) {
          event.preventDefault();
          saveQBtn.disabled = true;
          saveQBtn.textContent = "שומר...";

          const questionId = qIdIn.value;
          const questionText = qTextIn.value.trim();
          const topicValue = qTopicSel.value;
          const tagsValue = qTagsIn.value
            .split(",")
            .map((t) => t.trim())
            .filter(Boolean);
          const answerInputs = ansCont.querySelectorAll(
            '.answer-group input[type="text"]'
          );
          const correctAnswerRadio = ansCont.querySelector(
            'input[type="radio"]:checked'
          );

          function cleanup() {
            saveQBtn.disabled = false;
            saveQBtn.textContent = questionId ? "שמור שינויים" : "שמור שאלה";
          }

          if (!questionText) {
            alert("טקסט השאלה הוא שדה חובה.");
            return cleanup();
          }
          if (!topicValue) {
            alert("יש לבחור נושא לשאלה.");
            return cleanup();
          }
          if (!correctAnswerRadio) {
            alert("חובה לסמן תשובה נכונה.");
            return cleanup();
          }

          const correctIndex = parseInt(correctAnswerRadio.value, 10);
          const answers = [];
          let invalidAnswer = false;
          answerInputs.forEach((input) => {
            const value = input.value.trim();
            if (!value) invalidAnswer = true;
            answers.push(value);
          });

          if (invalidAnswer) {
            alert("כל שדות התשובה חייבים להכיל טקסט.");
            return cleanup();
          }
          if (answers.length < 2) {
            alert("חובה לפחות 2 תשובות.");
            return cleanup();
          }
          if (
            isNaN(correctIndex) ||
            correctIndex < 0 ||
            correctIndex >= answers.length
          ) {
            alert("הבחירה בתשובה נכונה אינה תקינה.");
            return cleanup();
          }

          // Prepare question data object
          const questionData = {
            question: questionText,
            answers: answers,
            correct: correctIndex,
            topic: topicValue,
            tags: tagsValue.length > 0 ? tagsValue : null, // Store null if no tags
          };

          try {
            let saveOperation;
            if (questionId) {
              // Editing existing question - Don't update createdAt
              saveOperation = database
                .ref(`questions/${questionId}`)
                .update(questionData);
            } else {
              // Adding new question - Add createdAt
              questionData.createdAt = firebase.database.ServerValue.TIMESTAMP;
              saveOperation = database.ref("questions").push(questionData);
            }
            await saveOperation;
            console.log("Question saved successfully!");
            closeForm();
            // Optionally, you might want to refresh the question list here
            // filterAndRenderQuestions(); // Or wait for the listener to update
          } catch (error) {
            console.error("Error saving question:", error);
            alert(`שגיאה בשמירת השאלה: ${error.message}`);
          } finally {
            cleanup();
          }
        }

        async function deleteQuestion(id) {
          /* As before */
          if (!id) return;
          const qText =
            allQuestions[id]?.question || `שאלה ${id.substring(id.length - 5)}`;
          if (
            !confirm(
              `האם אתה בטוח שברצונך למחוק את השאלה:\n"${qText}" (${id})?`
            )
          )
            return;
          console.log("Deleting Question:", id);
          try {
            await database.ref(`questions/${id}`).remove();
            console.log("Question Deleted:", id);
            // List will update via listener
          } catch (error) {
            console.error("Delete Question Error:", error);
            alert(`שגיאה במחיקת השאלה: ${error.message}`);
          }
        }

        // --- Pagination Listeners ---
        prevPBtn.addEventListener("click", () => {
          if (currentQuestionPage > 1) {
            currentQuestionPage--;
            renderQuestionPage();
            qListDiv.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });
        nextPBtn.addEventListener("click", () => {
          const totalPages = Math.ceil(
            filteredQuestionIds.length / questionsPerPage
          );
          if (currentQuestionPage < totalPages) {
            currentQuestionPage++;
            renderQuestionPage();
            qListDiv.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });
        prevUserPBtn.addEventListener("click", () => {
          if (currentUserPage > 1) {
            currentUserPage--;
            filterAndRenderUsers();
            userListContainer.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }
        });
        nextUserPBtn.addEventListener("click", () => {
          const totalFilteredUsers = allUserIds.filter((uid) => {
            /* Apply filters again - maybe optimize this */ const u =
              allUsers[uid];
            if (!u) return false;
            if (userRoleFilterValue) {
              const iA = adminUids[uid] === true;
              if (userRoleFilterValue === "admin" && !iA) return false;
              if (userRoleFilterValue === "verified" && iA) return false;
            }
            if (userSearchValue) {
              const nM =
                u.nickname &&
                u.nickname.toLowerCase().includes(userSearchValue);
              const uM = uid.toLowerCase().includes(userSearchValue);
              if (!nM && !uM) return false;
            }
            return true;
          }).length;
          const totalPages = Math.ceil(totalFilteredUsers / usersPerPage);
          if (currentUserPage < totalPages) {
            currentUserPage++;
            filterAndRenderUsers();
            userListContainer.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }
        });

        // --- Import Modal Logic ---
        importQuestionsBtn.addEventListener("click", openImportModal);
        closeImportModalBtn.addEventListener("click", closeImportModal);
        clearImportBtn.addEventListener("click", () => {
          bulkImportArea.value = "";
          importFeedback.innerHTML = "";
          importPreview.innerHTML = "";
          hideEl(confirmImportBtn);
          validQuestionsForImport = [];
        });
        processImportBtn.addEventListener("click", processImportData);
        confirmImportBtn.addEventListener("click", importValidQuestions);

        function openImportModal() {
          /* As before */
          bulkImportArea.value = "";
          importFeedback.innerHTML = "";
          importPreview.innerHTML = "";
          hideEl(confirmImportBtn);
          validQuestionsForImport = [];
          showFlexEl(importModal);
        }
        function closeImportModal() {
          /* As before */
          hideEl(importModal);
          document.body.style.overflow = "";
        }
        function processImportData() {
          /* As before */
          const text = bulkImportArea.value;
          importFeedback.innerHTML = "<p>מעבד נתונים...</p>";
          importPreview.innerHTML = "";
          hideEl(confirmImportBtn);
          validQuestionsForImport = [];

          setTimeout(() => {
            // Allow UI update
            const { validQuestions, errors } = parseBulkQuestions(text);
            validQuestionsForImport = validQuestions;

            // Display Errors
            if (errors.length > 0) {
              importFeedback.innerHTML = `<h4>שגיאות (${
                errors.length
              }):</h4><ul id="import-error-list">${errors
                .map((err) => `<li>${err}</li>`)
                .join("")}</ul>`;
            } else {
              importFeedback.innerHTML =
                '<p style="color: var(--success-color);">✅ לא נמצאו שגיאות בפורמט.</p>';
            }

            // Display Preview
            if (validQuestions.length > 0) {
              importPreview.innerHTML = `<h4>תצוגה מקדימה (${validQuestions.length} שאלות תקינות):</h4>`;
              validQuestions.forEach((q, index) => {
                const item = document.createElement("div");
                item.className = "preview-item";
                let ansHtml = q.answers
                  .map((ans, idx) =>
                    idx === q.correct
                      ? `<li class="correct"><strong>* ${ans}</strong></li>`
                      : `<li>${ans}</li>`
                  )
                  .join("");
                item.innerHTML = `<p><strong>שאלה ${index + 1}:</strong> ${
                  q.question
                }</p><ul>${ansHtml}</ul><p class="details"><strong>נושא:</strong> ${
                  topicTranslations[q.topic] || q.topic
                } | <strong>תגיות:</strong> ${
                  q.tags ? q.tags.join(", ") : "<em>אין</em>"
                }</p>`;
                importPreview.appendChild(item);
              });
              showEl(confirmImportBtn);
            } else {
              importPreview.innerHTML = "";
              hideEl(confirmImportBtn);
              if (errors.length === 0 && text.trim().length > 0)
                importFeedback.innerHTML =
                  "<p>לא נמצאו שאלות תקינות לייבוא בקלט שהוזן.</p>";
              else if (errors.length === 0 && text.trim().length === 0)
                importFeedback.innerHTML = "<p>תיבת הטקסט ריקה.</p>";
            }
          }, 10);
        }
        function parseBulkQuestions(text) {
          /* As before */
          const blocks = text.trim().split(/\n\s*\n+/); // Split by one or more empty lines
          const validQuestions = [];
          const errors = [];

          blocks.forEach((block, blockIndex) => {
            const lines = block
              .trim()
              .split("\n")
              .map((line) => line.trim())
              .filter((line) => line.length > 0);
            const blockRef = `בלוק #${blockIndex + 1}`;
            if (lines.length < 4) {
              errors.push(
                `${blockRef}: לא מספיק שורות (בדיוק 7: שאלה, 4 תשובות, נושא, תגיות).`
              );
              return;
            }
            const question = lines[0];
            let topic = "";
            let topicKey = "";
            let tags = [];
            let answers = [];
            let correctIndex = -1;
            const topicLineIndex =
              lines.length -
              (lines.length > 4 && lines[lines.length - 1].includes(",")
                ? 2
                : 1); // Try to detect if last line is tags
            const potentialTopicLine = lines[topicLineIndex];
            if (hebrewTopicMap[potentialTopicLine]) {
              topic = potentialTopicLine;
              topicKey = hebrewTopicMap[topic];
            } else {
              errors.push(
                `${blockRef}: נושא לא זוהה או לא תקין בשורה ${
                  topicLineIndex + 1
                } ('${potentialTopicLine}'). הנושאים המותרים: ${knownHebrewTopics.join(
                  ", "
                )}.`
              );
              return;
            }
            const tagsLineIndex = lines.length - 1;
            if (tagsLineIndex > topicLineIndex) {
              tags = lines[tagsLineIndex]
                .split(",")
                .map((t) => t.trim())
                .filter(Boolean);
            } else {
              tags = [];
            }
            const answerEndIndex = topicLineIndex;
            let correctFound = false;
            for (let i = 1; i < answerEndIndex; i++) {
              let answerText = lines[i];
              if (answerText.startsWith("*")) {
                if (correctFound) {
                  errors.push(`${blockRef}: נמצאה יותר מתשובה אחת מסומנת ב-*.`);
                  return;
                }
                correctFound = true;
                correctIndex = answers.length;
                answerText = answerText.substring(1).trim();
              }
              if (!answerText && answerText !== "") {
                errors.push(
                  `${blockRef}: שורת תשובה ${answers.length + 1} ריקה.`
                );
                return;
              }
              answers.push(answerText);
            }
            if (answers.length < 2) {
              errors.push(`${blockRef}: נדרשות לפחות 2 תשובות.`);
              return;
            }
            if (!correctFound) {
              errors.push(`${blockRef}: אף תשובה לא סומנה כנכונה (*).`);
              return;
            }
            validQuestions.push({
              question: question,
              answers: answers,
              correct: correctIndex,
              topic: topicKey,
              tags: tags.length > 0 ? tags : null,
            });
          });
          return { validQuestions, errors };
        }

        async function importValidQuestions() {
          if (validQuestionsForImport.length === 0) {
            alert("אין שאלות תקינות לייבוא.");
            return;
          }
          confirmImportBtn.disabled = true;
          confirmImportBtn.textContent = "מייבא...";
          importFeedback.innerHTML += "<p>מתחיל בייבוא...</p>";

          const importPromises = validQuestionsForImport.map((qData) => {
            // Add createdAt timestamp to each question object before pushing
            const dataToPush = {
              ...qData,
              createdAt: firebase.database.ServerValue.TIMESTAMP,
            };
            return database.ref("questions").push(dataToPush);
          });

          try {
            const results = await Promise.allSettled(importPromises);
            const successCount = results.filter(
              (r) => r.status === "fulfilled"
            ).length;
            const failureCount = results.length - successCount;
            let finalMsg = `<p style="color: var(--success-color);"><strong>ייבוא הושלם!</strong> ${successCount} שאלות נוספו.`;
            if (failureCount > 0) {
              finalMsg += ` <span style="color: var(--danger-color);">${failureCount} נכשלו (בדוק קונסול).</span>`;
              results.forEach((r, idx) => {
                if (r.status === "rejected")
                  console.error(
                    `Import Error Q${idx + 1}:`,
                    validQuestionsForImport[idx].question,
                    r.reason
                  );
              });
            }
            finalMsg += "</p>";
            importFeedback.innerHTML += finalMsg;
            validQuestionsForImport = [];
            hideEl(confirmImportBtn); // Keep preview for review? hideEl(importPreview);
          } catch (error) {
            console.error("Bulk import general error:", error);
            importFeedback.innerHTML += `<p class="error-text">שגיאה כללית בייבוא.</p>`;
          } finally {
            confirmImportBtn.disabled = false;
            confirmImportBtn.textContent = "2. ייבא שאלות תקינות";
          }
        }

        // --- Collapsible Section Logic ---
        function saveCollapsibleStates() {
          /* As before */
          const states = {};
          document
            .querySelectorAll(".collapsible-section")
            .forEach((section) => {
              states[section.id] = section.classList.contains("is-open");
            });
          try {
            localStorage.setItem(COLLAPSIBLE_STATE_KEY, JSON.stringify(states));
          } catch (e) {
            console.error("Error saving collapsible states:", e);
          }
        }
        function loadCollapsibleStates() {
          /* As before */
          let savedStates;
          try {
            savedStates = JSON.parse(
              localStorage.getItem(COLLAPSIBLE_STATE_KEY) || "{}"
            );
          } catch (e) {
            console.error("Error parsing collapsible states:", e);
            savedStates = {};
          }
          document
            .querySelectorAll(".collapsible-section")
            .forEach((section) => {
              const sectionId = section.id;
              const shouldBeOpen = savedStates[sectionId] === true;
              setCollapsibleState(section, shouldBeOpen, false); // Set state without saving again
              // Trigger data load if section is opened and data isn't loaded
              if (shouldBeOpen) {
                if (sectionId === "users-section" && allUserIds.length === 0) {
                  loadUsers();
                } else if (
                  sectionId === "questions-section" &&
                  Object.keys(allQuestions).length === 0 &&
                  filteredQuestionIds.length === 0
                ) {
                  /* loadQuestions is called initially */
                } else if (
                  sectionId === "questions-section" &&
                  Object.keys(allQuestions).length > 0 &&
                  filteredQuestionIds.length === 0 &&
                  qListDiv &&
                  qListDiv.innerHTML.includes("טוען")
                ) {
                  filterAndRenderQuestions();
                } // Render if loaded but not shown
              }
            });
          console.log("Loaded collapse states:", savedStates);
        }
        function setCollapsibleState(section, isOpen, saveState = true) {
          /* As before */
          if (!section) return;
          const header = section.querySelector(".card-header-collapsible");
          const content = section.querySelector(".collapsible-content");
          const icon = header?.querySelector(".toggle-icon");
          if (!header || !content || !icon) return;
          section.classList.toggle("is-open", isOpen);
          header.setAttribute("aria-expanded", isOpen.toString());
          content.setAttribute("aria-hidden", (!isOpen).toString());
          icon.textContent = isOpen ? "−" : "+";
          if (saveState) saveCollapsibleStates();
        }
        function closeAllCollapsibleSections() {
          /* As before */
          document
            .querySelectorAll(".collapsible-section")
            .forEach((section) => setCollapsibleState(section, false, false));
          saveCollapsibleStates(); // Save the closed state
        }
        if (adminContentContainer) {
          /* Event listener as before */
          adminContentContainer.addEventListener("click", (event) => {
            const header = event.target.closest(".card-header-collapsible");
            if (!header) return;
            // Prevent toggle if a button inside the header was clicked
            if (event.target.closest("button")) {
              console.log("Button click in header, ignoring toggle.");
              return;
            }

            const section = header.closest(".collapsible-section");
            if (!section) return;

            const shouldBeOpen = !section.classList.contains("is-open");
            setCollapsibleState(section, shouldBeOpen, true); // Set new state and save

            // Load data if opening and not already loaded/loading
            if (shouldBeOpen) {
              if (
                section.id === "users-section" &&
                allUserIds.length === 0 &&
                !section.dataset.loading
              ) {
                console.log("Users section opened, loading data...");
                section.dataset.loading = "true";
                loadUsers().finally(() => {
                  delete section.dataset.loading;
                });
              } else if (
                section.id === "questions-section" &&
                qListDiv &&
                qListDiv.children.length === 0 &&
                filteredQuestionIds.length === 0 &&
                Object.keys(allQuestions).length > 0
              ) {
                // If questions loaded but not rendered (e.g., opened for the first time after initial load)
                console.log("Questions section opened, rendering data...");
                filterAndRenderQuestions();
              }
              // Add other lazy-loading logic here if needed
            }
          });
        } else
          console.error("Admin container not found for collapsible listener.");

        console.log("DOM Content Loaded and script initialized.");
      }); // --- END OF DOMContentLoaded ---
    </script>
  </body>
</html>
