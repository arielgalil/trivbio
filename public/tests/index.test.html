<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>טריווBIO - משחק טריוויה בביולוגיה</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* --- General Styles --- */
      :root {
        --bg-color: #f5f7fa;
        --text-color: #2d3748;
        --card-bg: #ffffff;
        --card-border: #e2e8f0;
        --button-bg: #a3bffa;
        --button-hover-bg: #7f9cf5;
        --button-text: white;
        --input-bg: #e2e8f0;
        --input-border: #cbd5e0;
        --accent-color: #7f9cf5;
        --success-color: #48bb78;
        --danger-color: #f56565;
        --link-color: #5a67d8;
        --disabled-bg: #cbd5e0;
        --disabled-text: #a0aec0;
        --toast-light-bg: #2d3748;
        --toast-light-text: white;
        --toast-dark-bg: #e2e8f0;
        --toast-dark-text: #2d3748;
        --lifeline-counter-bg: #5a67d8;
        --lifeline-counter-text: white;
        --profile-icon-bg: #cbd5e0;
        --profile-icon-color: #4a5568;
        --profile-popup-bg: var(--card-bg);
        --profile-popup-border: var(--card-border);
        --profile-popup-shadow: rgba(0, 0, 0, 0.15);
        --profile-button-hover-bg: var(--input-bg);
      }

      body.dark-mode {
        --bg-color: #1a202c;
        --text-color: #e2e8f0;
        --card-bg: #2d3748;
        --card-border: #4a5568;
        --button-bg: #4a5568;
        --button-hover-bg: #2d3748;
        --button-text: #e2e8f0;
        --input-bg: #4a5568;
        --input-border: #718096;
        --accent-color: #63b3ed;
        --success-color: #68d391;
        --danger-color: #fc8181;
        --link-color: #63b3ed;
        --disabled-bg: #4a5568;
        --disabled-text: #718096;
        --toast-light-bg: #e2e8f0;
        --toast-light-text: #2d3748;
        --toast-dark-bg: #2d3748;
        --toast-dark-text: white;
        --lifeline-counter-bg: #4299e1;
        --lifeline-counter-text: #1a202c;
        --profile-icon-bg: #4a5568;
        --profile-icon-color: #e2e8f0;
        --profile-popup-shadow: rgba(0, 0, 0, 0.3);
        --profile-button-hover-bg: #4a5568;
      }

      html {
          height: 100%; /* Ensure html takes full height */
      }

      body {
        font-family: "Noto Sans Hebrew", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 0;
        transition: background-color 0.3s, color 0.3s;
        display: grid;
        grid-template-rows: auto 1fr auto; /* Header, Main Content (stretches), Footer */
        min-height: 100vh; /* Use min-height for viewport height */
        position: relative;
      }

      .container {
        max-width: 800px;
        margin: 10px auto;
        padding: 10px;
        text-align: center;
        width: 100%;
        box-sizing: border-box;
        grid-row: 2 / 3; /* Ensure main content is in the middle row */
        display: flex; /* Use flex to allow main to grow */
        flex-direction: column;
      }
      main {
          flex-grow: 1; /* Allow main to take available space */
      }

      header {
        display: flex;
        justify-content: center; /* Center title */
        align-items: center;
        position: relative;
        margin-bottom: 5px;
        padding: 10px 15px; /* Add padding for absolute elements */
        grid-row: 1 / 2; /* Header in the first row */
        width: 100%;
        box-sizing: border-box;
        flex-shrink: 0; /* Prevent header from shrinking */
      }
      h1 {
        font-size: 2rem;
        margin: 0;
      }
      .switch {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        display: inline-block;
        width: 60px;
        height: 34px;
      }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 34px; display: flex; align-items: center; justify-content: space-between; padding: 0 5px; }
      .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: 0.4s; border-radius: 50%; }
      input:checked + .slider { background-color: var(--accent-color); }
      input:checked + .slider:before { transform: translateX(26px); }
      .theme-icon { width: 20px; height: 20px; transition: opacity 0.4s; }
      .sun { opacity: 1; } .moon { opacity: 0; }
      input:checked + .slider .sun { opacity: 0; } input:checked + .slider .moon { opacity: 1; }

      /* --- Profile Container --- */
      #profile-container {
          position: absolute;
          left: 15px;
          top: 50%;
          transform: translateY(-50%);
          display: flex;
          align-items: center;
          gap: 10px; /* Space between icon and text */
          cursor: pointer;
          padding: 5px;
          border-radius: 8px;
          transition: background-color 0.2s;
      }
      #profile-container:hover {
          background-color: rgba(0,0,0,0.05);
      }
      body.dark-mode #profile-container:hover {
          background-color: rgba(255,255,255,0.08);
      }
      #profile-icon {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background-color: var(--profile-icon-bg);
          color: var(--profile-icon-color);
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden; /* In case we add img later */
      }
      #profile-icon svg {
          width: 24px;
          height: 24px;
      }
      #profile-info {
          text-align: right;
          line-height: 1.2;
      }
      #nickname-display {
        font-size: 0.9rem;
        font-weight: bold;
        color: var(--text-color);
        cursor: pointer;
        transition: color 0.3s;
      }
      #cumulative-score-display {
        font-size: 0.8rem;
        color: var(--disabled-text);
      }

      /* --- Profile Popup --- */
      #profile-popup {
          display: none; /* Hidden by default */
          position: absolute;
          top: 60px; /* Position below the header */
          left: 15px;
          background-color: var(--profile-popup-bg);
          border: 1px solid var(--profile-popup-border);
          border-radius: 8px;
          box-shadow: 0 4px 12px var(--profile-popup-shadow);
          z-index: 100;
          min-width: 180px;
          padding: 10px 0; /* Padding top/bottom */
      }
      #profile-popup button {
          display: block;
          width: 100%;
          padding: 10px 15px;
          background: none;
          border: none;
          color: var(--text-color);
          text-align: right;
          cursor: pointer;
          font-size: 0.95rem;
          transition: background-color 0.2s;
          margin: 0; /* Reset button margin */
          border-radius: 0; /* Reset button radius */
      }
      #profile-popup button:hover {
          background-color: var(--profile-button-hover-bg);
      }
       #profile-popup button:disabled {
          color: var(--disabled-text) !important;
          background-color: transparent !important;
          cursor: not-allowed;
       }
      #profile-popup .popup-separator {
          height: 1px;
          background-color: var(--card-border);
          margin: 5px 0;
      }
      #close-popup-btn {
          position: absolute;
          top: 5px;
          left: 8px; /* Adjust position for RTL */
          background: none;
          border: none;
          font-size: 1.4rem;
          color: var(--disabled-text);
          cursor: pointer;
          padding: 0;
          line-height: 1;
      }
      #close-popup-btn:hover {
          color: var(--danger-color);
      }

      /* --- Start Screen --- */
      #start-screen {
        background: linear-gradient(135deg, #a3bffa, #e2e8f0);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin: 10px 0;
      }
      .dark-mode #start-screen {
        background: linear-gradient(135deg, #2d3748, #1a202c);
      }
      #start-screen h2 { color: #2d3748; font-size: 1.5rem; margin: 10px 0; }
      .dark-mode #start-screen h2 { color: #e2e8f0; }
      #start-screen p { font-size: 1.1rem; line-height: 1.5; margin: 20px 0; color: #2d3748; }
      .dark-mode #start-screen p { color: #e2e8f0; }
      #start-screen-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
      @media (max-width: 600px) { #start-screen-buttons { grid-template-columns: 1fr; } }
      .topic-btn { display: flex; align-items: center; justify-content: center; gap: 5px; background-color: var(--button-bg); color: var(--button-text); border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s; }
      .topic-btn:hover { background-color: var(--button-hover-bg); }
      .question-count { font-size: 0.8rem; opacity: 0.8; }

      /* --- Game Screen --- */
      #game-screen, #result-screen { margin-top: 10px; }
      #status-row { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; height: 60px; }
      .status-circle-container { position: relative; width: 54px; height: 54px; }
      .status-circle-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: 1rem; }
      .status-circle-bg { stroke: var(--input-bg); transition: stroke 0.3s; }
      .status-circle-progress { transition: stroke-dashoffset 0.5s linear, stroke 0.5s linear; transform: rotate(-90deg); transform-origin: 50% 50%; }
      #timer-progress { stroke: var(--accent-color); }
      #percentage-progress.green { stroke: var(--success-color); }
      #percentage-progress.yellow { stroke: #ecc94b; }
      #percentage-progress.red { stroke: var(--danger-color); }
      #question { font-size: 1.25rem; margin: 20px 0; line-height: 1.4; }
      .question-id-display { display: inline-block; font-size: 0.7rem; color: var(--disabled-text); margin-right: 8px; opacity: 0.8; user-select: text; direction: ltr; }
      #answers { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .answer-btn { padding: 15px; text-align: center; font-size: 1rem; background-color: var(--input-bg); color: var(--text-color); border: none; border-radius: 15px; cursor: pointer; transition: background-color 0.3s, transform 0.1s, visibility 0s, opacity 0.3s; display: flex; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent; }
      .answer-btn:hover { background-color: var(--input-border); }
      .answer-btn:active { transform: scale(0.95); }
      .correct { background-color: var(--success-color) !important; color: white !important; }
      .wrong { background-color: var(--danger-color) !important; color: white !important; }
      .answer-btn:focus { outline: none; }
      .lifeline-container { position: relative; display: inline-block; margin: 0 5px; }
      #game-buttons { margin: 25px 0; }
      #game-buttons button.lifeline-btn { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; background-color: var(--button-bg); color: var(--button-text); transition: background-color 0.3s, opacity 0.3s, transform 0.1s; display: inline-flex; align-items: center; justify-content: center; font-size: 1rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
      #game-buttons button.lifeline-btn:hover:not(:disabled) { background-color: var(--button-hover-bg); transform: translateY(-1px); }
      #game-buttons button.lifeline-btn:active:not(:disabled) { transform: scale(0.95); box-shadow: none; }
      #game-buttons button.lifeline-btn:disabled { background-color: var(--disabled-bg) !important; color: var(--disabled-text) !important; cursor: not-allowed; opacity: 0.7; box-shadow: none !important; transform: none !important; }
      .lifeline-counter { position: absolute; bottom: -5px; left: -5px; background-color: var(--lifeline-counter-bg); color: var(--lifeline-counter-text); border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; font-weight: bold; display: flex; align-items: center; justify-content: center; line-height: 1; box-shadow: 0 1px 2px rgba(0,0,0,0.2); border: 1px solid rgba(255, 255, 255, 0.3); z-index: 1; transition: background-color 0.3s, color 0.3s, opacity 0.3s; }
      .lifeline-counter.hidden { opacity: 0; pointer-events: none; }

      /* --- Result Screen --- */
      .result-card { background-color: var(--card-bg); padding: 12px 20px; margin: 10px 0; border-radius: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border: 1px solid var(--card-border); }
      .progress-circle { position: relative; display: inline-block; width: 60px; height: 60px; margin: 0 10px 10px 30px; vertical-align: middle; }
      #percentage-text-result { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; }
      .highlight { color: var(--accent-color); font-weight: bold; }
      .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--toast-light-bg); color: var(--toast-light-text); padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.5s; z-index: 1000; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
      .toast.show { opacity: 1; }
      .dark-mode .toast { background-color: var(--toast-dark-bg); color: var(--toast-dark-text); }
      .sequence-circle { width: 30px; height: 30px; line-height: 30px; border-radius: 50%; background-color: var(--input-bg); border: 1px solid var(--input-border); margin: 0 5px; display: inline-flex; justify-content: center; align-items: center; font-size: 0.9rem; transition: background-color 0.3s, border-color 0.3s, color 0.3s; color: var(--text-color); }
      .sequence-circle.correct { background-color: var(--success-color); color: white; border-color: var(--success-color); }
      .sequence-circle.wrong { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
      .sequence-circle.current { background-color: #ecc94b; color: #744210; font-weight: bold; border-color: #d69e2e; }
      .mistake-block { text-align: right; margin: 15px 0; padding-bottom: 10px; border-bottom: 1px solid var(--card-border); }
      .mistake-block:last-child { border-bottom: none; }
      .mistake-question { font-weight: bold; margin-bottom: 5px; }
      .wrong-answer { color: var(--danger-color); margin-bottom: 3px; }
      .correct-answer { color: var(--success-color); }
      .perfect { color: var(--success-color); font-weight: bold; font-size: 1.1rem; }
      #tag-analysis { margin-top: 15px; line-height: 2; text-align: right; }
      .tag-cloud-item { display: inline-block; margin: 3px 4px; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; border: 1px solid; cursor: pointer; transition: transform 0.2s; white-space: nowrap; text-decoration: none; }
      .tag-cloud-item:hover { transform: translateY(-1px); text-decoration: none; }
      .tag-cloud-item:visited { color: inherit; }
      .result-buttons { margin-top: 20px; display: flex; justify-content: center; gap: 15px; }
      .result-buttons button { padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s; }
      #share-result { background-color: var(--success-color); color: white; }
      #share-result:hover { background-color: #38a169; }
      #restart { background-color: var(--accent-color); color: white; }
      #restart:hover { background-color: var(--button-hover-bg); }
      #result-progress-circle.green { stroke: var(--success-color); }
      #result-progress-circle.yellow { stroke: #ecc94b; }
      #result-progress-circle.red { stroke: var(--danger-color); }
      #result-progress-circle { transition: stroke-dashoffset 0.5s linear, stroke 0.5s linear; }
      #ranking ul, #overall-ranking ul { list-style: none; padding: 0; margin: 10px 0 0 0; text-align: right; }
      #ranking li, #overall-ranking li { padding: 5px 0; border-bottom: 1px dashed var(--card-border); font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
      #ranking li:last-child, #overall-ranking li:last-child { border-bottom: none; }
      #ranking li.current-player, #overall-ranking li.current-player { font-weight: bold; color: var(--accent-color); }
      #ranking .rank-score, #overall-ranking .rank-score { font-weight: bold; direction: ltr; margin-left: 10px; }
      #ranking .rank-number, #overall-ranking .rank-number { margin-right: 10px; color: var(--disabled-text); min-width: 25px; text-align: center; }
      .score-popup { position: fixed; top: 40%; left: 50%; transform: translateX(-50%); background-color: rgba(72, 187, 120, 0.9); color: white; padding: 8px 15px; border-radius: 20px; font-size: 1.4rem; font-weight: bold; z-index: 1001; opacity: 0; transition: opacity 0.5s ease-out, transform 0.6s ease-out; pointer-events: none; white-space: pre-line; text-align: center; line-height: 1.3; }
      .score-popup.show { opacity: 1; transform: translate(-50%, -50px); }
      .dark-mode .score-popup { background-color: rgba(104, 211, 145, 0.9); }
      .score-popup .bonus-text { display: block; font-size: 0.9rem; font-weight: normal; margin-top: 4px; }

      /* --- Footer --- */
      footer {
        margin-top: 20px;
        padding: 10px 0 20px 0; /* Added top padding */
        font-size: 0.9rem;
        text-align: center;
        grid-row: 3 / 4; /* Ensure footer is in the last row */
        width: 100%; /* Ensure footer spans width */
        flex-shrink: 0; /* Prevent footer from shrinking */
        border-top: 1px solid var(--card-border); /* Optional: add a separator */
      }
      footer a { color: var(--link-color); text-decoration: none; margin: 0 2px; }

    </style>
  </head>
  <body>
    <script>
      // Set theme ASAP to prevent flash
      try {
          const savedDarkMode = localStorage.getItem("darkMode") === "true";
          if (savedDarkMode) {
              document.body.classList.add("dark-mode");
          }
      } catch (e) {
          console.error("Error accessing localStorage for theme:", e);
      }
    </script>
    <header>
      <h1>טריווBIO</h1>
      <div id="profile-container" title="פרופיל והתחברות">
          <div id="profile-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
              </svg>
          </div>
          <div id="profile-info">
              <div id="nickname-display">טוען...</div>
              <div id="cumulative-score-display">ניקוד: ...</div>
          </div>
      </div>
      <label class="switch">
        <input type="checkbox" id="theme-toggle" />
        <span class="slider">
          <img src="https://img.icons8.com/ios-glyphs/30/ffffff/sun.png" alt="שמש" class="theme-icon sun"/>
          <img src="https://img.icons8.com/ios-glyphs/30/ffffff/moon-symbol.png" alt="ירח" class="theme-icon moon"/>
        </span>
      </label>
    </header>

    <div id="profile-popup">
        <button id="close-popup-btn" title="סגור">×</button>
        <button id="change-nickname-btn">שנה כינוי</button>
        <div class="popup-separator"></div>
        <button id="google-login-btn">התחבר עם Google</button>
        <button id="logout-btn" style="display: none;">התנתק</button>
    </div>

    <div class="container">
      <main>
        <div id="start-screen">
          <h2>מוכן לבחור נושא?</h2>
          <p>
            הדרך הכי טובה ללמוד לבגרות בביולוגיה? פשוט לשחק!
            <br />ככל שתענו על יותר שאלות – תבינו, תזכרו ותנצחו את הבחינה.
            <br />טריווBIO הוא הדרך הכי כיפית, חכמה וממוקדת להתכונן.
          </p>
          <div id="start-screen-buttons"></div>
        </div>
        <div id="game-screen" style="display: none">
          <div id="status-row">
            <div class="status-circle-container">
              <svg width="53.6" height="53.6" viewBox="0 0 53.6 53.6">
                <circle class="status-circle-bg" cx="26.8" cy="26.8" r="25.46" stroke-width="2.68" fill="none"/>
                <circle class="status-circle-progress" id="timer-progress" cx="26.8" cy="26.8" r="25.46" stroke-width="2.68" fill="none" stroke-dasharray="159.84" stroke-dashoffset="0"/>
              </svg>
              <div class="status-circle-text" id="timer-text">120</div>
            </div>
            <div id="sequence-container"></div>
            <div class="status-circle-container">
              <svg width="53.6" height="53.6" viewBox="0 0 53.6 53.6">
                <circle class="status-circle-bg" cx="26.8" cy="26.8" r="25.46" stroke-width="2.68" fill="none"/>
                <circle class="status-circle-progress" id="percentage-progress" cx="26.8" cy="26.8" r="25.46" stroke-width="2.68" fill="none" stroke-dasharray="159.84" stroke-dashoffset="159.84"/>
              </svg>
              <div class="status-circle-text" id="percentage-text-ingame">0%</div>
            </div>
          </div>
          <div id="question"></div>
          <div id="answers"></div>
          <div id="game-buttons">
            <div class="lifeline-container">
               <button id="fifty-fifty" class="lifeline-btn">50:50</button>
               <span id="fifty-fifty-counter" class="lifeline-counter">0</span>
            </div>
            <div class="lifeline-container">
               <button id="add-time" class="lifeline-btn">30+</button>
               <span id="add-time-counter" class="lifeline-counter">1</span> </div>
            <div class="lifeline-container">
               <button id="skip" class="lifeline-btn">דלג</button>
               <span id="skip-counter" class="lifeline-counter">0</span>
            </div>
          </div>
        </div>
        <div id="result-screen" style="display: none">
          <div class="result-card">
            <h3>🏆 תוצאות המשחק</h3>
            <div style="display: flex; align-items: center; justify-content: space-around;">
              <div>
                <p id="score"></p>
                <p id="accuracy-stats"></p>
              </div>
              <div class="progress-circle">
                <svg width="60" height="60" viewBox="0 0 60 60">
                  <circle cx="30" cy="30" r="28" stroke="#e2e8f0" stroke-width="4" fill="none" class="status-circle-bg"/>
                  <circle cx="30" cy="30" r="28" stroke-width="4" fill="none" stroke-dasharray="175.9" stroke-dashoffset="175.9" id="result-progress-circle" class="status-circle-progress"/>
                </svg>
                <span id="percentage-text-result">%</span>
              </div>
            </div>
          </div>
          <div class="result-card">
             <h3>⚙️ גלגלי הצלה בשימוש</h3>
            <p id="tools-used"></p> </div>
          <div class="result-card">
            <h3>📊 דירוג יומי (לפי תשובות נכונות)</h3>
            <div id="ranking">טוען דירוג יומי...</div>
          </div>
          <div class="result-card">
            <h3>💎 היכל התהילה (Top 10 לפי ניקוד)</h3>
            <div id="overall-ranking">טוען דירוג כללי...</div>
          </div>
          <div class="result-card">
            <h3>📚 טעית? למדת!</h3>
            <div id="mistakes"></div>
          </div>
          <div class="result-card">
            <h3>🏷️ תגיות</h3>
            <p>לחץ על תגית כדי לבצע חיפוש בגוגל.</p>
            <div id="tag-analysis"></div>
          </div>
          <div class="result-buttons">
            <button id="share-result">שתף תוצאה</button>
            <button id="restart">שחק שוב</button>
          </div>
        </div>
      </main>
    </div>
    <footer>
      פותח על ידי אריאל מ<a href="https://galilbio.wordpress.com" target="_blank">הַבִּיּוֹלוֹגִים של גליל</a>
      בעזרת<a href="https://grok.com/" target="_blank">גרוק</a>,<a href="https://chatgpt.com/" target="_blank">Chat GPT</a>
      וגם<a href="https://gemini.google.com/app" target="_blank">Gemini</a> |
      <a href="admin.html" target="_blank">ניהול</a>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
      // Wrap entire script logic in a try-catch block for better error reporting
      try {
          console.log("TriviBIO: Script loaded and running");

          // --- Constants and Config ---
          const topicNames = { "human-body": "גוף האדם", cell: "התא", ecology: "אקולוגיה", mix: "ערבב אותי", };
          const firebaseConfig = { apiKey: "AIzaSyAGFC_TB8iEMvS2PyxeASj1HH4i66AW4UA", authDomain: "trivbio.firebaseapp.com", projectId: "trivbio", storageBucket: "trivbio.firebasestorage.app", messagingSenderId: "1097087574583", appId: "1:1097087574583:web:b36c0441537a1f596215b2", measurementId: "G-ZY245YB23E", };
          const CIRCLE_CIRCUMFERENCE = 159.84;
          const RESULT_CIRCLE_CIRCUMFERENCE = 175.9;
          const BASE_SCORE_PER_QUESTION = 10;
          const STREAK_BONUS_MULTIPLIER = 2;
          const INITIAL_SKIP_COUNT = 4;
          const INITIAL_FIFTY_FIFTY_COUNT = 2;
          const INITIAL_ADD_TIME_COUNT = 1;
          const STREAK_THRESHOLD = 3;
          const LIFELINE_BONUS_CHANCE = 0.20;
          const SKIP_BONUS_PROBABILITY = 0.60;
          const FIFTY_FIFTY_BONUS_PROBABILITY = 0.25;
          const streakEmojis = ['🔥', '✨', '🎉', '🚀', '💪', '💯'];
          const lifelineBonusEmojis = ['🎁', '💡', '⭐'];


          // --- Firebase Initialization ---
          let database, auth; // Declare here
          try {
              if (!firebase.apps.length) { // Prevent re-initialization
                 firebase.initializeApp(firebaseConfig);
                 console.log("TriviBIO: Firebase App Initialized");
              } else {
                 firebase.app(); // Use existing app
                 console.log("TriviBIO: Using existing Firebase App");
              }
              database = firebase.database();
              auth = firebase.auth(); // Initialize auth
              console.log("TriviBIO: Firebase Database & Auth services obtained");
          } catch (e) {
              console.error("FATAL: Firebase initialization failed!", e);
              document.body.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">שגיאה קריטית בטעינת Firebase. לא ניתן להמשיך.</div>';
              throw e; // Re-throw to stop script execution here
          }

          // --- DOM Elements ---
          let startScreen, gameScreen, resultScreen, startScreenButtonsContainer, timerTextElement, timerProgressElement, percentageTextIngameElement, percentageProgressElement, questionElement, answersElement, fiftyFiftyButton, addTimeButton, skipButton, restartButton, themeToggle, toolsUsedElement, mistakesElement, sequenceContainer, tagAnalysisElement, resultProgressCircleElement, percentageTextResultElement, scoreElement, accuracyStatsElement, cumulativeScoreDisplayElement, nicknameDisplayElement, rankingElement, overallRankingElement, shareButton, skipCounterElement, fiftyFiftyCounterElement, addTimeCounterElement, profileContainer, profileIcon, profilePopup, closePopupBtn, changeNicknameBtn, googleLoginBtn, logoutBtn;

          function initializeDOMElements() {
              console.log("TriviBIO: Initializing DOM elements...");
              try {
                  startScreen = document.getElementById("start-screen");
                  gameScreen = document.getElementById("game-screen");
                  resultScreen = document.getElementById("result-screen");
                  startScreenButtonsContainer = document.getElementById("start-screen-buttons");
                  timerTextElement = document.getElementById("timer-text");
                  timerProgressElement = document.getElementById("timer-progress");
                  percentageTextIngameElement = document.getElementById("percentage-text-ingame");
                  percentageProgressElement = document.getElementById("percentage-progress");
                  questionElement = document.getElementById("question");
                  answersElement = document.getElementById("answers");
                  fiftyFiftyButton = document.getElementById("fifty-fifty");
                  addTimeButton = document.getElementById("add-time");
                  skipButton = document.getElementById("skip");
                  restartButton = document.getElementById("restart");
                  themeToggle = document.getElementById("theme-toggle");
                  toolsUsedElement = document.getElementById("tools-used");
                  mistakesElement = document.getElementById("mistakes");
                  sequenceContainer = document.getElementById("sequence-container");
                  tagAnalysisElement = document.getElementById("tag-analysis");
                  resultProgressCircleElement = document.getElementById("result-progress-circle");
                  percentageTextResultElement = document.getElementById("percentage-text-result");
                  scoreElement = document.getElementById("score");
                  accuracyStatsElement = document.getElementById("accuracy-stats");
                  cumulativeScoreDisplayElement = document.getElementById("cumulative-score-display");
                  nicknameDisplayElement = document.getElementById("nickname-display");
                  rankingElement = document.getElementById("ranking");
                  overallRankingElement = document.getElementById("overall-ranking");
                  shareButton = document.getElementById("share-result");
                  skipCounterElement = document.getElementById("skip-counter");
                  fiftyFiftyCounterElement = document.getElementById("fifty-fifty-counter");
                  addTimeCounterElement = document.getElementById("add-time-counter");
                  profileContainer = document.getElementById("profile-container");
                  profileIcon = document.getElementById("profile-icon");
                  profilePopup = document.getElementById("profile-popup");
                  closePopupBtn = document.getElementById("close-popup-btn");
                  changeNicknameBtn = document.getElementById("change-nickname-btn");
                  googleLoginBtn = document.getElementById("google-login-btn");
                  logoutBtn = document.getElementById("logout-btn");

                  // Check critical elements
                  const criticalElements = { startScreen, gameScreen, resultScreen, startScreenButtonsContainer, timerTextElement, timerProgressElement, percentageTextIngameElement, percentageProgressElement, questionElement, answersElement, fiftyFiftyButton, addTimeButton, skipButton, restartButton, themeToggle, toolsUsedElement, mistakesElement, sequenceContainer, tagAnalysisElement, resultProgressCircleElement, percentageTextResultElement, scoreElement, accuracyStatsElement, cumulativeScoreDisplayElement, nicknameDisplayElement, rankingElement, overallRankingElement, shareButton, skipCounterElement, fiftyFiftyCounterElement, addTimeCounterElement, profileContainer, profileIcon, profilePopup, closePopupBtn, changeNicknameBtn, googleLoginBtn, logoutBtn };
                  for (const key in criticalElements) {
                      if (!criticalElements[key]) {
                          // Construct the ID from the camelCase key
                          const id = key.replace(/([A-Z])/g, '-$1').toLowerCase();
                          throw new Error(`DOM element not found: #${id}`);
                      }
                  }
                  console.log("TriviBIO: DOM elements retrieved successfully.");
                  return true; // Indicate success
              } catch (error) {
                  console.error("TriviBIO: Error initializing DOM elements:", error);
                  document.body.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">שגיאה קריטית במציאת רכיבי ממשק (${error.message}). נסה לרענן.</div>`;
                  return false; // Indicate failure
              }
          }


          // --- Game State Variables ---
          let currentTopic = "";
          let allQuestions = [];
          let questions = [];
          let currentQuestionIndex = 0;
          let currentQuestion = null;
          let correctCount = 0;
          let wrongCount = 0;
          let timerValue = 120;
          let totalTime = 120;
          let timerInterval;
          let fiftyFiftyUsedCount = 0;
          let addTimeUsed = false;
          let skipUsedCount = 0;
          let availableSkips = INITIAL_SKIP_COUNT;
          let availableFiftyFifty = INITIAL_FIFTY_FIFTY_COUNT;
          let mistakeDetails = [];
          let mistakenQuestions = [];
          let answerSequence = [];
          let answeredCorrectly = [];
          let gameTagStats = {};
          let currentStreak = 0;
          let longestStreak = 0;
          let playerId = null; // Will be set by Auth
          let currentUser = null; // Store the Firebase user object
          let timerExpired = false;
          let gameActive = false;
          let currentGameScore = 0;
          let cumulativePlayerScore = 0;
          let playerNickname = "";

          // --- Nickname Generation ---
          const animalsMale = ["קרוקודיל","קיפודן","קנגורו","ברווזן","נמר","אריה","זאב","דוב","תנין","פיל","ג'ירף","צבי","יגואר","ברדלס","גמל","שועל",];
          const animalsFemale = ["נמלה","צרעה","פרפרית","צלופחית","ציפור","חתולה","ארנבת","עטלף","צפרדע","שפירית","ברווזה","יענה","טווסית","נחשית","עכברה","ינשופה",];
          const attributesMale = ["אמיץ","חכם","מהיר","שקט","חזק","סקרן","נאמן","ירוק","כחול","אדום","צהוב","שחור","לבן","סגול","כתום","זהוב",];
          const attributesFemale = ["אמיצה","חכמה","מהירה","שקטה","חזקה","סקרנית","נאמנה","ירוקה","כחולה","אדומה","צהובה","שחורה","לבנה","סגולה","כתומה","זהובה",];
          function generateRandomUsername() {
            console.log("TriviBIO: Generating random username.");
            const isMale = Math.random() < 0.5;
            const animals = isMale ? animalsMale : animalsFemale;
            const animal = animals[Math.floor(Math.random() * animals.length)];
            const attributes = isMale ? attributesMale : attributesFemale;
            const attribute = attributes[Math.floor(Math.random() * attributes.length)];
            return `${animal} ${attribute}`;
          }

          // --- UI Update Functions ---
          function populateTopicButtons(questionCounts) {
              if (!startScreenButtonsContainer) {
                  console.error("TriviBIO: Cannot populate topic buttons: container not found.");
                  return;
              }
              console.log("TriviBIO: Populating topic buttons with counts:", questionCounts);
              const topics = [
                  { id: "human-body", name: "גוף האדם", emoji: "🧍" },
                  { id: "cell", name: "התא", emoji: "🧬" },
                  { id: "ecology", name: "אקולוגיה", emoji: "🌍" },
                  { id: "mix", name: "ערבב אותי", emoji: "🎲" },
              ];

              startScreenButtonsContainer.innerHTML = ""; // Clear existing buttons
              topics.forEach((topic) => {
                  const button = document.createElement("button");
                  button.classList.add("topic-btn");
                  button.dataset.topic = topic.id;
                  const count = (questionCounts && typeof questionCounts[topic.id] === 'number') ? questionCounts[topic.id] : 0;
                  button.innerHTML = `${topic.name} <span>${topic.emoji}</span> <span class="question-count">[${count} שאלות]</span>`;
                  // Add event listener *inside* the loop for each button
                  button.addEventListener("click", async () => {
                      console.log(`TriviBIO: Topic button clicked: ${topic.id}`);
                      vibrate(50);
                      currentTopic = button.getAttribute("data-topic");
                      // Ensure loadQuestionsForTopic is awaited if it's async
                      await loadQuestionsForTopic(currentTopic);
                  });
                  startScreenButtonsContainer.appendChild(button);
              });
              console.log("TriviBIO: Topic buttons populated and listeners attached.");
          }

          function showToast(message, duration = 3000) {
              // Remove existing toasts first
              document.querySelectorAll(".toast").forEach((t) => t.remove());

              const toast = document.createElement("div");
              toast.classList.add("toast");
              toast.textContent = message;
              document.body.appendChild(toast);

              // Trigger reflow to enable animation
              toast.offsetHeight;

              toast.classList.add("show");

              if (duration > 0) {
                  setTimeout(() => {
                      toast.classList.remove("show");
                      // Remove element after fade out animation completes
                      setTimeout(() => { if(toast.parentNode) toast.remove() }, 500);
                  }, duration);
              }
          }

          function updateCumulativeScoreDisplay() {
              if (cumulativeScoreDisplayElement) {
                  cumulativeScoreDisplayElement.textContent = `ניקוד: ${cumulativePlayerScore.toLocaleString()}`;
              } else {
                  console.error("TriviBIO: Cumulative score display element not found.");
              }
          }

          function updateNicknameDisplay() {
              if (nicknameDisplayElement) {
                  nicknameDisplayElement.textContent = playerNickname || "טוען...";
                  nicknameDisplayElement.removeEventListener("click", editNickname); // Remove previous before adding
                  nicknameDisplayElement.addEventListener("click", editNickname);
              } else {
                  console.error("TriviBIO: Nickname display element not found.");
              }
          }

          function setTheme(isDarkMode) {
              document.body.classList.toggle("dark-mode", isDarkMode);
              if (timerProgressElement) {
                  if (timerValue <= 30) {
                      timerProgressElement.style.stroke = "var(--danger-color)";
                  } else {
                      timerProgressElement.style.stroke = "var(--accent-color)";
                  }
              }
          }

          function updateLifelineCounters() {
              if (!skipCounterElement || !fiftyFiftyCounterElement || !addTimeCounterElement || !skipButton || !fiftyFiftyButton || !addTimeButton) {
                  console.warn("TriviBIO: One or more lifeline counter/button elements missing, cannot update counters.");
                  return;
              }
              skipCounterElement.textContent = availableSkips;
              skipCounterElement.classList.toggle('hidden', availableSkips <= 0);

              fiftyFiftyCounterElement.textContent = availableFiftyFifty;
              fiftyFiftyCounterElement.classList.toggle('hidden', availableFiftyFifty <= 0);

              addTimeCounterElement.textContent = addTimeUsed ? '0' : '1';
              addTimeCounterElement.classList.toggle('hidden', addTimeUsed);

              skipButton.disabled = (availableSkips <= 0 || timerExpired || !gameActive);
              fiftyFiftyButton.disabled = (availableFiftyFifty <= 0 || timerExpired || !gameActive);
              addTimeButton.disabled = (addTimeUsed || timerExpired || !gameActive);
          }

          function updateProfileUI(user) {
              if (!googleLoginBtn || !logoutBtn || !profileIcon) {
                  console.error("TriviBIO: Profile UI elements missing for update.");
                  return;
              }
              if (user && !user.isAnonymous) {
                  googleLoginBtn.style.display = 'none';
                  logoutBtn.style.display = 'block';
                  console.log("TriviBIO: UI updated for Google user.");
              } else {
                  googleLoginBtn.style.display = 'block';
                  logoutBtn.style.display = 'none';
                  profileIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`;
                  console.log("TriviBIO: UI updated for Anonymous/Logged out user.");
              }
          }


          // --- Initialization and Auth ---
          function mainAppLogic() {
              console.log("TriviBIO: Running mainAppLogic...");
              if (!database || !auth) {
                  console.error("TriviBIO: Firebase Database or Auth not initialized. Cannot run main logic.");
                  showToast("שגיאה קריטית: אין חיבור ל-Firebase.");
                  return;
              }

              // Initialize question counts and populate buttons
              (async function initializeQuestionCounts() {
                  console.log("TriviBIO: Initializing question counts...");
                  let cachedCounts = {};
                  let cachedTimestamp = null;
                  const defaultCounts = { "human-body": 0, cell: 0, ecology: 0, mix: 0 };
                  try {
                      cachedCounts = JSON.parse(localStorage.getItem("questionCounts") || "{}");
                      Object.keys(defaultCounts).forEach(key => {
                          if (typeof cachedCounts[key] !== 'number') cachedCounts[key] = 0;
                      });
                      cachedTimestamp = localStorage.getItem("questionCountsTimestamp");
                  } catch (e) {
                      console.error("TriviBIO: Error reading question counts from localStorage", e);
                      cachedCounts = { ...defaultCounts };
                      localStorage.removeItem("questionCounts");
                      localStorage.removeItem("questionCountsTimestamp");
                  }

                  const currentTime = Date.now();
                  const oneDay = 24 * 60 * 60 * 1000;
                  const isCacheStale = !cachedTimestamp || (currentTime - parseInt(cachedTimestamp)) >= oneDay;

                  populateTopicButtons(cachedCounts); // Populate with initial/cached data

                  if (isCacheStale) {
                      console.log("TriviBIO: Cache is stale or missing. Fetching new question counts...");
                      try {
                          const snapshot = await database.ref("questions").once("value");
                          const allQsData = snapshot.val();
                          const freshCounts = { "human-body": 0, cell: 0, ecology: 0, mix: 0 };
                          let totalFetched = 0;
                          if (allQsData && typeof allQsData === 'object') { // Check if it's an object
                              Object.values(allQsData).forEach(q => {
                                  if (q && q.topic && freshCounts.hasOwnProperty(q.topic)) {
                                      freshCounts[q.topic]++;
                                      freshCounts["mix"]++;
                                      totalFetched++;
                                  }
                              });
                          } else {
                              console.warn("TriviBIO: Invalid or null data received for questions count.");
                          }
                          if (totalFetched > 0) {
                              localStorage.setItem("questionCounts", JSON.stringify(freshCounts));
                              localStorage.setItem("questionCountsTimestamp", currentTime.toString());
                              console.log("TriviBIO: Repopulating buttons with fresh counts:", freshCounts);
                              populateTopicButtons(freshCounts);
                          } else {
                               console.warn("TriviBIO: No valid questions found during Firebase fetch for counts.");
                          }
                      } catch (error) {
                          console.error("TriviBIO: Error fetching fresh question counts:", error);
                      }
                  } else {
                      console.log("TriviBIO: Using fresh cached question counts.");
                  }
              })();


              // --- Firebase Auth State Listener ---
              console.log("TriviBIO: Setting up onAuthStateChanged listener...");
              auth.onAuthStateChanged(async (user) => {
                   console.log("TriviBIO: onAuthStateChanged triggered.");
                   currentUser = user;
                   if (user) {
                       playerId = user.uid;
                       console.log(`TriviBIO: Auth State Changed: User logged in. UID: ${playerId}, Anonymous: ${user.isAnonymous}`);
                       updateProfileUI(user);
                       await initializePlayerState();
                   } else {
                       console.log("TriviBIO: Auth State Changed: User logged out. Attempting anonymous sign-in.");
                       playerId = null;
                       currentUser = null;
                       updateProfileUI(null);
                       try {
                           console.log("TriviBIO: Calling signInAnonymously...");
                           const userCredential = await auth.signInAnonymously();
                           console.log("TriviBIO: Anonymous sign-in successful after logout. New user:", userCredential.user?.uid);
                       } catch (error) {
                           console.error("TriviBIO: Anonymous sign-in failed after logout:", error);
                           showToast("שגיאה בהתחברות אנונימית.");
                           if(cumulativeScoreDisplayElement) cumulativeScoreDisplayElement.textContent = "שגיאת התחברות";
                           if(nicknameDisplayElement) nicknameDisplayElement.textContent = "אורח";
                           availableSkips = INITIAL_SKIP_COUNT;
                           availableFiftyFifty = INITIAL_FIFTY_FIFTY_COUNT;
                           addTimeUsed = false;
                           updateLifelineCounters();
                       }
                   }
              });


              // Theme Toggle Listener
              if (themeToggle) {
                  themeToggle.addEventListener("change", () => {
                      console.log("TriviBIO: Theme toggle changed.");
                      vibrate(50);
                      const isDarkMode = themeToggle.checked;
                      setTheme(isDarkMode);
                      saveThemePreference(isDarkMode);
                  });
              } else {
                  console.error("TriviBIO: Theme toggle element not found! Cannot add listener.");
              }

              // --- Profile Popup Listeners ---
              if (profileIcon && profilePopup) {
                  profileIcon.addEventListener("click", (event) => {
                       console.log("TriviBIO: Profile icon clicked.");
                       event.stopPropagation();
                       profilePopup.style.display = profilePopup.style.display === 'block' ? 'none' : 'block';
                       console.log(`TriviBIO: Profile popup display set to: ${profilePopup.style.display}`);
                  });
              }
              if (closePopupBtn && profilePopup) {
                  closePopupBtn.addEventListener("click", () => {
                      console.log("TriviBIO: Close popup button clicked.");
                      profilePopup.style.display = 'none';
                  });
              }
              document.addEventListener('click', (event) => {
                  if (profilePopup && profileContainer && !profileContainer.contains(event.target) && profilePopup.style.display === 'block') {
                      console.log("TriviBIO: Clicked outside profile popup.");
                      profilePopup.style.display = 'none';
                  }
              });

              // --- Profile Action Button Listeners ---
              if (changeNicknameBtn) {
                  changeNicknameBtn.addEventListener("click", () => {
                      console.log("TriviBIO: Change nickname button clicked."); // DEBUG
                      if(profilePopup) profilePopup.style.display = 'none';
                      editNickname(); // Call the function
                  });
              }
              if (googleLoginBtn) {
                  googleLoginBtn.addEventListener("click", () => {
                      console.log("TriviBIO: Google login button clicked."); // DEBUG
                      if(profilePopup) profilePopup.style.display = 'none';
                      const provider = new firebase.auth.GoogleAuthProvider();
                      try {
                          auth.signInWithPopup(provider)
                              .then((result) => {
                                  console.log("TriviBIO: Google Sign-In successful:", result.user?.uid, result.user?.displayName);
                                  showToast(`ברוך הבא, ${result.user.displayName}!`);
                              })
                              .catch((error) => {
                                  console.error("TriviBIO: Google Sign-In Error:", error);
                                  if (error.code === 'auth/popup-closed-by-user') {
                                     showToast("התחברות בוטלה.");
                                  } else if (error.code === 'auth/network-request-failed') {
                                     showToast("שגיאת רשת בעת ניסיון ההתחברות.");
                                  } else {
                                     showToast("שגיאה בהתחברות עם Google.");
                                  }
                              });
                      } catch (error) {
                           console.error("TriviBIO: Error initiating Google Sign-In:", error);
                           showToast("שגיאה בהפעלת תהליך ההתחברות.");
                      }
                  });
              }
              if (logoutBtn) {
                  logoutBtn.addEventListener("click", () => {
                      console.log("TriviBIO: Logout button clicked."); // DEBUG
                      if(profilePopup) profilePopup.style.display = 'none';
                      try {
                          auth.signOut()
                              .then(() => {
                                  console.log("TriviBIO: User signed out successfully.");
                                  showToast("התנתקת בהצלחה.");
                              })
                              .catch((error) => {
                                  console.error("TriviBIO: Sign Out Error:", error);
                                  showToast("שגיאה בהתנתקות.");
                              });
                      } catch(error) {
                           console.error("TriviBIO: Error initiating Sign Out:", error);
                           showToast("שגיאה בתהליך ההתנתקות.");
                      }
                  });
              }


              // Lifeline Button Listeners
              if (fiftyFiftyButton) {
                  fiftyFiftyButton.addEventListener("click", fiftyFiftyButtonClickHandler);
              } else { console.error("TriviBIO: Fifty-fifty button not found!"); }
              if (addTimeButton) {
                  addTimeButton.addEventListener("click", addTimeButtonClickHandler);
              } else { console.error("TriviBIO: Add time button not found!"); }
              if (skipButton) {
                  skipButton.addEventListener("click", skipButtonClickHandler);
              } else { console.error("TriviBIO: Skip button not found!"); }
              console.log("TriviBIO: Main app logic setup complete.");
          }


          // --- UPDATED: initializePlayerState ---
          async function initializePlayerState() {
              if (!playerId) {
                   console.error("TriviBIO: initializePlayerState called without playerId.");
                   cumulativePlayerScore = 0;
                   playerNickname = generateRandomUsername();
                   availableSkips = INITIAL_SKIP_COUNT;
                   availableFiftyFifty = INITIAL_FIFTY_FIFTY_COUNT;
                   updateCumulativeScoreDisplay();
                   updateNicknameDisplay();
                   updateLifelineCounters();
                   return;
              };

              const savedDarkMode = localStorage.getItem("darkMode") === "true";
              setTheme(savedDarkMode);
              if(themeToggle) themeToggle.checked = savedDarkMode;

              const localLastTopic = localStorage.getItem("lastTopic");
              if (localLastTopic && topicNames[localLastTopic]) {
                  updateStartScreenHint(localLastTopic);
              }

              console.log("TriviBIO: Fetching player data for playerId:", playerId);
              try {
                  const snapshot = await database.ref(`players/${playerId}`).once("value");
                  const playerData = snapshot.val() || {};
                  console.log("TriviBIO: Player data fetched:", playerData);

                  cumulativePlayerScore = playerData.cumulativeScore || 0;
                  playerNickname = (currentUser && !currentUser.isAnonymous && currentUser.displayName) ? currentUser.displayName : (playerData.nickname || generateRandomUsername());
                  availableSkips = (typeof playerData.availableSkips === 'number') ? playerData.availableSkips : INITIAL_SKIP_COUNT;
                  availableFiftyFifty = (typeof playerData.availableFiftyFifty === 'number') ? playerData.availableFiftyFifty : INITIAL_FIFTY_FIFTY_COUNT;

                  updateCumulativeScoreDisplay();
                  updateNicknameDisplay();
                  updateLifelineCounters();

                  if (playerData.lastTopic && topicNames[playerData.lastTopic] && playerData.lastTopic !== localLastTopic) {
                      updateStartScreenHint(playerData.lastTopic);
                      localStorage.setItem("lastTopic", playerData.lastTopic);
                  }
                  if (typeof playerData.darkMode === 'boolean' && playerData.darkMode !== savedDarkMode) {
                      setTheme(playerData.darkMode);
                      if(themeToggle) themeToggle.checked = playerData.darkMode;
                      localStorage.setItem("darkMode", playerData.darkMode.toString());
                  }

                  if (!snapshot.exists()) {
                      await savePlayerInitialData(savedDarkMode, playerNickname); // Wait for initial save
                  } else if (currentUser && !currentUser.isAnonymous && currentUser.displayName && playerData.nickname !== currentUser.displayName) {
                      await saveNicknameToFirebase(currentUser.displayName); // Wait for nickname update
                  }
                  console.log("TriviBIO: initializePlayerState completed for:", playerId); // Debug log

              } catch (error) {
                  console.error("TriviBIO: Error fetching player data:", error);
                  showToast("שגיאה בטעינת נתוני שחקן");
                  cumulativePlayerScore = parseInt(localStorage.getItem("cumulativeScoreBackup") || "0");
                  playerNickname = generateRandomUsername();
                  availableSkips = INITIAL_SKIP_COUNT;
                  availableFiftyFifty = INITIAL_FIFTY_FIFTY_COUNT;
                  updateCumulativeScoreDisplay();
                  updateNicknameDisplay();
                  updateLifelineCounters();
              }
          }


          // --- UPDATED: savePlayerInitialData ---
          async function savePlayerInitialData(isDarkMode, nicknameToSave) { // Made async
              if (!playerId) return;
              const initialData = {
                  cumulativeScore: 0,
                  nickname: nicknameToSave || playerNickname,
                  darkMode: isDarkMode,
                  createdAt: firebase.database.ServerValue.TIMESTAMP,
                  correctCount: 0,
                  wrongCount: 0,
                  topicStats: {},
                  tagStats: {},
                  availableSkips: INITIAL_SKIP_COUNT,
                  availableFiftyFifty: INITIAL_FIFTY_FIFTY_COUNT
              };
              console.log("TriviBIO: Saving initial player data:", initialData);
              try {
                  await database.ref(`players/${playerId}`).set(initialData);
                  console.log("TriviBIO: Initial player data saved for new player.");
              } catch (error) {
                  console.error("TriviBIO: Failed to save initial player data:", error);
                  showToast("שגיאה בשמירת נתונים ראשוניים");
              }
          }

          // --- UPDATED: saveNicknameToFirebase ---
          async function saveNicknameToFirebase(newName = null) { // Made async
              console.log("TriviBIO: Attempting to save nickname..."); // Debug log
              if (!playerId) {
                  console.error("TriviBIO: Cannot save nickname, playerId is null.");
                   showToast("שגיאה: לא ניתן לשמור כינוי ללא מזהה משתמש.");
                  return;
              }
              const nameToSave = newName || playerNickname;
              try {
                  await database.ref(`players/${playerId}`).update({ nickname: nameToSave });
                  console.log("TriviBIO: Nickname updated in Firebase:", nameToSave);
                  if (newName) playerNickname = newName; // Update local state only after successful save
                  updateNicknameDisplay(); // Update UI after successful save
                  showToast("הכינוי עודכן!"); // Success feedback
              } catch (error) {
                  console.error("TriviBIO: Failed to update nickname:", error);
                  showToast("שגיאה בעדכון שם המשתמש");
              }
          }

          // --- Function to save persistent player state (including lifelines) ---
          async function savePlayerStateToFirebase() {
              if (!playerId) return;
              const updates = {
                  availableSkips: availableSkips,
                  availableFiftyFifty: availableFiftyFifty,
              };
              console.log("TriviBIO: Saving player state to Firebase:", updates);
              try {
                  await database.ref(`players/${playerId}`).update(updates);
                  console.log("TriviBIO: Player lifeline state saved successfully.");
              } catch (error) {
                  console.error("TriviBIO: Failed to save player lifeline state:", error);
                  showToast("שגיאה בשמירת מצב גלגלי הצלה!");
              }
          }


          function updateStartScreenHint(topicId) { /* ... unchanged ... */ }
          function editNickname() {
              console.log("TriviBIO: editNickname called"); // Debug log
              if (!playerId) {
                  showToast("יש להתחבר כדי לשנות כינוי.");
                  return;
              }
              const currentName = playerNickname; // Use current state variable

              if (!gameActive) { // Allow editing freely when game is not active
                  const newName = prompt("הכנס שם משתמש חדש (עד 25 תווים):", currentName);
                  if (newName === null) { console.log("TriviBIO: Nickname change cancelled by user."); return; } // User cancelled
                  if (newName && newName.trim() && newName.length <= 25) {
                      saveNicknameToFirebase(newName.trim()); // Save and update UI on success
                  } else if (newName.length > 25) {
                      showToast("שם המשתמש ארוך מדי!");
                  } else if (!newName.trim()) {
                      showToast("שם המשתמש לא יכול להיות ריק.");
                  }
                  return;
              }

              // Pause timer if game is active
              clearInterval(timerInterval);
              console.log("TriviBIO: Timer paused for nickname edit.");
              const newName = prompt("הכנס שם משתמש חדש (עד 25 תווים):", currentName);
              if (newName === null) { // User cancelled
                   console.log("TriviBIO: Nickname change cancelled by user during game.");
                  if (gameActive && !timerExpired) startTimer(false); // Resume timer if cancelled
                  return;
              }
              if (newName && newName.trim() && newName.length <= 25) {
                  saveNicknameToFirebase(newName.trim()); // Save and update UI on success
              } else if (newName.length > 25) {
                  showToast("שם המשתמש ארוך מדי!");
              } else if (!newName.trim()) {
                  showToast("שם המשתמש לא יכול להיות ריק.");
              }
              // Resume timer only if game was active and timer hasn't expired
              if (gameActive && !timerExpired) {
                  console.log("TriviBIO: Resuming timer after nickname edit.");
                  startTimer(false); // Pass false to not reset timer value
              }
          }
          function saveThemePreference(isDarkMode) { /* ... unchanged ... */ }

          // --- UPDATED: loadQuestions ---
          async function loadQuestions() {
              console.log("TriviBIO: loadQuestions called.");
              const cachedQuestions = localStorage.getItem("questions");
              const cachedTimestamp = localStorage.getItem("questionsTimestamp");
              const currentTime = Date.now();
              const oneDay = 24 * 60 * 60 * 1000; // Cache duration

              // Check if cache is valid
              if (cachedQuestions && cachedTimestamp && (currentTime - parseInt(cachedTimestamp)) < oneDay) {
                  console.log("TriviBIO: Using cached questions.");
                  try {
                      const parsed = JSON.parse(cachedQuestions);
                      if (Array.isArray(parsed) && parsed.every(q => q && typeof q.id !== 'undefined')) {
                          console.log(`TriviBIO: Parsed ${parsed.length} questions from cache.`);
                          return parsed;
                      } else {
                          console.warn("TriviBIO: Cached questions format invalid or missing IDs, refetching.");
                          localStorage.removeItem("questions");
                          localStorage.removeItem("questionsTimestamp");
                      }
                  } catch (e) {
                      console.error("TriviBIO: Error parsing cached questions, fetching fresh.", e);
                      localStorage.removeItem("questions");
                      localStorage.removeItem("questionsTimestamp");
                  }
              }

              // Fetch fresh questions if cache is invalid or missing
              console.log("TriviBIO: Fetching fresh questions from Firebase...");
              try {
                  const snapshot = await database.ref("questions").once("value");
                  const questionsData = snapshot.val();
                  const fetchedQuestions = [];
                  // Check if questionsData is an object before iterating
                  if (questionsData && typeof questionsData === 'object') {
                      for (const key in questionsData) {
                          const q = questionsData[key];
                          // Validate question structure before adding
                          if (q && q.question && Array.isArray(q.answers) && typeof q.correct !== 'undefined' && q.answers.length >= 2) {
                              q.id = key; // Add the Firebase key as 'id'
                              fetchedQuestions.push(q);
                          } else {
                              console.warn(`TriviBIO: Skipping invalid question data with key ${key}:`, q);
                          }
                      }
                  } else {
                      console.warn("TriviBIO: No question data received from Firebase or data is not an object.");
                  }

                  if (fetchedQuestions.length > 0) {
                      localStorage.setItem("questions", JSON.stringify(fetchedQuestions));
                      localStorage.setItem("questionsTimestamp", currentTime.toString());
                      console.log(`TriviBIO: Fetched and cached ${fetchedQuestions.length} valid questions.`);
                      return fetchedQuestions;
                  } else {
                      console.warn("TriviBIO: No valid questions found in Firebase!");
                      return []; // Return empty array if no valid questions found
                  }
              } catch (error) {
                  console.error("TriviBIO: Error fetching questions from Firebase:", error);
                  showToast("שגיאה חמורה בטעינת שאלות!");
                  return []; // Return empty array on error
              }
          }

          // --- UPDATED: loadQuestionsForTopic ---
          async function loadQuestionsForTopic(topic) {
               console.log(`TriviBIO: loadQuestionsForTopic called with topic: ${topic}`);
               try {
                   showToast("טוען שאלות...", 0);
                   saveLastTopic(topic);
                   allQuestions = await loadQuestions(); // Ensure this returns a valid array
                   console.log(`TriviBIO: Total questions available after loadQuestions: ${allQuestions?.length ?? 0}`);
                   document.querySelectorAll(".toast").forEach(t => t.remove());

                   // Check if allQuestions is a valid array
                   if (!Array.isArray(allQuestions)) {
                       console.error("TriviBIO: loadQuestions did not return a valid array.", allQuestions);
                       showToast("שגיאה בנתוני השאלות. נסה לרענן.");
                       return;
                   }
                   if (allQuestions.length === 0) {
                       showToast("לא נטענו שאלות. נסה לרענן את הדף.");
                       return;
                   }

                   // Filter questions
                   if (topic === "mix") {
                       questions = [...allQuestions];
                   } else {
                       questions = allQuestions.filter(q => q && q.topic === topic);
                   }

                   // Validate filtered questions
                   questions = questions.filter(q => q && q.id && q.question && Array.isArray(q.answers) && typeof q.correct !== 'undefined' && q.answers.length >= 2);
                   console.log(`TriviBIO: Filtered questions for topic ${topic}: ${questions.length}`);

                   if (questions.length === 0) {
                       showToast(`אין שאלות זמינות לנושא "${topicNames[topic] || topic}"!`);
                       return;
                   }

                   startGame(); // Start the game
               } catch (error) {
                   console.error("TriviBIO: Error in loadQuestionsForTopic:", error); // Log the specific error
                   document.querySelectorAll(".toast").forEach(t => t.remove());
                   showToast(`שגיאה בטעינת השאלות: ${error.message}`); // Show error message
               }
           }

          function saveLastTopic(topic) { /* ... unchanged ... */ }
          function vibrate(duration) { /* ... unchanged ... */ }
          function resetGame() { /* ... unchanged ... */ }
          function startGame() {
               console.log("TriviBIO: startGame called."); // Debug log
               if (!startScreen || !gameScreen || !resultScreen) {
                   console.error("TriviBIO: Cannot start game: screen elements not found.");
                   return;
               }
               // Add check for questions array validity
               if (!Array.isArray(questions) || questions.length === 0) {
                   console.error("TriviBIO: Cannot start game, no valid questions loaded for the topic.");
                   showToast("שגיאה: לא נמצאו שאלות לנושא הנבחר.");
                   return; // Prevent starting game without questions
               }

               startScreen.style.display = "none";
               resultScreen.style.display = "none";
               gameScreen.style.display = "block";

               resetGame(); // Reset game-specific variables, keeps persistent lifelines
               gameActive = true; // Set game active *after* reset

               // Shuffle questions for the current game
               questions = [...questions].sort(() => Math.random() - 0.5);

               initSequence(); // Initialize the sequence display
               updatePercentage(); // Update initial percentage display (0%)
               loadQuestion(); // Load the first question
               startTimer(); // Start the game timer

               console.log(`TriviBIO: Game started with ${questions.length} questions for topic: ${currentTopic}`);
           }
          function initSequence() { /* ... unchanged ... */ }
          function shuffleAnswers(answers, correctIndex) { /* ... unchanged ... */ }
          function loadQuestion() {
               console.log("TriviBIO: loadQuestion called."); // Debug log
               if (!gameActive || (timerExpired && currentQuestion)) {
                   console.log("TriviBIO: Timer expired or game inactive, preventing next question load.");
                   if (gameActive && !currentQuestion && !timerExpired) {
                       endGame();
                   }
                   return;
               }
               // Add check for questions array validity
               if (!Array.isArray(questions)) {
                   console.error("TriviBIO: questions array is invalid in loadQuestion.");
                   endGame(); // End game if questions are invalid
                   return;
               }
               // ... rest of the function ...
                const readyMistakes = [];
                mistakenQuestions = mistakenQuestions.filter(mq => {
                    if (!mq || !mq.question) return false;
                    if (mq.delay > 0) {
                        mq.delay--;
                        return true;
                    } else {
                        readyMistakes.push(mq.question);
                        return false;
                    }
                });
                let availableRegularQuestions = questions.filter(q =>
                    q && q.id && q.question &&
                    !answeredCorrectly.some(aq => aq && aq.id === q.id) &&
                    !mistakenQuestions.some(mq => mq && mq.question.id === q.id) &&
                    !readyMistakes.some(rm => rm && rm.id === q.id)
                );
                console.log(`TriviBIO: Available regular: ${availableRegularQuestions.length}, Ready mistakes: ${readyMistakes.length}, Waiting mistakes: ${mistakenQuestions.length}`);
                if (availableRegularQuestions.length === 0 && readyMistakes.length === 0 && mistakenQuestions.length === 0) {
                    console.log("TriviBIO: No more questions or mistakes available. Ending game.");
                    if (gameActive) endGame();
                    return;
                }
                let nextQuestion = null;
                const showMistakeChance = 0.4;
                if (readyMistakes.length > 0 && (availableRegularQuestions.length === 0 || Math.random() < showMistakeChance)) {
                    const randomIndex = Math.floor(Math.random() * readyMistakes.length);
                    nextQuestion = readyMistakes.splice(randomIndex, 1)[0];
                    console.log("TriviBIO: Loading a mistake question:", nextQuestion?.id);
                } else if (availableRegularQuestions.length > 0) {
                    currentQuestionIndex = currentQuestionIndex % availableRegularQuestions.length;
                    nextQuestion = availableRegularQuestions[currentQuestionIndex];
                    currentQuestionIndex++;
                    console.log(`TriviBIO: Loading regular question #${currentQuestionIndex}:`, nextQuestion?.id);
                } else if (readyMistakes.length > 0) {
                    const randomIndex = Math.floor(Math.random() * readyMistakes.length);
                    nextQuestion = readyMistakes.splice(randomIndex, 1)[0];
                    console.log("TriviBIO: Loading a fallback mistake question:", nextQuestion?.id);
                } else {
                    console.warn("TriviBIO: Question selection logic failed unexpectedly. Ending game.");
                    if (gameActive) endGame();
                    return;
                }
                readyMistakes.forEach(m => {
                    if (!mistakenQuestions.some(mq => mq && mq.question.id === m.id)) {
                        mistakenQuestions.push({ question: m, delay: 0 });
                    }
                });
                if (!nextQuestion || !nextQuestion.id || !nextQuestion.question || !Array.isArray(nextQuestion.answers) || typeof nextQuestion.correct === 'undefined' || nextQuestion.answers.length < 2) {
                    console.error("TriviBIO: Invalid question data selected:", nextQuestion, "Attempting to skip and load another...");
                    questions = questions.filter(q => q !== nextQuestion);
                    mistakenQuestions = mistakenQuestions.filter(mq => mq.question !== nextQuestion);
                    answeredCorrectly = answeredCorrectly.filter(aq => aq !== nextQuestion);
                    loadQuestion();
                    return;
                }
                currentQuestion = nextQuestion;
                currentQuestion.startTime = Date.now();
                try { // Add try-catch around shuffle
                   currentQuestion.shuffledAnswers = shuffleAnswers([...currentQuestion.answers], currentQuestion.correct);
                   if (!Array.isArray(currentQuestion.shuffledAnswers) || currentQuestion.shuffledAnswers.length < 2) {
                       throw new Error("Invalid shuffled answers array.");
                   }
                } catch(error) {
                   console.error("TriviBIO: Error shuffling answers for:", currentQuestion?.id, error);
                   questions = questions.filter(q => q !== currentQuestion);
                   mistakenQuestions = mistakenQuestions.filter(mq => mq.question !== currentQuestion);
                   loadQuestion(); // Try next question
                   return;
                }

                if(questionElement) {
                    questionElement.innerHTML = "";
                    const questionTextNode = document.createTextNode(currentQuestion.question);
                    questionElement.appendChild(questionTextNode);
                }
                if(answersElement) {
                    answersElement.innerHTML = "";
                    currentQuestion.shuffledAnswers.forEach((answer, index) => {
                        const button = document.createElement("button");
                        button.classList.add("answer-btn");
                        button.textContent = answer.text;
                        button.style.visibility = "visible";
                        button.style.opacity = "1";
                        button.disabled = false;
                        button.addEventListener("click", () => {
                            vibrate(50);
                            checkAnswer(index);
                        });
                        answersElement.appendChild(button);
                    });
                }
                updateLifelineCounters();
                updateSequence();
           }
          function createScorePopup(score, isStreakBonus = false, lifelineBonusText = null) { /* ... unchanged ... */ }
          async function updatePlayerStatsFirebase(playerId, question, isCorrect, scoreGained = 0) { /* ... unchanged ... */ }
          function checkAnswer(selectedIndex) { /* ... unchanged ... */ }
          function updateSequence() { /* ... unchanged ... */ }
          function updatePercentage() { /* ... unchanged ... */ }
          function startTimer(reset = true) { /* ... unchanged ... */ }
          function updateTimerCircle() { /* ... unchanged ... */ }
          function fiftyFiftyButtonClickHandler() { /* ... unchanged ... */ }
          function addTimeButtonClickHandler() { /* ... unchanged ... */ }
          function skipButtonClickHandler() { /* ... unchanged ... */ }
          function launchConfetti() { /* ... unchanged ... */ }
          function saveGameResult() { /* ... unchanged ... */ }
          async function getDailyRankings() { /* ... unchanged ... */ }
          async function getOverallRankings(limit = 10) { /* ... unchanged ... */ }
          function displayRankings(element, rankings, currentPlayerRank, scoreField, rankLabelPrefix = "") { /* ... unchanged ... */ }
          async function endGame() { /* ... unchanged ... */ }


          // --- Wait for DOMContentLoaded before running main logic ---
          document.addEventListener('DOMContentLoaded', () => {
              console.log("TriviBIO: DOMContentLoaded event fired.");
              try {
                  if (initializeDOMElements()) { // Initialize DOM elements first
                      mainAppLogic(); // Run main logic only if DOM elements are found
                  }
              } catch (error) {
                  console.error("TriviBIO: Error during DOMContentLoaded execution:", error);
                  // Display error to user if DOM init failed
                  document.body.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">שגיאה קריטית בטעינת המשחק (${error.message}). נסה לרענן את הדף.</div>`;
              }
          });

      } catch (error) {
          // Catch any synchronous error during script setup
          console.error("TriviBIO: Critical error during script execution:", error);
          // Attempt to display a generic error message to the user
          try {
              document.body.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">אירעה שגיאה קריטית בטעינת המשחק. אנא נסה לרענן את הדף.<br><br>פרטי שגיאה: ${error.message}</div>`;
          } catch (e) {
              // Fallback if even modifying body fails
          }
      }
    </script>
  </body>
</html>
