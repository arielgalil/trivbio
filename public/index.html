
<!-- saved from url=(0024)https://trivbio.web.app/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="color-scheme" content="light dark"></head><body><div class="line-gutter-backdrop"></div><form autocomplete="off"><label class="line-wrap-control">גלישת שורות<input type="checkbox" aria-label="גלישת שורות"></label></form><table><tbody><tr><td class="line-number" value="1"></td><td class="line-content"><span class="html-doctype">&lt;!DOCTYPE html&gt;</span></td></tr><tr><td class="line-number" value="2"></td><td class="line-content"><span class="html-tag">&lt;html <span class="html-attribute-name">lang</span>="<span class="html-attribute-value">he</span>" <span class="html-attribute-name">dir</span>="<span class="html-attribute-value">rtl</span>"&gt;</span></td></tr><tr><td class="line-number" value="3"></td><td class="line-content">  <span class="html-tag">&lt;head&gt;</span></td></tr><tr><td class="line-number" value="4"></td><td class="line-content">    <span class="html-tag">&lt;meta <span class="html-attribute-name">charset</span>="<span class="html-attribute-value">UTF-8</span>" /&gt;</span></td></tr><tr><td class="line-number" value="5"></td><td class="line-content">    <span class="html-tag">&lt;meta <span class="html-attribute-name">name</span>="<span class="html-attribute-value">viewport</span>" <span class="html-attribute-name">content</span>="<span class="html-attribute-value">width=device-width, initial-scale=1.0</span>" /&gt;</span></td></tr><tr><td class="line-number" value="6"></td><td class="line-content">    <span class="html-tag">&lt;title&gt;</span>טריווBIO - משחק טריוויה בביולוגיה<span class="html-tag">&lt;/title&gt;</span></td></tr><tr><td class="line-number" value="7"></td><td class="line-content">    <span class="html-tag">&lt;link <span class="html-attribute-name">rel</span>="<span class="html-attribute-value">preconnect</span>" <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://fonts.googleapis.com/" rel="noreferrer noopener">https://fonts.googleapis.com</a>"&gt;</span></td></tr><tr><td class="line-number" value="8"></td><td class="line-content"><span class="html-tag">&lt;link <span class="html-attribute-name">rel</span>="<span class="html-attribute-value">preconnect</span>" <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://fonts.gstatic.com/" rel="noreferrer noopener">https://fonts.gstatic.com</a>" <span class="html-attribute-name">crossorigin</span>&gt;</span></td></tr><tr><td class="line-number" value="9"></td><td class="line-content"><span class="html-tag">&lt;link <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@400;700&amp;display=swap" rel="noreferrer noopener">https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@400;700&amp;display=swap</a>" <span class="html-attribute-name">rel</span>="<span class="html-attribute-value">stylesheet</span>"&gt;</span></td></tr><tr><td class="line-number" value="10"></td><td class="line-content">    <span class="html-tag">&lt;style&gt;</span></td></tr><tr><td class="line-number" value="11"></td><td class="line-content">      /* --- Previous styles remain the same --- */</td></tr><tr><td class="line-number" value="12"></td><td class="line-content">      body {</td></tr><tr><td class="line-number" value="13"></td><td class="line-content">        font-family: "Noto Sans Hebrew", sans-serif;</td></tr><tr><td class="line-number" value="14"></td><td class="line-content">        background-color: #f5f7fa;</td></tr><tr><td class="line-number" value="15"></td><td class="line-content">        color: #2d3748;</td></tr><tr><td class="line-number" value="16"></td><td class="line-content">        margin: 0;</td></tr><tr><td class="line-number" value="17"></td><td class="line-content">        padding: 0;</td></tr><tr><td class="line-number" value="18"></td><td class="line-content">        transition: background-color 0.3s, color 0.3s;</td></tr><tr><td class="line-number" value="19"></td><td class="line-content">        display: grid;</td></tr><tr><td class="line-number" value="20"></td><td class="line-content">        grid-template-rows: auto 1fr auto; /* Adjusted for header */</td></tr><tr><td class="line-number" value="21"></td><td class="line-content">        min-height: 100svh;</td></tr><tr><td class="line-number" value="22"></td><td class="line-content">        position: relative; /* Needed for score popup positioning */</td></tr><tr><td class="line-number" value="23"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="24"></td><td class="line-content">      .dark-mode {</td></tr><tr><td class="line-number" value="25"></td><td class="line-content">        background-color: #1a202c;</td></tr><tr><td class="line-number" value="26"></td><td class="line-content">        color: #e2e8f0;</td></tr><tr><td class="line-number" value="27"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="28"></td><td class="line-content">      .container {</td></tr><tr><td class="line-number" value="29"></td><td class="line-content">        max-width: 800px;</td></tr><tr><td class="line-number" value="30"></td><td class="line-content">        margin: 10px auto;</td></tr><tr><td class="line-number" value="31"></td><td class="line-content">        padding: 10px;</td></tr><tr><td class="line-number" value="32"></td><td class="line-content">        text-align: center;</td></tr><tr><td class="line-number" value="33"></td><td class="line-content">        width: 100%;</td></tr><tr><td class="line-number" value="34"></td><td class="line-content">        box-sizing: border-box;</td></tr><tr><td class="line-number" value="35"></td><td class="line-content">        grid-row: 2 / 3; /* Place container in the main grid area */</td></tr><tr><td class="line-number" value="36"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="37"></td><td class="line-content">      header {</td></tr><tr><td class="line-number" value="38"></td><td class="line-content">        display: flex;</td></tr><tr><td class="line-number" value="39"></td><td class="line-content">        justify-content: center;</td></tr><tr><td class="line-number" value="40"></td><td class="line-content">        align-items: center;</td></tr><tr><td class="line-number" value="41"></td><td class="line-content">        position: relative;</td></tr><tr><td class="line-number" value="42"></td><td class="line-content">        margin-bottom: 5px; /* Reduced margin */</td></tr><tr><td class="line-number" value="43"></td><td class="line-content">        padding: 10px 0; /* Add padding */</td></tr><tr><td class="line-number" value="44"></td><td class="line-content">        grid-row: 1 / 2; /* Place header in the top grid area */</td></tr><tr><td class="line-number" value="45"></td><td class="line-content">        width: 100%; /* Ensure header takes full width */</td></tr><tr><td class="line-number" value="46"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="47"></td><td class="line-content">      h1 {</td></tr><tr><td class="line-number" value="48"></td><td class="line-content">        font-size: 2rem;</td></tr><tr><td class="line-number" value="49"></td><td class="line-content">        margin: 0;</td></tr><tr><td class="line-number" value="50"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="51"></td><td class="line-content">      .switch {</td></tr><tr><td class="line-number" value="52"></td><td class="line-content">        position: absolute;</td></tr><tr><td class="line-number" value="53"></td><td class="line-content">        right: 15px; /* Position relative to header edge */</td></tr><tr><td class="line-number" value="54"></td><td class="line-content">        top: 50%;</td></tr><tr><td class="line-number" value="55"></td><td class="line-content">        transform: translateY(-50%);</td></tr><tr><td class="line-number" value="56"></td><td class="line-content">        display: inline-block;</td></tr><tr><td class="line-number" value="57"></td><td class="line-content">        width: 60px;</td></tr><tr><td class="line-number" value="58"></td><td class="line-content">        height: 34px;</td></tr><tr><td class="line-number" value="59"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="60"></td><td class="line-content">      .switch input {</td></tr><tr><td class="line-number" value="61"></td><td class="line-content">        opacity: 0;</td></tr><tr><td class="line-number" value="62"></td><td class="line-content">        width: 0;</td></tr><tr><td class="line-number" value="63"></td><td class="line-content">        height: 0;</td></tr><tr><td class="line-number" value="64"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="65"></td><td class="line-content">      .slider {</td></tr><tr><td class="line-number" value="66"></td><td class="line-content">        position: absolute;</td></tr><tr><td class="line-number" value="67"></td><td class="line-content">        cursor: pointer;</td></tr><tr><td class="line-number" value="68"></td><td class="line-content">        top: 0;</td></tr><tr><td class="line-number" value="69"></td><td class="line-content">        left: 0;</td></tr><tr><td class="line-number" value="70"></td><td class="line-content">        right: 0;</td></tr><tr><td class="line-number" value="71"></td><td class="line-content">        bottom: 0;</td></tr><tr><td class="line-number" value="72"></td><td class="line-content">        background-color: #ccc;</td></tr><tr><td class="line-number" value="73"></td><td class="line-content">        transition: 0.4s;</td></tr><tr><td class="line-number" value="74"></td><td class="line-content">        border-radius: 34px;</td></tr><tr><td class="line-number" value="75"></td><td class="line-content">        display: flex;</td></tr><tr><td class="line-number" value="76"></td><td class="line-content">        align-items: center;</td></tr><tr><td class="line-number" value="77"></td><td class="line-content">        justify-content: space-between;</td></tr><tr><td class="line-number" value="78"></td><td class="line-content">        padding: 0 5px;</td></tr><tr><td class="line-number" value="79"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="80"></td><td class="line-content">      .slider:before {</td></tr><tr><td class="line-number" value="81"></td><td class="line-content">        position: absolute;</td></tr><tr><td class="line-number" value="82"></td><td class="line-content">        content: "";</td></tr><tr><td class="line-number" value="83"></td><td class="line-content">        height: 26px;</td></tr><tr><td class="line-number" value="84"></td><td class="line-content">        width: 26px;</td></tr><tr><td class="line-number" value="85"></td><td class="line-content">        left: 4px;</td></tr><tr><td class="line-number" value="86"></td><td class="line-content">        bottom: 4px;</td></tr><tr><td class="line-number" value="87"></td><td class="line-content">        background-color: white;</td></tr><tr><td class="line-number" value="88"></td><td class="line-content">        transition: 0.4s;</td></tr><tr><td class="line-number" value="89"></td><td class="line-content">        border-radius: 50%;</td></tr><tr><td class="line-number" value="90"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="91"></td><td class="line-content">      input:checked + .slider {</td></tr><tr><td class="line-number" value="92"></td><td class="line-content">        background-color: #7f9cf5;</td></tr><tr><td class="line-number" value="93"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="94"></td><td class="line-content">      .dark-mode input:checked + .slider {</td></tr><tr><td class="line-number" value="95"></td><td class="line-content">        background-color: #4299e1;</td></tr><tr><td class="line-number" value="96"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="97"></td><td class="line-content">      input:checked + .slider:before {</td></tr><tr><td class="line-number" value="98"></td><td class="line-content">        transform: translateX(26px);</td></tr><tr><td class="line-number" value="99"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="100"></td><td class="line-content">      .theme-icon {</td></tr><tr><td class="line-number" value="101"></td><td class="line-content">        width: 20px;</td></tr><tr><td class="line-number" value="102"></td><td class="line-content">        height: 20px;</td></tr><tr><td class="line-number" value="103"></td><td class="line-content">        transition: opacity 0.4s;</td></tr><tr><td class="line-number" value="104"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="105"></td><td class="line-content">      .sun { opacity: 1; }</td></tr><tr><td class="line-number" value="106"></td><td class="line-content">      .moon { opacity: 0; }</td></tr><tr><td class="line-number" value="107"></td><td class="line-content">      input:checked + .slider .sun { opacity: 0; }</td></tr><tr><td class="line-number" value="108"></td><td class="line-content">      input:checked + .slider .moon { opacity: 1; }</td></tr><tr><td class="line-number" value="109"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="110"></td><td class="line-content">      /* --- Score Display near Header --- */</td></tr><tr><td class="line-number" value="111"></td><td class="line-content">      #cumulative-score-display {</td></tr><tr><td class="line-number" value="112"></td><td class="line-content">        position: absolute;</td></tr><tr><td class="line-number" value="113"></td><td class="line-content">        left: 15px;</td></tr><tr><td class="line-number" value="114"></td><td class="line-content">        top: 50%;</td></tr><tr><td class="line-number" value="115"></td><td class="line-content">        transform: translateY(-50%);</td></tr><tr><td class="line-number" value="116"></td><td class="line-content">        font-size: 0.9rem;</td></tr><tr><td class="line-number" value="117"></td><td class="line-content">        font-weight: bold;</td></tr><tr><td class="line-number" value="118"></td><td class="line-content">        color: #4a5568;</td></tr><tr><td class="line-number" value="119"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="120"></td><td class="line-content">      .dark-mode #cumulative-score-display {</td></tr><tr><td class="line-number" value="121"></td><td class="line-content">        color: #a0aec0;</td></tr><tr><td class="line-number" value="122"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="123"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="124"></td><td class="line-content">      #start-screen {</td></tr><tr><td class="line-number" value="125"></td><td class="line-content">        background: linear-gradient(135deg, #a3bffa, #e2e8f0);</td></tr><tr><td class="line-number" value="126"></td><td class="line-content">        padding: 30px;</td></tr><tr><td class="line-number" value="127"></td><td class="line-content">        border-radius: 15px;</td></tr><tr><td class="line-number" value="128"></td><td class="line-content">        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);</td></tr><tr><td class="line-number" value="129"></td><td class="line-content">        margin: 10px 0; /* Adjusted margin */</td></tr><tr><td class="line-number" value="130"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="131"></td><td class="line-content">      .dark-mode #start-screen {</td></tr><tr><td class="line-number" value="132"></td><td class="line-content">        background: linear-gradient(135deg, #2d3748, #1a202c);</td></tr><tr><td class="line-number" value="133"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="134"></td><td class="line-content">      #start-screen h2 {</td></tr><tr><td class="line-number" value="135"></td><td class="line-content">        color: #2d3748; font-size: 1.5rem; margin: 10px 0;</td></tr><tr><td class="line-number" value="136"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="137"></td><td class="line-content">      .dark-mode #start-screen h2 { color: #e2e8f0; }</td></tr><tr><td class="line-number" value="138"></td><td class="line-content">      #start-screen p {</td></tr><tr><td class="line-number" value="139"></td><td class="line-content">        font-size: 1.1rem; line-height: 1.5; margin: 20px 0; color: #2d3748;</td></tr><tr><td class="line-number" value="140"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="141"></td><td class="line-content">      .dark-mode #start-screen p { color: #e2e8f0; }</td></tr><tr><td class="line-number" value="142"></td><td class="line-content">      #start-screen-buttons {</td></tr><tr><td class="line-number" value="143"></td><td class="line-content">        display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;</td></tr><tr><td class="line-number" value="144"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="145"></td><td class="line-content">      @media (max-width: 600px) { #start-screen-buttons { grid-template-columns: 1fr; } }</td></tr><tr><td class="line-number" value="146"></td><td class="line-content">      .topic-btn {</td></tr><tr><td class="line-number" value="147"></td><td class="line-content">        display: flex; align-items: center; justify-content: center; gap: 5px;</td></tr><tr><td class="line-number" value="148"></td><td class="line-content">        background-color: #a3bffa; color: white; border: none; padding: 10px 20px;</td></tr><tr><td class="line-number" value="149"></td><td class="line-content">        border-radius: 10px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s;</td></tr><tr><td class="line-number" value="150"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="151"></td><td class="line-content">      .topic-btn:hover { background-color: #7f9cf5; }</td></tr><tr><td class="line-number" value="152"></td><td class="line-content">      .dark-mode .topic-btn { background-color: #4a5568; color: #e2e8f0; }</td></tr><tr><td class="line-number" value="153"></td><td class="line-content">      .dark-mode .topic-btn:hover { background-color: #2d3748; }</td></tr><tr><td class="line-number" value="154"></td><td class="line-content">      .question-count { font-size: 0.8rem; opacity: 0.8; }</td></tr><tr><td class="line-number" value="155"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="156"></td><td class="line-content">      #game-screen, #result-screen { margin-top: 10px; } /* Adjusted margin */</td></tr><tr><td class="line-number" value="157"></td><td class="line-content">      #status-row {</td></tr><tr><td class="line-number" value="158"></td><td class="line-content">        display: flex; justify-content: space-between; align-items: center;</td></tr><tr><td class="line-number" value="159"></td><td class="line-content">        margin: 15px 0; /* Adjusted margin */ height: 60px;</td></tr><tr><td class="line-number" value="160"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="161"></td><td class="line-content">      .status-circle-container { position: relative; width: 54px; height: 54px; }</td></tr><tr><td class="line-number" value="162"></td><td class="line-content">      .status-circle-text {</td></tr><tr><td class="line-number" value="163"></td><td class="line-content">        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);</td></tr><tr><td class="line-number" value="164"></td><td class="line-content">        font-weight: bold; font-size: 1rem;</td></tr><tr><td class="line-number" value="165"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="166"></td><td class="line-content">      .status-circle-bg { stroke: #e2e8f0; transition: stroke 0.3s; }</td></tr><tr><td class="line-number" value="167"></td><td class="line-content">      .dark-mode .status-circle-bg { stroke: #4a5568; }</td></tr><tr><td class="line-number" value="168"></td><td class="line-content">      .status-circle-progress {</td></tr><tr><td class="line-number" value="169"></td><td class="line-content">        transition: stroke-dashoffset 0.5s linear, stroke 0.5s linear;</td></tr><tr><td class="line-number" value="170"></td><td class="line-content">        transform: rotate(-90deg); transform-origin: 50% 50%;</td></tr><tr><td class="line-number" value="171"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="172"></td><td class="line-content">      #timer-progress { stroke: #7f9cf5; }</td></tr><tr><td class="line-number" value="173"></td><td class="line-content">      .dark-mode #timer-progress { stroke: #4299e1; }</td></tr><tr><td class="line-number" value="174"></td><td class="line-content">      #percentage-progress.green { stroke: #48bb78; }</td></tr><tr><td class="line-number" value="175"></td><td class="line-content">      #percentage-progress.yellow { stroke: #ecc94b; }</td></tr><tr><td class="line-number" value="176"></td><td class="line-content">      #percentage-progress.red { stroke: #f56565; }</td></tr><tr><td class="line-number" value="177"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="178"></td><td class="line-content">      #question { font-size: 1.25rem; margin: 20px 0; line-height: 1.4; }</td></tr><tr><td class="line-number" value="179"></td><td class="line-content">      .question-id-display {</td></tr><tr><td class="line-number" value="180"></td><td class="line-content">        display: inline-block; font-size: 0.7rem; color: #a0aec0; margin-right: 8px;</td></tr><tr><td class="line-number" value="181"></td><td class="line-content">        opacity: 0.8; user-select: text; direction: ltr;</td></tr><tr><td class="line-number" value="182"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="183"></td><td class="line-content">      .dark-mode .question-id-display { color: #718096; }</td></tr><tr><td class="line-number" value="184"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="185"></td><td class="line-content">      #answers { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }</td></tr><tr><td class="line-number" value="186"></td><td class="line-content">      .answer-btn {</td></tr><tr><td class="line-number" value="187"></td><td class="line-content">        padding: 15px; text-align: center; font-size: 1rem; background-color: #e2e8f0;</td></tr><tr><td class="line-number" value="188"></td><td class="line-content">        border: none; border-radius: 15px; cursor: pointer;</td></tr><tr><td class="line-number" value="189"></td><td class="line-content">        transition: background-color 0.3s, transform 0.1s, visibility 0s, opacity 0.3s; /* Added opacity/visibility transition */</td></tr><tr><td class="line-number" value="190"></td><td class="line-content">        display: flex; align-items: center; justify-content: center;</td></tr><tr><td class="line-number" value="191"></td><td class="line-content">        -webkit-tap-highlight-color: transparent;</td></tr><tr><td class="line-number" value="192"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="193"></td><td class="line-content">      .dark-mode .answer-btn { background-color: #4a5568; color: #e2e8f0; }</td></tr><tr><td class="line-number" value="194"></td><td class="line-content">      .answer-btn:hover { background-color: #cbd5e0; }</td></tr><tr><td class="line-number" value="195"></td><td class="line-content">      .dark-mode .answer-btn:hover { background-color: #718096; }</td></tr><tr><td class="line-number" value="196"></td><td class="line-content">      .answer-btn:active { transform: scale(0.95); }</td></tr><tr><td class="line-number" value="197"></td><td class="line-content">      .correct { background-color: #48bb78 !important; color: white !important; }</td></tr><tr><td class="line-number" value="198"></td><td class="line-content">      .wrong { background-color: #f56565 !important; color: white !important; }</td></tr><tr><td class="line-number" value="199"></td><td class="line-content">      .answer-btn:focus { outline: none; }</td></tr><tr><td class="line-number" value="200"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="201"></td><td class="line-content">      #game-buttons { margin: 25px 0; }</td></tr><tr><td class="line-number" value="202"></td><td class="line-content">      #game-buttons button {</td></tr><tr><td class="line-number" value="203"></td><td class="line-content">        width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer;</td></tr><tr><td class="line-number" value="204"></td><td class="line-content">        background-color: #a3bffa; color: white;</td></tr><tr><td class="line-number" value="205"></td><td class="line-content">        transition: background-color 0.3s, opacity 0.3s, transform 0.1s;</td></tr><tr><td class="line-number" value="206"></td><td class="line-content">        display: inline-flex; align-items: center; justify-content: center;</td></tr><tr><td class="line-number" value="207"></td><td class="line-content">        font-size: 1rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin: 0 5px;</td></tr><tr><td class="line-number" value="208"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="209"></td><td class="line-content">      #game-buttons button:hover { background-color: #7f9cf5; transform: translateY(-1px); }</td></tr><tr><td class="line-number" value="210"></td><td class="line-content">      #game-buttons button:active { transform: scale(0.95); box-shadow: none; }</td></tr><tr><td class="line-number" value="211"></td><td class="line-content">      .disabled {</td></tr><tr><td class="line-number" value="212"></td><td class="line-content">        background-color: #cbd5e0 !important; color: #a0aec0 !important; cursor: not-allowed;</td></tr><tr><td class="line-number" value="213"></td><td class="line-content">        opacity: 0.7; box-shadow: none !important; transform: none !important;</td></tr><tr><td class="line-number" value="214"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="215"></td><td class="line-content">      .dark-mode #game-buttons button { background-color: #2d3748; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }</td></tr><tr><td class="line-number" value="216"></td><td class="line-content">      .dark-mode #game-buttons button:hover { background-color: #1a202c; }</td></tr><tr><td class="line-number" value="217"></td><td class="line-content">      .dark-mode .disabled { background-color: #4a5568 !important; color: #718096 !important; opacity: 0.6; }</td></tr><tr><td class="line-number" value="218"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="219"></td><td class="line-content">      .result-card {</td></tr><tr><td class="line-number" value="220"></td><td class="line-content">        background-color: #fff; padding: 12px 20px; margin: 10px 0; border-radius: 10px;</td></tr><tr><td class="line-number" value="221"></td><td class="line-content">        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);</td></tr><tr><td class="line-number" value="222"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="223"></td><td class="line-content">      .dark-mode .result-card { background-color: #2d3748; border: 1px solid #4a5568; }</td></tr><tr><td class="line-number" value="224"></td><td class="line-content">      .progress-circle { position: relative; display: inline-block; width: 60px; height: 60px; margin-left: 15px; vertical-align: middle;}</td></tr><tr><td class="line-number" value="225"></td><td class="line-content">      #percentage-text-result { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; }</td></tr><tr><td class="line-number" value="226"></td><td class="line-content">      .highlight { color: #7f9cf5; font-weight: bold; }</td></tr><tr><td class="line-number" value="227"></td><td class="line-content">      .dark-mode .highlight { color: #63b3ed; }</td></tr><tr><td class="line-number" value="228"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="229"></td><td class="line-content">      .toast {</td></tr><tr><td class="line-number" value="230"></td><td class="line-content">        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);</td></tr><tr><td class="line-number" value="231"></td><td class="line-content">        background-color: #2d3748; color: white; padding: 10px 20px; border-radius: 5px;</td></tr><tr><td class="line-number" value="232"></td><td class="line-content">        opacity: 0; transition: opacity 0.5s; z-index: 1000; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);</td></tr><tr><td class="line-number" value="233"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="234"></td><td class="line-content">      .toast.show { opacity: 1; }</td></tr><tr><td class="line-number" value="235"></td><td class="line-content">      .dark-mode .toast { background-color: #e2e8f0; color: #2d3748; }</td></tr><tr><td class="line-number" value="236"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="237"></td><td class="line-content">      footer { margin-top: 20px; padding-bottom: 20px; font-size: 0.9rem; text-align: center; grid-row: 3 / 4; } /* Place footer */</td></tr><tr><td class="line-number" value="238"></td><td class="line-content">      footer a { color: #5a67d8; text-decoration: none; margin: 0 2px; }</td></tr><tr><td class="line-number" value="239"></td><td class="line-content">      .dark-mode footer a { color: #63b3ed; }</td></tr><tr><td class="line-number" value="240"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="241"></td><td class="line-content">      .sequence-circle {</td></tr><tr><td class="line-number" value="242"></td><td class="line-content">        width: 30px; height: 30px; line-height: 30px; border-radius: 50%; background-color: #e2e8f0;</td></tr><tr><td class="line-number" value="243"></td><td class="line-content">        border: 1px solid #cbd5e0; margin: 0 5px; display: inline-flex; justify-content: center;</td></tr><tr><td class="line-number" value="244"></td><td class="line-content">        align-items: center; font-size: 0.9rem; transition: background-color 0.3s, border-color 0.3s, color 0.3s;</td></tr><tr><td class="line-number" value="245"></td><td class="line-content">        color: #4a5568;</td></tr><tr><td class="line-number" value="246"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="247"></td><td class="line-content">      .dark-mode .sequence-circle { background-color: #4a5568; border: 1px solid #718096; color: #e2e8f0; }</td></tr><tr><td class="line-number" value="248"></td><td class="line-content">      .sequence-circle.correct { background-color: #48bb78; color: white; border-color: #48bb78; }</td></tr><tr><td class="line-number" value="249"></td><td class="line-content">      .sequence-circle.wrong { background-color: #f56565; color: white; border-color: #f56565; }</td></tr><tr><td class="line-number" value="250"></td><td class="line-content">      .sequence-circle.current { background-color: #ecc94b; color: #744210; font-weight: bold; border-color: #d69e2e; }</td></tr><tr><td class="line-number" value="251"></td><td class="line-content">      .dark-mode .sequence-circle.current { background-color: #ecc94b; color: #744210; font-weight: bold; border-color: #d69e2e; }</td></tr><tr><td class="line-number" value="252"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="253"></td><td class="line-content">      .mistake-block {</td></tr><tr><td class="line-number" value="254"></td><td class="line-content">        text-align: right; margin: 15px 0; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;</td></tr><tr><td class="line-number" value="255"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="256"></td><td class="line-content">      .dark-mode .mistake-block { border-bottom: 1px solid #4a5568; }</td></tr><tr><td class="line-number" value="257"></td><td class="line-content">      .mistake-block:last-child { border-bottom: none; }</td></tr><tr><td class="line-number" value="258"></td><td class="line-content">      .mistake-question { font-weight: bold; margin-bottom: 5px; }</td></tr><tr><td class="line-number" value="259"></td><td class="line-content">      .wrong-answer { color: #f56565; margin-bottom: 3px; }</td></tr><tr><td class="line-number" value="260"></td><td class="line-content">      .correct-answer { color: #48bb78; }</td></tr><tr><td class="line-number" value="261"></td><td class="line-content">      .perfect { color: #48bb78; font-weight: bold; font-size: 1.1rem; }</td></tr><tr><td class="line-number" value="262"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="263"></td><td class="line-content">      #tag-analysis { margin-top: 15px; line-height: 2; text-align: right; }</td></tr><tr><td class="line-number" value="264"></td><td class="line-content">      .tag-cloud-item {</td></tr><tr><td class="line-number" value="265"></td><td class="line-content">        display: inline-block; margin: 3px 4px; padding: 2px 8px; border-radius: 4px;</td></tr><tr><td class="line-number" value="266"></td><td class="line-content">        font-size: 0.8rem; border: 1px solid; cursor: pointer;</td></tr><tr><td class="line-number" value="267"></td><td class="line-content">        transition: transform 0.2s; white-space: nowrap; text-decoration: none;</td></tr><tr><td class="line-number" value="268"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="269"></td><td class="line-content">      .tag-cloud-item:hover { transform: translateY(-1px); text-decoration: none; }</td></tr><tr><td class="line-number" value="270"></td><td class="line-content">      .tag-cloud-item:visited { color: inherit; }</td></tr><tr><td class="line-number" value="271"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="272"></td><td class="line-content">      .result-buttons { margin-top: 20px; display: flex; justify-content: center; gap: 15px; }</td></tr><tr><td class="line-number" value="273"></td><td class="line-content">      .result-buttons button {</td></tr><tr><td class="line-number" value="274"></td><td class="line-content">        padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer;</td></tr><tr><td class="line-number" value="275"></td><td class="line-content">        font-size: 1rem; transition: background-color 0.3s;</td></tr><tr><td class="line-number" value="276"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="277"></td><td class="line-content">      #share-result { background-color: #48bb78; color: white; }</td></tr><tr><td class="line-number" value="278"></td><td class="line-content">      #share-result:hover { background-color: #38a169; }</td></tr><tr><td class="line-number" value="279"></td><td class="line-content">      #restart { background-color: #7f9cf5; color: white; }</td></tr><tr><td class="line-number" value="280"></td><td class="line-content">      #restart:hover { background-color: #5a67d8; }</td></tr><tr><td class="line-number" value="281"></td><td class="line-content">      .dark-mode #share-result { background-color: #68d391; }</td></tr><tr><td class="line-number" value="282"></td><td class="line-content">      .dark-mode #share-result:hover { background-color: #48bb78; }</td></tr><tr><td class="line-number" value="283"></td><td class="line-content">      .dark-mode #restart { background-color: #63b3ed; }</td></tr><tr><td class="line-number" value="284"></td><td class="line-content">      .dark-mode #restart:hover { background-color: #4299e1; }</td></tr><tr><td class="line-number" value="285"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="286"></td><td class="line-content">      #result-progress-circle.green { stroke: #48bb78; }</td></tr><tr><td class="line-number" value="287"></td><td class="line-content">      #result-progress-circle.yellow { stroke: #ecc94b; }</td></tr><tr><td class="line-number" value="288"></td><td class="line-content">      #result-progress-circle.red { stroke: #f56565; }</td></tr><tr><td class="line-number" value="289"></td><td class="line-content">      #result-progress-circle { transition: stroke-dashoffset 0.5s linear, stroke 0.5s linear; }</td></tr><tr><td class="line-number" value="290"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="291"></td><td class="line-content">      /* --- Ranking List Style --- */</td></tr><tr><td class="line-number" value="292"></td><td class="line-content">      #ranking ul, #overall-ranking ul {</td></tr><tr><td class="line-number" value="293"></td><td class="line-content">        list-style: none; padding: 0; margin: 10px 0 0 0; text-align: right;</td></tr><tr><td class="line-number" value="294"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="295"></td><td class="line-content">       #ranking li, #overall-ranking li {</td></tr><tr><td class="line-number" value="296"></td><td class="line-content">        padding: 5px 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.9rem;</td></tr><tr><td class="line-number" value="297"></td><td class="line-content">        display: flex; justify-content: space-between; align-items: center;</td></tr><tr><td class="line-number" value="298"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="299"></td><td class="line-content">       #ranking li:last-child, #overall-ranking li:last-child { border-bottom: none; }</td></tr><tr><td class="line-number" value="300"></td><td class="line-content">      .dark-mode #ranking li, .dark-mode #overall-ranking li { border-bottom-color: #4a5568; }</td></tr><tr><td class="line-number" value="301"></td><td class="line-content">       #ranking li.current-player, #overall-ranking li.current-player { font-weight: bold; color: #7f9cf5; }</td></tr><tr><td class="line-number" value="302"></td><td class="line-content">       .dark-mode #ranking li.current-player, .dark-mode #overall-ranking li.current-player { color: #63b3ed; }</td></tr><tr><td class="line-number" value="303"></td><td class="line-content">       #ranking .rank-score, #overall-ranking .rank-score { font-weight: bold; direction: ltr; margin-left: 10px; } /* Ensure score is LTR */</td></tr><tr><td class="line-number" value="304"></td><td class="line-content">       #ranking .rank-number, #overall-ranking .rank-number { margin-right: 10px; color: #a0aec0; min-width: 25px; text-align: center;}</td></tr><tr><td class="line-number" value="305"></td><td class="line-content">       .dark-mode #ranking .rank-number, .dark-mode #overall-ranking .rank-number { color: #718096; }</td></tr><tr><td class="line-number" value="306"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="307"></td><td class="line-content">      /* --- Score Popup Style --- */</td></tr><tr><td class="line-number" value="308"></td><td class="line-content">      .score-popup {</td></tr><tr><td class="line-number" value="309"></td><td class="line-content">        position: fixed;</td></tr><tr><td class="line-number" value="310"></td><td class="line-content">        top: 40%; /* Adjust as needed */</td></tr><tr><td class="line-number" value="311"></td><td class="line-content">        left: 50%;</td></tr><tr><td class="line-number" value="312"></td><td class="line-content">        transform: translateX(-50%);</td></tr><tr><td class="line-number" value="313"></td><td class="line-content">        background-color: rgba(72, 187, 120, 0.9); /* Green background */</td></tr><tr><td class="line-number" value="314"></td><td class="line-content">        color: white;</td></tr><tr><td class="line-number" value="315"></td><td class="line-content">        padding: 8px 15px;</td></tr><tr><td class="line-number" value="316"></td><td class="line-content">        border-radius: 20px;</td></tr><tr><td class="line-number" value="317"></td><td class="line-content">        font-size: 1.4rem;</td></tr><tr><td class="line-number" value="318"></td><td class="line-content">        font-weight: bold;</td></tr><tr><td class="line-number" value="319"></td><td class="line-content">        z-index: 1001;</td></tr><tr><td class="line-number" value="320"></td><td class="line-content">        opacity: 0;</td></tr><tr><td class="line-number" value="321"></td><td class="line-content">        transition: opacity 0.5s ease-out, transform 0.6s ease-out;</td></tr><tr><td class="line-number" value="322"></td><td class="line-content">        pointer-events: none; /* Prevent interaction */</td></tr><tr><td class="line-number" value="323"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="324"></td><td class="line-content">      .score-popup.show {</td></tr><tr><td class="line-number" value="325"></td><td class="line-content">        opacity: 1;</td></tr><tr><td class="line-number" value="326"></td><td class="line-content">        transform: translate(-50%, -50px); /* Move up */</td></tr><tr><td class="line-number" value="327"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="328"></td><td class="line-content">      .dark-mode .score-popup {</td></tr><tr><td class="line-number" value="329"></td><td class="line-content">          background-color: rgba(104, 211, 145, 0.9); /* Lighter green for dark mode */</td></tr><tr><td class="line-number" value="330"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="331"></td><td class="line-content">    <span class="html-tag">&lt;/style&gt;</span></td></tr><tr><td class="line-number" value="332"></td><td class="line-content">  <span class="html-tag">&lt;/head&gt;</span></td></tr><tr><td class="line-number" value="333"></td><td class="line-content">  <span class="html-tag">&lt;body&gt;</span></td></tr><tr><td class="line-number" value="334"></td><td class="line-content">    <span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="335"></td><td class="line-content">      // Immediately set dark mode if needed to prevent flash</td></tr><tr><td class="line-number" value="336"></td><td class="line-content">      if (localStorage.getItem("darkMode") === "true") {</td></tr><tr><td class="line-number" value="337"></td><td class="line-content">        document.body.classList.add("dark-mode");</td></tr><tr><td class="line-number" value="338"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="339"></td><td class="line-content">    <span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="340"></td><td class="line-content">    <span class="html-comment">&lt;!-- Moved container to wrap main content only --&gt;</span></td></tr><tr><td class="line-number" value="341"></td><td class="line-content">    <span class="html-tag">&lt;header&gt;</span></td></tr><tr><td class="line-number" value="342"></td><td class="line-content">        <span class="html-tag">&lt;h1&gt;</span>טריווBIO<span class="html-tag">&lt;/h1&gt;</span></td></tr><tr><td class="line-number" value="343"></td><td class="line-content">        <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">cumulative-score-display</span>"&gt;</span>טוען ניקוד...<span class="html-tag">&lt;/div&gt;</span> <span class="html-comment">&lt;!-- Score Display Added --&gt;</span></td></tr><tr><td class="line-number" value="344"></td><td class="line-content">        <span class="html-tag">&lt;label <span class="html-attribute-name">class</span>="<span class="html-attribute-value">switch</span>"&gt;</span></td></tr><tr><td class="line-number" value="345"></td><td class="line-content">          <span class="html-tag">&lt;input <span class="html-attribute-name">type</span>="<span class="html-attribute-value">checkbox</span>" <span class="html-attribute-name">id</span>="<span class="html-attribute-value">theme-toggle</span>" /&gt;</span></td></tr><tr><td class="line-number" value="346"></td><td class="line-content">          <span class="html-tag">&lt;span <span class="html-attribute-name">class</span>="<span class="html-attribute-value">slider</span>"&gt;</span></td></tr><tr><td class="line-number" value="347"></td><td class="line-content">            <span class="html-tag">&lt;img</span></td></tr><tr><td class="line-number" value="348"></td><td class="line-content">              <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://img.icons8.com/ios-glyphs/30/ffffff/sun.png" rel="noreferrer noopener">https://img.icons8.com/ios-glyphs/30/ffffff/sun.png</a>"</td></tr><tr><td class="line-number" value="349"></td><td class="line-content">              <span class="html-attribute-name">alt</span>="<span class="html-attribute-value">שמש</span>"</td></tr><tr><td class="line-number" value="350"></td><td class="line-content">              <span class="html-attribute-name">class</span>="<span class="html-attribute-value">theme-icon sun</span>"</td></tr><tr><td class="line-number" value="351"></td><td class="line-content">            /&gt;</td></tr><tr><td class="line-number" value="352"></td><td class="line-content">            <span class="html-tag">&lt;img</span></td></tr><tr><td class="line-number" value="353"></td><td class="line-content">              <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://img.icons8.com/ios-glyphs/30/ffffff/moon-symbol.png" rel="noreferrer noopener">https://img.icons8.com/ios-glyphs/30/ffffff/moon-symbol.png</a>"</td></tr><tr><td class="line-number" value="354"></td><td class="line-content">              <span class="html-attribute-name">alt</span>="<span class="html-attribute-value">ירח</span>"</td></tr><tr><td class="line-number" value="355"></td><td class="line-content">              <span class="html-attribute-name">class</span>="<span class="html-attribute-value">theme-icon moon</span>"</td></tr><tr><td class="line-number" value="356"></td><td class="line-content">            /&gt;</td></tr><tr><td class="line-number" value="357"></td><td class="line-content">          <span class="html-tag">&lt;/span&gt;</span></td></tr><tr><td class="line-number" value="358"></td><td class="line-content">        <span class="html-tag">&lt;/label&gt;</span></td></tr><tr><td class="line-number" value="359"></td><td class="line-content">    <span class="html-tag">&lt;/header&gt;</span></td></tr><tr><td class="line-number" value="360"></td><td class="line-content">    <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">container</span>"&gt;</span></td></tr><tr><td class="line-number" value="361"></td><td class="line-content">      <span class="html-tag">&lt;main&gt;</span></td></tr><tr><td class="line-number" value="362"></td><td class="line-content">        <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">start-screen</span>"&gt;</span></td></tr><tr><td class="line-number" value="363"></td><td class="line-content">          <span class="html-tag">&lt;h2&gt;</span>מוכן לבחור נושא?<span class="html-tag">&lt;/h2&gt;</span></td></tr><tr><td class="line-number" value="364"></td><td class="line-content">          <span class="html-tag">&lt;p&gt;</span></td></tr><tr><td class="line-number" value="365"></td><td class="line-content">            הדרך הכי טובה ללמוד לבגרות בביולוגיה? פשוט לשחק!</td></tr><tr><td class="line-number" value="366"></td><td class="line-content">            <span class="html-tag">&lt;br /&gt;</span>ככל שתענו על יותר שאלות – תבינו, תזכרו ותנצחו את הבחינה.</td></tr><tr><td class="line-number" value="367"></td><td class="line-content">            <span class="html-tag">&lt;br /&gt;</span>טריווBIO הוא הדרך הכי כיפית, חכמה וממוקדת להתכונן.</td></tr><tr><td class="line-number" value="368"></td><td class="line-content">          <span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="369"></td><td class="line-content">          <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">start-screen-buttons</span>"&gt;</span></td></tr><tr><td class="line-number" value="370"></td><td class="line-content">            <span class="html-comment">&lt;!-- Buttons will be populated by JS --&gt;</span></td></tr><tr><td class="line-number" value="371"></td><td class="line-content">          <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="372"></td><td class="line-content">        <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="373"></td><td class="line-content">        <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">game-screen</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">display: none</span>"&gt;</span></td></tr><tr><td class="line-number" value="374"></td><td class="line-content">          <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">status-row</span>"&gt;</span></td></tr><tr><td class="line-number" value="375"></td><td class="line-content">            <span class="html-comment">&lt;!-- Timer Circle --&gt;</span></td></tr><tr><td class="line-number" value="376"></td><td class="line-content">            <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">status-circle-container</span>"&gt;</span></td></tr><tr><td class="line-number" value="377"></td><td class="line-content">              <span class="html-tag">&lt;svg <span class="html-attribute-name">width</span>="<span class="html-attribute-value">53.6</span>" <span class="html-attribute-name">height</span>="<span class="html-attribute-value">53.6</span>" <span class="html-attribute-name">viewBox</span>="<span class="html-attribute-value">0 0 53.6 53.6</span>"&gt;</span></td></tr><tr><td class="line-number" value="378"></td><td class="line-content">                <span class="html-tag">&lt;circle</span></td></tr><tr><td class="line-number" value="379"></td><td class="line-content">                  <span class="html-attribute-name">class</span>="<span class="html-attribute-value">status-circle-bg</span>"</td></tr><tr><td class="line-number" value="380"></td><td class="line-content">                  <span class="html-attribute-name">cx</span>="<span class="html-attribute-value">26.8</span>"</td></tr><tr><td class="line-number" value="381"></td><td class="line-content">                  <span class="html-attribute-name">cy</span>="<span class="html-attribute-value">26.8</span>"</td></tr><tr><td class="line-number" value="382"></td><td class="line-content">                  <span class="html-attribute-name">r</span>="<span class="html-attribute-value">25.46</span>"</td></tr><tr><td class="line-number" value="383"></td><td class="line-content">                  <span class="html-attribute-name">stroke-width</span>="<span class="html-attribute-value">2.68</span>"</td></tr><tr><td class="line-number" value="384"></td><td class="line-content">                  <span class="html-attribute-name">fill</span>="<span class="html-attribute-value">none</span>"</td></tr><tr><td class="line-number" value="385"></td><td class="line-content">                /&gt;</td></tr><tr><td class="line-number" value="386"></td><td class="line-content">                <span class="html-tag">&lt;circle</span></td></tr><tr><td class="line-number" value="387"></td><td class="line-content">                  <span class="html-attribute-name">class</span>="<span class="html-attribute-value">status-circle-progress</span>"</td></tr><tr><td class="line-number" value="388"></td><td class="line-content">                  <span class="html-attribute-name">id</span>="<span class="html-attribute-value">timer-progress</span>"</td></tr><tr><td class="line-number" value="389"></td><td class="line-content">                  <span class="html-attribute-name">cx</span>="<span class="html-attribute-value">26.8</span>"</td></tr><tr><td class="line-number" value="390"></td><td class="line-content">                  <span class="html-attribute-name">cy</span>="<span class="html-attribute-value">26.8</span>"</td></tr><tr><td class="line-number" value="391"></td><td class="line-content">                  <span class="html-attribute-name">r</span>="<span class="html-attribute-value">25.46</span>"</td></tr><tr><td class="line-number" value="392"></td><td class="line-content">                  <span class="html-attribute-name">stroke-width</span>="<span class="html-attribute-value">2.68</span>"</td></tr><tr><td class="line-number" value="393"></td><td class="line-content">                  <span class="html-attribute-name">fill</span>="<span class="html-attribute-value">none</span>"</td></tr><tr><td class="line-number" value="394"></td><td class="line-content">                  <span class="html-attribute-name">stroke-dasharray</span>="<span class="html-attribute-value">159.84</span>"</td></tr><tr><td class="line-number" value="395"></td><td class="line-content">                  <span class="html-attribute-name">stroke-dashoffset</span>="<span class="html-attribute-value">0</span>"</td></tr><tr><td class="line-number" value="396"></td><td class="line-content">                /&gt;</td></tr><tr><td class="line-number" value="397"></td><td class="line-content">              <span class="html-tag">&lt;/svg&gt;</span></td></tr><tr><td class="line-number" value="398"></td><td class="line-content">              <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">status-circle-text</span>" <span class="html-attribute-name">id</span>="<span class="html-attribute-value">timer-text</span>"&gt;</span>120<span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="399"></td><td class="line-content">            <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="400"></td><td class="line-content">            <span class="html-comment">&lt;!-- Sequence Circles --&gt;</span></td></tr><tr><td class="line-number" value="401"></td><td class="line-content">            <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">sequence-container</span>"&gt;</span><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="402"></td><td class="line-content">            <span class="html-comment">&lt;!-- Percentage Circle --&gt;</span></td></tr><tr><td class="line-number" value="403"></td><td class="line-content">            <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">status-circle-container</span>"&gt;</span></td></tr><tr><td class="line-number" value="404"></td><td class="line-content">              <span class="html-tag">&lt;svg <span class="html-attribute-name">width</span>="<span class="html-attribute-value">53.6</span>" <span class="html-attribute-name">height</span>="<span class="html-attribute-value">53.6</span>" <span class="html-attribute-name">viewBox</span>="<span class="html-attribute-value">0 0 53.6 53.6</span>"&gt;</span></td></tr><tr><td class="line-number" value="405"></td><td class="line-content">                <span class="html-tag">&lt;circle</span></td></tr><tr><td class="line-number" value="406"></td><td class="line-content">                  <span class="html-attribute-name">class</span>="<span class="html-attribute-value">status-circle-bg</span>"</td></tr><tr><td class="line-number" value="407"></td><td class="line-content">                  <span class="html-attribute-name">cx</span>="<span class="html-attribute-value">26.8</span>"</td></tr><tr><td class="line-number" value="408"></td><td class="line-content">                  <span class="html-attribute-name">cy</span>="<span class="html-attribute-value">26.8</span>"</td></tr><tr><td class="line-number" value="409"></td><td class="line-content">                  <span class="html-attribute-name">r</span>="<span class="html-attribute-value">25.46</span>"</td></tr><tr><td class="line-number" value="410"></td><td class="line-content">                  <span class="html-attribute-name">stroke-width</span>="<span class="html-attribute-value">2.68</span>"</td></tr><tr><td class="line-number" value="411"></td><td class="line-content">                  <span class="html-attribute-name">fill</span>="<span class="html-attribute-value">none</span>"</td></tr><tr><td class="line-number" value="412"></td><td class="line-content">                /&gt;</td></tr><tr><td class="line-number" value="413"></td><td class="line-content">                <span class="html-tag">&lt;circle</span></td></tr><tr><td class="line-number" value="414"></td><td class="line-content">                  <span class="html-attribute-name">class</span>="<span class="html-attribute-value">status-circle-progress</span>"</td></tr><tr><td class="line-number" value="415"></td><td class="line-content">                  <span class="html-attribute-name">id</span>="<span class="html-attribute-value">percentage-progress</span>"</td></tr><tr><td class="line-number" value="416"></td><td class="line-content">                  <span class="html-attribute-name">cx</span>="<span class="html-attribute-value">26.8</span>"</td></tr><tr><td class="line-number" value="417"></td><td class="line-content">                  <span class="html-attribute-name">cy</span>="<span class="html-attribute-value">26.8</span>"</td></tr><tr><td class="line-number" value="418"></td><td class="line-content">                  <span class="html-attribute-name">r</span>="<span class="html-attribute-value">25.46</span>"</td></tr><tr><td class="line-number" value="419"></td><td class="line-content">                  <span class="html-attribute-name">stroke-width</span>="<span class="html-attribute-value">2.68</span>"</td></tr><tr><td class="line-number" value="420"></td><td class="line-content">                  <span class="html-attribute-name">fill</span>="<span class="html-attribute-value">none</span>"</td></tr><tr><td class="line-number" value="421"></td><td class="line-content">                  <span class="html-attribute-name">stroke-dasharray</span>="<span class="html-attribute-value">159.84</span>"</td></tr><tr><td class="line-number" value="422"></td><td class="line-content">                  <span class="html-attribute-name">stroke-dashoffset</span>="<span class="html-attribute-value">159.84</span>"</td></tr><tr><td class="line-number" value="423"></td><td class="line-content">                /&gt;</td></tr><tr><td class="line-number" value="424"></td><td class="line-content">              <span class="html-tag">&lt;/svg&gt;</span></td></tr><tr><td class="line-number" value="425"></td><td class="line-content">              <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">status-circle-text</span>" <span class="html-attribute-name">id</span>="<span class="html-attribute-value">percentage-text-ingame</span>"&gt;</span></td></tr><tr><td class="line-number" value="426"></td><td class="line-content">                0%</td></tr><tr><td class="line-number" value="427"></td><td class="line-content">              <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="428"></td><td class="line-content">            <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="429"></td><td class="line-content">          <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="430"></td><td class="line-content">          <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">question</span>"&gt;</span><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="431"></td><td class="line-content">          <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">answers</span>"&gt;</span><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="432"></td><td class="line-content">          <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">game-buttons</span>"&gt;</span></td></tr><tr><td class="line-number" value="433"></td><td class="line-content">            <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">fifty-fifty</span>"&gt;</span>50:50<span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="434"></td><td class="line-content">            <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">add-time</span>"&gt;</span>30+<span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="435"></td><td class="line-content">            <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">skip</span>"&gt;</span>דלג<span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="436"></td><td class="line-content">          <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="437"></td><td class="line-content">        <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="438"></td><td class="line-content">        <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">result-screen</span>" <span class="html-attribute-name">style</span>="<span class="html-attribute-value">display: none</span>"&gt;</span></td></tr><tr><td class="line-number" value="439"></td><td class="line-content">          <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">result-card</span>"&gt;</span></td></tr><tr><td class="line-number" value="440"></td><td class="line-content">            <span class="html-tag">&lt;h3&gt;</span>🏆 תוצאות המשחק<span class="html-tag">&lt;/h3&gt;</span></td></tr><tr><td class="line-number" value="441"></td><td class="line-content">             <span class="html-tag">&lt;div <span class="html-attribute-name">style</span>="<span class="html-attribute-value">display: flex; align-items: center; justify-content: space-around;</span>"&gt;</span></td></tr><tr><td class="line-number" value="442"></td><td class="line-content">                <span class="html-tag">&lt;div&gt;</span></td></tr><tr><td class="line-number" value="443"></td><td class="line-content">                    <span class="html-tag">&lt;p <span class="html-attribute-name">id</span>="<span class="html-attribute-value">score</span>"&gt;</span><span class="html-tag">&lt;/p&gt;</span> <span class="html-comment">&lt;!-- Score text here --&gt;</span></td></tr><tr><td class="line-number" value="444"></td><td class="line-content">                    <span class="html-tag">&lt;p <span class="html-attribute-name">id</span>="<span class="html-attribute-value">accuracy-stats</span>"&gt;</span><span class="html-tag">&lt;/p&gt;</span> <span class="html-comment">&lt;!-- Accuracy stats here --&gt;</span></td></tr><tr><td class="line-number" value="445"></td><td class="line-content">                <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="446"></td><td class="line-content">                <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">progress-circle</span>"&gt;</span></td></tr><tr><td class="line-number" value="447"></td><td class="line-content">                  <span class="html-tag">&lt;svg <span class="html-attribute-name">width</span>="<span class="html-attribute-value">60</span>" <span class="html-attribute-name">height</span>="<span class="html-attribute-value">60</span>" <span class="html-attribute-name">viewBox</span>="<span class="html-attribute-value">0 0 60 60</span>"&gt;</span></td></tr><tr><td class="line-number" value="448"></td><td class="line-content">                    <span class="html-tag">&lt;circle</span></td></tr><tr><td class="line-number" value="449"></td><td class="line-content">                      <span class="html-attribute-name">cx</span>="<span class="html-attribute-value">30</span>"</td></tr><tr><td class="line-number" value="450"></td><td class="line-content">                      <span class="html-attribute-name">cy</span>="<span class="html-attribute-value">30</span>"</td></tr><tr><td class="line-number" value="451"></td><td class="line-content">                      <span class="html-attribute-name">r</span>="<span class="html-attribute-value">28</span>"</td></tr><tr><td class="line-number" value="452"></td><td class="line-content">                      <span class="html-attribute-name">stroke</span>="<span class="html-attribute-value">#e2e8f0</span>"</td></tr><tr><td class="line-number" value="453"></td><td class="line-content">                      <span class="html-attribute-name">stroke-width</span>="<span class="html-attribute-value">4</span>"</td></tr><tr><td class="line-number" value="454"></td><td class="line-content">                      <span class="html-attribute-name">fill</span>="<span class="html-attribute-value">none</span>"</td></tr><tr><td class="line-number" value="455"></td><td class="line-content">                      <span class="html-attribute-name">class</span>="<span class="html-attribute-value">status-circle-bg</span>"</td></tr><tr><td class="line-number" value="456"></td><td class="line-content">                    /&gt;</td></tr><tr><td class="line-number" value="457"></td><td class="line-content">                     <span class="html-tag">&lt;circle</span></td></tr><tr><td class="line-number" value="458"></td><td class="line-content">                      <span class="html-attribute-name">cx</span>="<span class="html-attribute-value">30</span>"</td></tr><tr><td class="line-number" value="459"></td><td class="line-content">                      <span class="html-attribute-name">cy</span>="<span class="html-attribute-value">30</span>"</td></tr><tr><td class="line-number" value="460"></td><td class="line-content">                      <span class="html-attribute-name">r</span>="<span class="html-attribute-value">28</span>"</td></tr><tr><td class="line-number" value="461"></td><td class="line-content">                      <span class="html-attribute-name">stroke-width</span>="<span class="html-attribute-value">4</span>"</td></tr><tr><td class="line-number" value="462"></td><td class="line-content">                      <span class="html-attribute-name">fill</span>="<span class="html-attribute-value">none</span>"</td></tr><tr><td class="line-number" value="463"></td><td class="line-content">                      <span class="html-attribute-name">stroke-dasharray</span>="<span class="html-attribute-value">175.9</span>"</td></tr><tr><td class="line-number" value="464"></td><td class="line-content">                      <span class="html-attribute-name">stroke-dashoffset</span>="<span class="html-attribute-value">175.9</span>"</td></tr><tr><td class="line-number" value="465"></td><td class="line-content">                      <span class="html-attribute-name">id</span>="<span class="html-attribute-value">result-progress-circle</span>"</td></tr><tr><td class="line-number" value="466"></td><td class="line-content">                      <span class="html-attribute-name">class</span>="<span class="html-attribute-value">status-circle-progress</span>"</td></tr><tr><td class="line-number" value="467"></td><td class="line-content">                    /&gt;</td></tr><tr><td class="line-number" value="468"></td><td class="line-content">                  <span class="html-tag">&lt;/svg&gt;</span></td></tr><tr><td class="line-number" value="469"></td><td class="line-content">                  <span class="html-tag">&lt;span <span class="html-attribute-name">id</span>="<span class="html-attribute-value">percentage-text-result</span>"&gt;</span>%<span class="html-tag">&lt;/span&gt;</span></td></tr><tr><td class="line-number" value="470"></td><td class="line-content">                <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="471"></td><td class="line-content">            <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="472"></td><td class="line-content">          <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="473"></td><td class="line-content">          <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">result-card</span>"&gt;</span></td></tr><tr><td class="line-number" value="474"></td><td class="line-content">            <span class="html-tag">&lt;h3&gt;</span>⚙️ כלים בשימוש<span class="html-tag">&lt;/h3&gt;</span></td></tr><tr><td class="line-number" value="475"></td><td class="line-content">            <span class="html-tag">&lt;p <span class="html-attribute-name">id</span>="<span class="html-attribute-value">tools-used</span>"&gt;</span><span class="html-tag">&lt;/p&gt;</span></td></tr><tr><td class="line-number" value="476"></td><td class="line-content">          <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="477"></td><td class="line-content">          <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">result-card</span>"&gt;</span></td></tr><tr><td class="line-number" value="478"></td><td class="line-content">            <span class="html-tag">&lt;h3&gt;</span>📊 דירוג יומי (לפי נכונות)<span class="html-tag">&lt;/h3&gt;</span></td></tr><tr><td class="line-number" value="479"></td><td class="line-content">            <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">ranking</span>"&gt;</span>טוען דירוג יומי...<span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="480"></td><td class="line-content">          <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="481"></td><td class="line-content">           <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">result-card</span>"&gt;</span> <span class="html-comment">&lt;!-- New Card for Overall Ranking --&gt;</span></td></tr><tr><td class="line-number" value="482"></td><td class="line-content">            <span class="html-tag">&lt;h3&gt;</span>💎 היכל התהילה (Top 10 לפי ניקוד)<span class="html-tag">&lt;/h3&gt;</span></td></tr><tr><td class="line-number" value="483"></td><td class="line-content">            <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">overall-ranking</span>"&gt;</span>טוען דירוג כללי...<span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="484"></td><td class="line-content">          <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="485"></td><td class="line-content">          <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">result-card</span>"&gt;</span></td></tr><tr><td class="line-number" value="486"></td><td class="line-content">            <span class="html-tag">&lt;h3&gt;</span>📚 טעית? למדת!<span class="html-tag">&lt;/h3&gt;</span></td></tr><tr><td class="line-number" value="487"></td><td class="line-content">            <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">mistakes</span>"&gt;</span><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="488"></td><td class="line-content">          <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="489"></td><td class="line-content">          <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">result-card</span>"&gt;</span></td></tr><tr><td class="line-number" value="490"></td><td class="line-content">            <span class="html-tag">&lt;h3&gt;</span>🏷️ תגיות<span class="html-tag">&lt;/h3&gt;</span></td></tr><tr><td class="line-number" value="491"></td><td class="line-content">            <span class="html-tag">&lt;div <span class="html-attribute-name">id</span>="<span class="html-attribute-value">tag-analysis</span>"&gt;</span><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="492"></td><td class="line-content">          <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="493"></td><td class="line-content">          <span class="html-tag">&lt;div <span class="html-attribute-name">class</span>="<span class="html-attribute-value">result-buttons</span>"&gt;</span></td></tr><tr><td class="line-number" value="494"></td><td class="line-content">            <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">share-result</span>"&gt;</span>שתף תוצאה<span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="495"></td><td class="line-content">            <span class="html-tag">&lt;button <span class="html-attribute-name">id</span>="<span class="html-attribute-value">restart</span>"&gt;</span>שחק שוב<span class="html-tag">&lt;/button&gt;</span></td></tr><tr><td class="line-number" value="496"></td><td class="line-content">          <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="497"></td><td class="line-content">        <span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="498"></td><td class="line-content">      <span class="html-tag">&lt;/main&gt;</span></td></tr><tr><td class="line-number" value="499"></td><td class="line-content">    <span class="html-tag">&lt;/div&gt;</span> <span class="html-comment">&lt;!-- End of .container --&gt;</span></td></tr><tr><td class="line-number" value="500"></td><td class="line-content">    <span class="html-tag">&lt;footer&gt;</span></td></tr><tr><td class="line-number" value="501"></td><td class="line-content">      פותח על ידי אריאל מ<span class="html-tag">&lt;a</span></td></tr><tr><td class="line-number" value="502"></td><td class="line-content">        <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="https://galilbio.wordpress.com/" rel="noreferrer noopener">https://galilbio.wordpress.com</a>"</td></tr><tr><td class="line-number" value="503"></td><td class="line-content">        <span class="html-attribute-name">target</span>="<span class="html-attribute-value">_blank</span>"</td></tr><tr><td class="line-number" value="504"></td><td class="line-content">        &gt;הַבִּיּוֹלוֹגִים של גליל<span class="html-tag">&lt;/a</span></td></tr><tr><td class="line-number" value="505"></td><td class="line-content">      &gt;</td></tr><tr><td class="line-number" value="506"></td><td class="line-content">      בעזרת<span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="https://grok.com/" rel="noreferrer noopener">https://grok.com/</a>" <span class="html-attribute-name">target</span>="<span class="html-attribute-value">_blank</span>"&gt;</span>גרוק<span class="html-tag">&lt;/a&gt;</span>,<span class="html-tag">&lt;a</span></td></tr><tr><td class="line-number" value="507"></td><td class="line-content">        <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="https://chatgpt.com/" rel="noreferrer noopener">https://chatgpt.com/</a>"</td></tr><tr><td class="line-number" value="508"></td><td class="line-content">        <span class="html-attribute-name">target</span>="<span class="html-attribute-value">_blank</span>"</td></tr><tr><td class="line-number" value="509"></td><td class="line-content">        &gt;Chat GPT<span class="html-tag">&lt;/a</span></td></tr><tr><td class="line-number" value="510"></td><td class="line-content">      &gt;וגם<span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="https://gemini.google.com/app" rel="noreferrer noopener">https://gemini.google.com/app</a>" <span class="html-attribute-name">target</span>="<span class="html-attribute-value">_blank</span>"&gt;</span>Gemini<span class="html-tag">&lt;/a&gt;</span> |</td></tr><tr><td class="line-number" value="511"></td><td class="line-content">      <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="https://trivbio.web.app/admin.html" rel="noreferrer noopener">admin.html</a>" <span class="html-attribute-name">target</span>="<span class="html-attribute-value">_blank</span>"&gt;</span>ניהול<span class="html-tag">&lt;/a&gt;</span></td></tr><tr><td class="line-number" value="512"></td><td class="line-content">    <span class="html-tag">&lt;/footer&gt;</span></td></tr><tr><td class="line-number" value="513"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="514"></td><td class="line-content">    <span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js" rel="noreferrer noopener">https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="515"></td><td class="line-content">    <span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js" rel="noreferrer noopener">https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="516"></td><td class="line-content">    <span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js" rel="noreferrer noopener">https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="517"></td><td class="line-content">    <span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" rel="noreferrer noopener">https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="518"></td><td class="line-content">    <span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="519"></td><td class="line-content">      console.log("Script loaded and running");</td></tr><tr><td class="line-number" value="520"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="521"></td><td class="line-content">      const topicNames = {</td></tr><tr><td class="line-number" value="522"></td><td class="line-content">        "human-body": "גוף האדם",</td></tr><tr><td class="line-number" value="523"></td><td class="line-content">        cell: "התא",</td></tr><tr><td class="line-number" value="524"></td><td class="line-content">        ecology: "אקולוגיה",</td></tr><tr><td class="line-number" value="525"></td><td class="line-content">        mix: "ערבב אותי",</td></tr><tr><td class="line-number" value="526"></td><td class="line-content">      };</td></tr><tr><td class="line-number" value="527"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="528"></td><td class="line-content">      // --- Firebase Config ---</td></tr><tr><td class="line-number" value="529"></td><td class="line-content">      const firebaseConfig = {</td></tr><tr><td class="line-number" value="530"></td><td class="line-content">        apiKey: "AIzaSyAGFC_TB8iEMvS2PyxeASj1HH4i66AW4UA", // Keep your actual key secure</td></tr><tr><td class="line-number" value="531"></td><td class="line-content">        authDomain: "trivbio.firebaseapp.com",</td></tr><tr><td class="line-number" value="532"></td><td class="line-content">        projectId: "trivbio",</td></tr><tr><td class="line-number" value="533"></td><td class="line-content">        storageBucket: "trivbio.firebasestorage.app",</td></tr><tr><td class="line-number" value="534"></td><td class="line-content">        messagingSenderId: "1097087574583",</td></tr><tr><td class="line-number" value="535"></td><td class="line-content">        appId: "1:1097087574583:web:b36c0441537a1f596215b2",</td></tr><tr><td class="line-number" value="536"></td><td class="line-content">        measurementId: "G-ZY245YB23E",</td></tr><tr><td class="line-number" value="537"></td><td class="line-content">      };</td></tr><tr><td class="line-number" value="538"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="539"></td><td class="line-content">      // --- Firebase Initialization ---</td></tr><tr><td class="line-number" value="540"></td><td class="line-content">      firebase.initializeApp(firebaseConfig);</td></tr><tr><td class="line-number" value="541"></td><td class="line-content">      const database = firebase.database();</td></tr><tr><td class="line-number" value="542"></td><td class="line-content">      console.log("Firebase initialized successfully");</td></tr><tr><td class="line-number" value="543"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="544"></td><td class="line-content">      // --- Global Variables &amp; DOM Elements ---</td></tr><tr><td class="line-number" value="545"></td><td class="line-content">      const startScreen = document.getElementById("start-screen");</td></tr><tr><td class="line-number" value="546"></td><td class="line-content">      const gameScreen = document.getElementById("game-screen");</td></tr><tr><td class="line-number" value="547"></td><td class="line-content">      const resultScreen = document.getElementById("result-screen");</td></tr><tr><td class="line-number" value="548"></td><td class="line-content">      const startScreenButtonsContainer = document.getElementById(</td></tr><tr><td class="line-number" value="549"></td><td class="line-content">        "start-screen-buttons"</td></tr><tr><td class="line-number" value="550"></td><td class="line-content">      );</td></tr><tr><td class="line-number" value="551"></td><td class="line-content">      const timerTextElement = document.getElementById("timer-text");</td></tr><tr><td class="line-number" value="552"></td><td class="line-content">      const timerProgressElement = document.getElementById("timer-progress");</td></tr><tr><td class="line-number" value="553"></td><td class="line-content">      const percentageTextIngameElement = document.getElementById(</td></tr><tr><td class="line-number" value="554"></td><td class="line-content">        "percentage-text-ingame"</td></tr><tr><td class="line-number" value="555"></td><td class="line-content">      );</td></tr><tr><td class="line-number" value="556"></td><td class="line-content">      const percentageProgressElement = document.getElementById(</td></tr><tr><td class="line-number" value="557"></td><td class="line-content">        "percentage-progress"</td></tr><tr><td class="line-number" value="558"></td><td class="line-content">      );</td></tr><tr><td class="line-number" value="559"></td><td class="line-content">      const questionElement = document.getElementById("question");</td></tr><tr><td class="line-number" value="560"></td><td class="line-content">      const answersElement = document.getElementById("answers");</td></tr><tr><td class="line-number" value="561"></td><td class="line-content">      const fiftyFiftyButton = document.getElementById("fifty-fifty");</td></tr><tr><td class="line-number" value="562"></td><td class="line-content">      const addTimeButton = document.getElementById("add-time");</td></tr><tr><td class="line-number" value="563"></td><td class="line-content">      const skipButton = document.getElementById("skip");</td></tr><tr><td class="line-number" value="564"></td><td class="line-content">      const restartButton = document.getElementById("restart");</td></tr><tr><td class="line-number" value="565"></td><td class="line-content">      const themeToggle = document.getElementById("theme-toggle");</td></tr><tr><td class="line-number" value="566"></td><td class="line-content">      const toolsUsedElement = document.getElementById("tools-used");</td></tr><tr><td class="line-number" value="567"></td><td class="line-content">      const mistakesElement = document.getElementById("mistakes");</td></tr><tr><td class="line-number" value="568"></td><td class="line-content">      const sequenceContainer = document.getElementById("sequence-container");</td></tr><tr><td class="line-number" value="569"></td><td class="line-content">      const tagAnalysisElement = document.getElementById("tag-analysis");</td></tr><tr><td class="line-number" value="570"></td><td class="line-content">      const resultProgressCircleElement = document.getElementById(</td></tr><tr><td class="line-number" value="571"></td><td class="line-content">        "result-progress-circle"</td></tr><tr><td class="line-number" value="572"></td><td class="line-content">      );</td></tr><tr><td class="line-number" value="573"></td><td class="line-content">      const percentageTextResultElement = document.getElementById(</td></tr><tr><td class="line-number" value="574"></td><td class="line-content">        "percentage-text-result"</td></tr><tr><td class="line-number" value="575"></td><td class="line-content">      );</td></tr><tr><td class="line-number" value="576"></td><td class="line-content">      const scoreElement = document.getElementById("score"); // Score display on results</td></tr><tr><td class="line-number" value="577"></td><td class="line-content">      const accuracyStatsElement = document.getElementById("accuracy-stats"); // Accuracy display on results</td></tr><tr><td class="line-number" value="578"></td><td class="line-content">      const cumulativeScoreDisplayElement = document.getElementById("cumulative-score-display"); // Display near header</td></tr><tr><td class="line-number" value="579"></td><td class="line-content">      const rankingElement = document.getElementById("ranking"); // Daily ranking</td></tr><tr><td class="line-number" value="580"></td><td class="line-content">      const overallRankingElement = document.getElementById("overall-ranking"); // Overall ranking</td></tr><tr><td class="line-number" value="581"></td><td class="line-content">      const shareButton = document.getElementById("share-result");</td></tr><tr><td class="line-number" value="582"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="583"></td><td class="line-content">      let currentTopic = "";</td></tr><tr><td class="line-number" value="584"></td><td class="line-content">      let allQuestions = [];</td></tr><tr><td class="line-number" value="585"></td><td class="line-content">      let questions = [];</td></tr><tr><td class="line-number" value="586"></td><td class="line-content">      let currentQuestionIndex = 0;</td></tr><tr><td class="line-number" value="587"></td><td class="line-content">      let currentQuestion = null;</td></tr><tr><td class="line-number" value="588"></td><td class="line-content">      let correctCount = 0;</td></tr><tr><td class="line-number" value="589"></td><td class="line-content">      let wrongCount = 0;</td></tr><tr><td class="line-number" value="590"></td><td class="line-content">      let timerValue = 120;</td></tr><tr><td class="line-number" value="591"></td><td class="line-content">      let totalTime = 120;</td></tr><tr><td class="line-number" value="592"></td><td class="line-content">      let timerInterval;</td></tr><tr><td class="line-number" value="593"></td><td class="line-content">      let fiftyFiftyUsed = false;</td></tr><tr><td class="line-number" value="594"></td><td class="line-content">      let addTimeUsed = false;</td></tr><tr><td class="line-number" value="595"></td><td class="line-content">      let skipUsed = 0;</td></tr><tr><td class="line-number" value="596"></td><td class="line-content">      let mistakeDetails = [];</td></tr><tr><td class="line-number" value="597"></td><td class="line-content">      let mistakenQuestions = [];</td></tr><tr><td class="line-number" value="598"></td><td class="line-content">      let answerSequence = [];</td></tr><tr><td class="line-number" value="599"></td><td class="line-content">      let answeredCorrectly = [];</td></tr><tr><td class="line-number" value="600"></td><td class="line-content">      let gameTagStats = {};</td></tr><tr><td class="line-number" value="601"></td><td class="line-content">      let currentStreak = 0;</td></tr><tr><td class="line-number" value="602"></td><td class="line-content">      let longestStreak = 0;</td></tr><tr><td class="line-number" value="603"></td><td class="line-content">      let playerId = null;</td></tr><tr><td class="line-number" value="604"></td><td class="line-content">      let timerExpired = false;</td></tr><tr><td class="line-number" value="605"></td><td class="line-content">      let gameActive = false;</td></tr><tr><td class="line-number" value="606"></td><td class="line-content">      let currentGameScore = 0; // &lt;&lt;&lt; New: Score for the current game</td></tr><tr><td class="line-number" value="607"></td><td class="line-content">      let cumulativePlayerScore = 0; // &lt;&lt;&lt; New: Player's total score</td></tr><tr><td class="line-number" value="608"></td><td class="line-content">      let playerNickname = "אנונימי"; // &lt;&lt;&lt; New: Placeholder for nickname</td></tr><tr><td class="line-number" value="609"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="610"></td><td class="line-content">      const CIRCLE_CIRCUMFERENCE = 159.84;</td></tr><tr><td class="line-number" value="611"></td><td class="line-content">      const RESULT_CIRCLE_CIRCUMFERENCE = 175.9;</td></tr><tr><td class="line-number" value="612"></td><td class="line-content">      const BASE_SCORE_PER_QUESTION = 10; // &lt;&lt;&lt; New: Base score value</td></tr><tr><td class="line-number" value="613"></td><td class="line-content">      const STREAK_BONUS_MULTIPLIER = 2; // &lt;&lt;&lt; New: Score multiplier for streak</td></tr><tr><td class="line-number" value="614"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="615"></td><td class="line-content">      // --- Initialization Functions ---</td></tr><tr><td class="line-number" value="616"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="617"></td><td class="line-content">      function populateTopicButtons(questionCounts) {</td></tr><tr><td class="line-number" value="618"></td><td class="line-content">        const topics = [</td></tr><tr><td class="line-number" value="619"></td><td class="line-content">          { id: "human-body", name: "גוף האדם", emoji: "🧍" },</td></tr><tr><td class="line-number" value="620"></td><td class="line-content">          { id: "cell", name: "התא", emoji: "🧬" },</td></tr><tr><td class="line-number" value="621"></td><td class="line-content">          { id: "ecology", name: "אקולוגיה", emoji: "🌍" },</td></tr><tr><td class="line-number" value="622"></td><td class="line-content">          { id: "mix", name: "ערבב אותי", emoji: "🎲" },</td></tr><tr><td class="line-number" value="623"></td><td class="line-content">        ];</td></tr><tr><td class="line-number" value="624"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="625"></td><td class="line-content">        startScreenButtonsContainer.innerHTML = "";</td></tr><tr><td class="line-number" value="626"></td><td class="line-content">        topics.forEach((topic) =&gt; {</td></tr><tr><td class="line-number" value="627"></td><td class="line-content">          const button = document.createElement("button");</td></tr><tr><td class="line-number" value="628"></td><td class="line-content">          button.classList.add("topic-btn");</td></tr><tr><td class="line-number" value="629"></td><td class="line-content">          button.dataset.topic = topic.id;</td></tr><tr><td class="line-number" value="630"></td><td class="line-content">          const count = typeof questionCounts[topic.id] === 'number' ? questionCounts[topic.id] : 0;</td></tr><tr><td class="line-number" value="631"></td><td class="line-content">          button.innerHTML = `${topic.name} &lt;span&gt;${topic.emoji}&lt;/span&gt; &lt;span class="question-count"&gt;[${count} שאלות]&lt;/span&gt;`;</td></tr><tr><td class="line-number" value="632"></td><td class="line-content">          button.addEventListener("click", async () =&gt; {</td></tr><tr><td class="line-number" value="633"></td><td class="line-content">            vibrate(50);</td></tr><tr><td class="line-number" value="634"></td><td class="line-content">            currentTopic = button.getAttribute("data-topic");</td></tr><tr><td class="line-number" value="635"></td><td class="line-content">            await loadQuestionsForTopic(currentTopic);</td></tr><tr><td class="line-number" value="636"></td><td class="line-content">          });</td></tr><tr><td class="line-number" value="637"></td><td class="line-content">          startScreenButtonsContainer.appendChild(button);</td></tr><tr><td class="line-number" value="638"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="639"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="640"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="641"></td><td class="line-content">      (async function initializeQuestionCounts() {</td></tr><tr><td class="line-number" value="642"></td><td class="line-content">         let cachedCounts = {};</td></tr><tr><td class="line-number" value="643"></td><td class="line-content">         let cachedTimestamp = null;</td></tr><tr><td class="line-number" value="644"></td><td class="line-content">         const defaultCounts = { "human-body": 0, cell: 0, ecology: 0, mix: 0 }; // Default to 0</td></tr><tr><td class="line-number" value="645"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="646"></td><td class="line-content">         try {</td></tr><tr><td class="line-number" value="647"></td><td class="line-content">           cachedCounts = JSON.parse(localStorage.getItem("questionCounts") || "{}");</td></tr><tr><td class="line-number" value="648"></td><td class="line-content">           Object.keys(defaultCounts).forEach(key =&gt; {</td></tr><tr><td class="line-number" value="649"></td><td class="line-content">              if (typeof cachedCounts[key] !== 'number') {</td></tr><tr><td class="line-number" value="650"></td><td class="line-content">                  cachedCounts[key] = 0;</td></tr><tr><td class="line-number" value="651"></td><td class="line-content">              }</td></tr><tr><td class="line-number" value="652"></td><td class="line-content">           });</td></tr><tr><td class="line-number" value="653"></td><td class="line-content">           cachedTimestamp = localStorage.getItem("questionCountsTimestamp");</td></tr><tr><td class="line-number" value="654"></td><td class="line-content">         } catch (e) {</td></tr><tr><td class="line-number" value="655"></td><td class="line-content">           console.error("Error reading question counts from localStorage", e);</td></tr><tr><td class="line-number" value="656"></td><td class="line-content">           cachedCounts = defaultCounts; // Use defaults on error</td></tr><tr><td class="line-number" value="657"></td><td class="line-content">           localStorage.removeItem("questionCounts");</td></tr><tr><td class="line-number" value="658"></td><td class="line-content">           localStorage.removeItem("questionCountsTimestamp");</td></tr><tr><td class="line-number" value="659"></td><td class="line-content">         }</td></tr><tr><td class="line-number" value="660"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="661"></td><td class="line-content">         const currentTime = Date.now();</td></tr><tr><td class="line-number" value="662"></td><td class="line-content">         const oneDay = 24 * 60 * 60 * 1000;</td></tr><tr><td class="line-number" value="663"></td><td class="line-content">         const isCacheStale = !cachedTimestamp || currentTime - parseInt(cachedTimestamp) &gt;= oneDay;</td></tr><tr><td class="line-number" value="664"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="665"></td><td class="line-content">         console.log("Populating buttons with initial counts:", cachedCounts);</td></tr><tr><td class="line-number" value="666"></td><td class="line-content">         populateTopicButtons(cachedCounts); // Populate immediately with cached/default counts</td></tr><tr><td class="line-number" value="667"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="668"></td><td class="line-content">         if (isCacheStale) {</td></tr><tr><td class="line-number" value="669"></td><td class="line-content">           console.log("Cache is stale or data missing. Fetching new question counts from Firebase...");</td></tr><tr><td class="line-number" value="670"></td><td class="line-content">           try {</td></tr><tr><td class="line-number" value="671"></td><td class="line-content">             const snapshot = await database.ref("questions").once("value");</td></tr><tr><td class="line-number" value="672"></td><td class="line-content">             const allQsData = snapshot.val();</td></tr><tr><td class="line-number" value="673"></td><td class="line-content">             const freshCounts = { "human-body": 0, cell: 0, ecology: 0, mix: 0 };</td></tr><tr><td class="line-number" value="674"></td><td class="line-content">             let totalFetched = 0;</td></tr><tr><td class="line-number" value="675"></td><td class="line-content">             if (allQsData) {</td></tr><tr><td class="line-number" value="676"></td><td class="line-content">               Object.values(allQsData).forEach((q) =&gt; {</td></tr><tr><td class="line-number" value="677"></td><td class="line-content">                 if (q &amp;&amp; q.topic &amp;&amp; freshCounts.hasOwnProperty(q.topic)) {</td></tr><tr><td class="line-number" value="678"></td><td class="line-content">                    freshCounts[q.topic]++;</td></tr><tr><td class="line-number" value="679"></td><td class="line-content">                    freshCounts["mix"]++;</td></tr><tr><td class="line-number" value="680"></td><td class="line-content">                    totalFetched++;</td></tr><tr><td class="line-number" value="681"></td><td class="line-content">                 }</td></tr><tr><td class="line-number" value="682"></td><td class="line-content">               });</td></tr><tr><td class="line-number" value="683"></td><td class="line-content">             }</td></tr><tr><td class="line-number" value="684"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="685"></td><td class="line-content">             if (totalFetched &gt; 0) { // Only update if we actually got data</td></tr><tr><td class="line-number" value="686"></td><td class="line-content">                 localStorage.setItem("questionCounts", JSON.stringify(freshCounts));</td></tr><tr><td class="line-number" value="687"></td><td class="line-content">                 localStorage.setItem("questionCountsTimestamp", currentTime.toString());</td></tr><tr><td class="line-number" value="688"></td><td class="line-content">                 console.log("Repopulating buttons with fresh counts:", freshCounts);</td></tr><tr><td class="line-number" value="689"></td><td class="line-content">                 populateTopicButtons(freshCounts); // Update immediately</td></tr><tr><td class="line-number" value="690"></td><td class="line-content">             } else {</td></tr><tr><td class="line-number" value="691"></td><td class="line-content">                 console.warn("No valid questions found during Firebase fetch, keeping initial counts.");</td></tr><tr><td class="line-number" value="692"></td><td class="line-content">             }</td></tr><tr><td class="line-number" value="693"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="694"></td><td class="line-content">           } catch (error) {</td></tr><tr><td class="line-number" value="695"></td><td class="line-content">             console.error("Error fetching question counts during background update:", error);</td></tr><tr><td class="line-number" value="696"></td><td class="line-content">           }</td></tr><tr><td class="line-number" value="697"></td><td class="line-content">         } else {</td></tr><tr><td class="line-number" value="698"></td><td class="line-content">           console.log("Using fresh cached question counts.");</td></tr><tr><td class="line-number" value="699"></td><td class="line-content">         }</td></tr><tr><td class="line-number" value="700"></td><td class="line-content">      })();</td></tr><tr><td class="line-number" value="701"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="702"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="703"></td><td class="line-content">      function showToast(message, duration = 3000) {</td></tr><tr><td class="line-number" value="704"></td><td class="line-content">        document.querySelectorAll(".toast").forEach((t) =&gt; t.remove());</td></tr><tr><td class="line-number" value="705"></td><td class="line-content">        const toast = document.createElement("div");</td></tr><tr><td class="line-number" value="706"></td><td class="line-content">        toast.classList.add("toast");</td></tr><tr><td class="line-number" value="707"></td><td class="line-content">        toast.textContent = message;</td></tr><tr><td class="line-number" value="708"></td><td class="line-content">        document.body.appendChild(toast);</td></tr><tr><td class="line-number" value="709"></td><td class="line-content">        toast.offsetHeight; // Trigger reflow to enable transition</td></tr><tr><td class="line-number" value="710"></td><td class="line-content">        toast.classList.add("show");</td></tr><tr><td class="line-number" value="711"></td><td class="line-content">        if (duration &gt; 0) {</td></tr><tr><td class="line-number" value="712"></td><td class="line-content">          setTimeout(() =&gt; {</td></tr><tr><td class="line-number" value="713"></td><td class="line-content">            toast.classList.remove("show");</td></tr><tr><td class="line-number" value="714"></td><td class="line-content">            setTimeout(() =&gt; toast.remove(), 500);</td></tr><tr><td class="line-number" value="715"></td><td class="line-content">          }, duration);</td></tr><tr><td class="line-number" value="716"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="717"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="718"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="719"></td><td class="line-content">      // --- Authentication &amp; User Data ---</td></tr><tr><td class="line-number" value="720"></td><td class="line-content">      firebase</td></tr><tr><td class="line-number" value="721"></td><td class="line-content">        .auth()</td></tr><tr><td class="line-number" value="722"></td><td class="line-content">        .signInAnonymously()</td></tr><tr><td class="line-number" value="723"></td><td class="line-content">        .then((userCredential) =&gt; {</td></tr><tr><td class="line-number" value="724"></td><td class="line-content">          playerId = userCredential.user.uid;</td></tr><tr><td class="line-number" value="725"></td><td class="line-content">          console.log("Anonymous Auth Success. Player ID:", playerId);</td></tr><tr><td class="line-number" value="726"></td><td class="line-content">          initializePlayerState();</td></tr><tr><td class="line-number" value="727"></td><td class="line-content">        })</td></tr><tr><td class="line-number" value="728"></td><td class="line-content">        .catch((error) =&gt; {</td></tr><tr><td class="line-number" value="729"></td><td class="line-content">          console.error("Anonymous auth failed:", error);</td></tr><tr><td class="line-number" value="730"></td><td class="line-content">          showToast("חלה שגיאה בהתחברות אנונימית...");</td></tr><tr><td class="line-number" value="731"></td><td class="line-content">          // Maybe disable features requiring player ID if auth fails</td></tr><tr><td class="line-number" value="732"></td><td class="line-content">          cumulativeScoreDisplayElement.textContent = "שגיאת התחברות";</td></tr><tr><td class="line-number" value="733"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="734"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="735"></td><td class="line-content">      function initializePlayerState() {</td></tr><tr><td class="line-number" value="736"></td><td class="line-content">        if (!playerId) return; // Don't proceed if auth failed</td></tr><tr><td class="line-number" value="737"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="738"></td><td class="line-content">        // Theme</td></tr><tr><td class="line-number" value="739"></td><td class="line-content">        const savedDarkMode = localStorage.getItem("darkMode") === "true";</td></tr><tr><td class="line-number" value="740"></td><td class="line-content">        setTheme(savedDarkMode);</td></tr><tr><td class="line-number" value="741"></td><td class="line-content">        themeToggle.checked = savedDarkMode;</td></tr><tr><td class="line-number" value="742"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="743"></td><td class="line-content">        // Last Topic Hint</td></tr><tr><td class="line-number" value="744"></td><td class="line-content">        const localLastTopic = localStorage.getItem("lastTopic");</td></tr><tr><td class="line-number" value="745"></td><td class="line-content">        if (localLastTopic &amp;&amp; topicNames[localLastTopic]) {</td></tr><tr><td class="line-number" value="746"></td><td class="line-content">          updateStartScreenHint(localLastTopic);</td></tr><tr><td class="line-number" value="747"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="748"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="749"></td><td class="line-content">        // Fetch Player Data from Firebase</td></tr><tr><td class="line-number" value="750"></td><td class="line-content">        database.ref(`players/${playerId}`).once("value")</td></tr><tr><td class="line-number" value="751"></td><td class="line-content">          .then((snapshot) =&gt; {</td></tr><tr><td class="line-number" value="752"></td><td class="line-content">            const playerData = snapshot.val() || {}; // Default to empty object if no data</td></tr><tr><td class="line-number" value="753"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="754"></td><td class="line-content">            // Load Cumulative Score</td></tr><tr><td class="line-number" value="755"></td><td class="line-content">            cumulativePlayerScore = playerData.cumulativeScore || 0;</td></tr><tr><td class="line-number" value="756"></td><td class="line-content">            playerNickname = playerData.nickname || `שחקן...${playerId.substring(playerId.length - 4)}`; // Use nickname or part of ID</td></tr><tr><td class="line-number" value="757"></td><td class="line-content">            updateCumulativeScoreDisplay();</td></tr><tr><td class="line-number" value="758"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="759"></td><td class="line-content">            // Load Last Topic (override local if Firebase is different)</td></tr><tr><td class="line-number" value="760"></td><td class="line-content">            if (playerData.lastTopic &amp;&amp; topicNames[playerData.lastTopic] &amp;&amp; playerData.lastTopic !== localLastTopic) {</td></tr><tr><td class="line-number" value="761"></td><td class="line-content">                updateStartScreenHint(playerData.lastTopic);</td></tr><tr><td class="line-number" value="762"></td><td class="line-content">                localStorage.setItem("lastTopic", playerData.lastTopic);</td></tr><tr><td class="line-number" value="763"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="764"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="765"></td><td class="line-content">            // Load Theme Preference (override local if Firebase is different)</td></tr><tr><td class="line-number" value="766"></td><td class="line-content">            if (typeof playerData.darkMode === "boolean" &amp;&amp; playerData.darkMode !== savedDarkMode) {</td></tr><tr><td class="line-number" value="767"></td><td class="line-content">                setTheme(playerData.darkMode);</td></tr><tr><td class="line-number" value="768"></td><td class="line-content">                themeToggle.checked = playerData.darkMode;</td></tr><tr><td class="line-number" value="769"></td><td class="line-content">                localStorage.setItem("darkMode", playerData.darkMode.toString());</td></tr><tr><td class="line-number" value="770"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="771"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="772"></td><td class="line-content">            // If player is new, save initial state (score 0 and current theme)</td></tr><tr><td class="line-number" value="773"></td><td class="line-content">            if (!snapshot.exists()) {</td></tr><tr><td class="line-number" value="774"></td><td class="line-content">                 savePlayerInitialData(savedDarkMode);</td></tr><tr><td class="line-number" value="775"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="776"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="777"></td><td class="line-content">          })</td></tr><tr><td class="line-number" value="778"></td><td class="line-content">          .catch((error) =&gt; {</td></tr><tr><td class="line-number" value="779"></td><td class="line-content">                console.error("Error fetching player data:", error);</td></tr><tr><td class="line-number" value="780"></td><td class="line-content">                cumulativeScoreDisplayElement.textContent = "שגיאה בטעינת ניקוד";</td></tr><tr><td class="line-number" value="781"></td><td class="line-content">                // Attempt to use local storage values if Firebase fails</td></tr><tr><td class="line-number" value="782"></td><td class="line-content">                cumulativePlayerScore = parseInt(localStorage.getItem("cumulativeScoreBackup") || "0");</td></tr><tr><td class="line-number" value="783"></td><td class="line-content">                 updateCumulativeScoreDisplay();</td></tr><tr><td class="line-number" value="784"></td><td class="line-content">          });</td></tr><tr><td class="line-number" value="785"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="786"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="787"></td><td class="line-content">      function savePlayerInitialData(isDarkMode) {</td></tr><tr><td class="line-number" value="788"></td><td class="line-content">          if (!playerId) return;</td></tr><tr><td class="line-number" value="789"></td><td class="line-content">           database.ref(`players/${playerId}`).set({</td></tr><tr><td class="line-number" value="790"></td><td class="line-content">               cumulativeScore: 0,</td></tr><tr><td class="line-number" value="791"></td><td class="line-content">               nickname: playerNickname, // Save default nickname</td></tr><tr><td class="line-number" value="792"></td><td class="line-content">               darkMode: isDarkMode,</td></tr><tr><td class="line-number" value="793"></td><td class="line-content">               createdAt: firebase.database.ServerValue.TIMESTAMP</td></tr><tr><td class="line-number" value="794"></td><td class="line-content">           }).then(() =&gt; {</td></tr><tr><td class="line-number" value="795"></td><td class="line-content">               console.log("Initial player data saved for new player.");</td></tr><tr><td class="line-number" value="796"></td><td class="line-content">           }).catch(error =&gt; console.error("Failed to save initial player data:", error));</td></tr><tr><td class="line-number" value="797"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="798"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="799"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="800"></td><td class="line-content">      function updateStartScreenHint(topicId) {</td></tr><tr><td class="line-number" value="801"></td><td class="line-content">          const hintElement = document.querySelector("#start-screen h2");</td></tr><tr><td class="line-number" value="802"></td><td class="line-content">          if (hintElement &amp;&amp; topicNames[topicId]) {</td></tr><tr><td class="line-number" value="803"></td><td class="line-content">             hintElement.textContent = `בפעם שעברה בחרת ${topicNames[topicId]}, מה הפעם?`;</td></tr><tr><td class="line-number" value="804"></td><td class="line-content">          } else if (hintElement) {</td></tr><tr><td class="line-number" value="805"></td><td class="line-content">              hintElement.textContent = `מוכן לבחור נושא?`; // Default if topic invalid</td></tr><tr><td class="line-number" value="806"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="807"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="808"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="809"></td><td class="line-content">      function updateCumulativeScoreDisplay() {</td></tr><tr><td class="line-number" value="810"></td><td class="line-content">          cumulativeScoreDisplayElement.textContent = `ניקוד כולל: ${cumulativePlayerScore.toLocaleString()}`;</td></tr><tr><td class="line-number" value="811"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="812"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="813"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="814"></td><td class="line-content">      // --- Theme Management ---</td></tr><tr><td class="line-number" value="815"></td><td class="line-content">      function setTheme(isDarkMode) {</td></tr><tr><td class="line-number" value="816"></td><td class="line-content">        document.body.classList.toggle("dark-mode", isDarkMode);</td></tr><tr><td class="line-number" value="817"></td><td class="line-content">        if (timerValue &gt; 30) {</td></tr><tr><td class="line-number" value="818"></td><td class="line-content">          timerProgressElement.style.stroke = isDarkMode</td></tr><tr><td class="line-number" value="819"></td><td class="line-content">            ? "#4299e1"</td></tr><tr><td class="line-number" value="820"></td><td class="line-content">            : "#7F9CF5";</td></tr><tr><td class="line-number" value="821"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="822"></td><td class="line-content">        document.querySelectorAll(".status-circle-bg").forEach((circle) =&gt; {</td></tr><tr><td class="line-number" value="823"></td><td class="line-content">          circle.style.stroke = isDarkMode ? "#4a5568" : "#e2e8f0";</td></tr><tr><td class="line-number" value="824"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="825"></td><td class="line-content">        const resultBgCircle =</td></tr><tr><td class="line-number" value="826"></td><td class="line-content">          resultProgressCircleElement?.previousElementSibling;</td></tr><tr><td class="line-number" value="827"></td><td class="line-content">        if (resultBgCircle) {</td></tr><tr><td class="line-number" value="828"></td><td class="line-content">          resultBgCircle.style.stroke = isDarkMode ? "#4a5568" : "#e2e8f0";</td></tr><tr><td class="line-number" value="829"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="830"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="831"></td><td class="line-content">      themeToggle.addEventListener("change", () =&gt; {</td></tr><tr><td class="line-number" value="832"></td><td class="line-content">        vibrate(50);</td></tr><tr><td class="line-number" value="833"></td><td class="line-content">        const isDarkMode = themeToggle.checked;</td></tr><tr><td class="line-number" value="834"></td><td class="line-content">        setTheme(isDarkMode);</td></tr><tr><td class="line-number" value="835"></td><td class="line-content">        saveThemePreference(isDarkMode);</td></tr><tr><td class="line-number" value="836"></td><td class="line-content">      });</td></tr><tr><td class="line-number" value="837"></td><td class="line-content">      function saveThemePreference(isDarkMode) {</td></tr><tr><td class="line-number" value="838"></td><td class="line-content">        localStorage.setItem("darkMode", isDarkMode.toString());</td></tr><tr><td class="line-number" value="839"></td><td class="line-content">        if (playerId) {</td></tr><tr><td class="line-number" value="840"></td><td class="line-content">          database</td></tr><tr><td class="line-number" value="841"></td><td class="line-content">            .ref(`players/${playerId}`)</td></tr><tr><td class="line-number" value="842"></td><td class="line-content">            .update({ darkMode: isDarkMode })</td></tr><tr><td class="line-number" value="843"></td><td class="line-content">            .catch((error) =&gt;</td></tr><tr><td class="line-number" value="844"></td><td class="line-content">              console.error("Failed to save theme preference:", error)</td></tr><tr><td class="line-number" value="845"></td><td class="line-content">            );</td></tr><tr><td class="line-number" value="846"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="847"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="848"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="849"></td><td class="line-content">      // --- Question Loading ---</td></tr><tr><td class="line-number" value="850"></td><td class="line-content">      async function loadQuestions() {</td></tr><tr><td class="line-number" value="851"></td><td class="line-content">        const cachedQuestions = localStorage.getItem("questions");</td></tr><tr><td class="line-number" value="852"></td><td class="line-content">        const cachedTimestamp = localStorage.getItem("questionsTimestamp");</td></tr><tr><td class="line-number" value="853"></td><td class="line-content">        const currentTime = Date.now();</td></tr><tr><td class="line-number" value="854"></td><td class="line-content">        const oneDay = 24 * 60 * 60 * 1000;</td></tr><tr><td class="line-number" value="855"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="856"></td><td class="line-content">        if (</td></tr><tr><td class="line-number" value="857"></td><td class="line-content">          cachedQuestions &amp;&amp;</td></tr><tr><td class="line-number" value="858"></td><td class="line-content">          cachedTimestamp &amp;&amp;</td></tr><tr><td class="line-number" value="859"></td><td class="line-content">          currentTime - parseInt(cachedTimestamp) &lt; oneDay</td></tr><tr><td class="line-number" value="860"></td><td class="line-content">        ) {</td></tr><tr><td class="line-number" value="861"></td><td class="line-content">          console.log("Using cached questions.");</td></tr><tr><td class="line-number" value="862"></td><td class="line-content">          try {</td></tr><tr><td class="line-number" value="863"></td><td class="line-content">            const parsed = JSON.parse(cachedQuestions);</td></tr><tr><td class="line-number" value="864"></td><td class="line-content">            if (</td></tr><tr><td class="line-number" value="865"></td><td class="line-content">              Array.isArray(parsed) &amp;&amp;</td></tr><tr><td class="line-number" value="866"></td><td class="line-content">              parsed.every((q) =&gt; typeof q.id !== "undefined")</td></tr><tr><td class="line-number" value="867"></td><td class="line-content">            ) {</td></tr><tr><td class="line-number" value="868"></td><td class="line-content">              return parsed;</td></tr><tr><td class="line-number" value="869"></td><td class="line-content">            } else {</td></tr><tr><td class="line-number" value="870"></td><td class="line-content">              console.warn(</td></tr><tr><td class="line-number" value="871"></td><td class="line-content">                "Cached questions format invalid or missing IDs, refetching."</td></tr><tr><td class="line-number" value="872"></td><td class="line-content">              );</td></tr><tr><td class="line-number" value="873"></td><td class="line-content">              localStorage.removeItem("questions");</td></tr><tr><td class="line-number" value="874"></td><td class="line-content">              localStorage.removeItem("questionsTimestamp");</td></tr><tr><td class="line-number" value="875"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="876"></td><td class="line-content">          } catch (e) {</td></tr><tr><td class="line-number" value="877"></td><td class="line-content">            console.error("Error parsing cached questions, fetching fresh.", e);</td></tr><tr><td class="line-number" value="878"></td><td class="line-content">            localStorage.removeItem("questions");</td></tr><tr><td class="line-number" value="879"></td><td class="line-content">            localStorage.removeItem("questionsTimestamp");</td></tr><tr><td class="line-number" value="880"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="881"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="882"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="883"></td><td class="line-content">        console.log("Fetching fresh questions from Firebase...");</td></tr><tr><td class="line-number" value="884"></td><td class="line-content">        try {</td></tr><tr><td class="line-number" value="885"></td><td class="line-content">          const snapshot = await database.ref("questions").once("value");</td></tr><tr><td class="line-number" value="886"></td><td class="line-content">          const questionsData = snapshot.val();</td></tr><tr><td class="line-number" value="887"></td><td class="line-content">          const fetchedQuestions = [];</td></tr><tr><td class="line-number" value="888"></td><td class="line-content">          if (questionsData) {</td></tr><tr><td class="line-number" value="889"></td><td class="line-content">            for (const key in questionsData) {</td></tr><tr><td class="line-number" value="890"></td><td class="line-content">              const q = questionsData[key];</td></tr><tr><td class="line-number" value="891"></td><td class="line-content">              if (</td></tr><tr><td class="line-number" value="892"></td><td class="line-content">                q &amp;&amp;</td></tr><tr><td class="line-number" value="893"></td><td class="line-content">                q.question &amp;&amp;</td></tr><tr><td class="line-number" value="894"></td><td class="line-content">                Array.isArray(q.answers) &amp;&amp;</td></tr><tr><td class="line-number" value="895"></td><td class="line-content">                typeof q.correct !== "undefined"</td></tr><tr><td class="line-number" value="896"></td><td class="line-content">              ) {</td></tr><tr><td class="line-number" value="897"></td><td class="line-content">                q.id = key; // Ensure ID is attached</td></tr><tr><td class="line-number" value="898"></td><td class="line-content">                fetchedQuestions.push(q);</td></tr><tr><td class="line-number" value="899"></td><td class="line-content">              } else {</td></tr><tr><td class="line-number" value="900"></td><td class="line-content">                console.warn(</td></tr><tr><td class="line-number" value="901"></td><td class="line-content">                  `Skipping invalid question data from Firebase with key ${key}:`,</td></tr><tr><td class="line-number" value="902"></td><td class="line-content">                  q</td></tr><tr><td class="line-number" value="903"></td><td class="line-content">                );</td></tr><tr><td class="line-number" value="904"></td><td class="line-content">              }</td></tr><tr><td class="line-number" value="905"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="906"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="907"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="908"></td><td class="line-content">          if (fetchedQuestions.length &gt; 0) {</td></tr><tr><td class="line-number" value="909"></td><td class="line-content">            localStorage.setItem("questions", JSON.stringify(fetchedQuestions));</td></tr><tr><td class="line-number" value="910"></td><td class="line-content">            localStorage.setItem("questionsTimestamp", currentTime.toString());</td></tr><tr><td class="line-number" value="911"></td><td class="line-content">            console.log(</td></tr><tr><td class="line-number" value="912"></td><td class="line-content">              `Fetched and cached ${fetchedQuestions.length} valid questions with IDs.`</td></tr><tr><td class="line-number" value="913"></td><td class="line-content">            );</td></tr><tr><td class="line-number" value="914"></td><td class="line-content">            return fetchedQuestions;</td></tr><tr><td class="line-number" value="915"></td><td class="line-content">          } else {</td></tr><tr><td class="line-number" value="916"></td><td class="line-content">            console.warn("No valid questions found in Firebase!");</td></tr><tr><td class="line-number" value="917"></td><td class="line-content">            return []; // Return empty array if fetch fails</td></tr><tr><td class="line-number" value="918"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="919"></td><td class="line-content">        } catch (error) {</td></tr><tr><td class="line-number" value="920"></td><td class="line-content">          console.error("Error fetching questions from Firebase:", error);</td></tr><tr><td class="line-number" value="921"></td><td class="line-content">          showToast("שגיאה חמורה בטעינת שאלות!");</td></tr><tr><td class="line-number" value="922"></td><td class="line-content">          return []; // Return empty array on error</td></tr><tr><td class="line-number" value="923"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="924"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="925"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="926"></td><td class="line-content">      async function loadQuestionsForTopic(topic) {</td></tr><tr><td class="line-number" value="927"></td><td class="line-content">        try {</td></tr><tr><td class="line-number" value="928"></td><td class="line-content">          showToast("טוען שאלות...", 0); // Show indefinite toast</td></tr><tr><td class="line-number" value="929"></td><td class="line-content">          saveLastTopic(topic); // Save topic preference</td></tr><tr><td class="line-number" value="930"></td><td class="line-content">          allQuestions = await loadQuestions(); // Load (potentially from cache or Firebase)</td></tr><tr><td class="line-number" value="931"></td><td class="line-content">          document.querySelectorAll(".toast").forEach((t) =&gt; t.remove()); // Remove loading toast</td></tr><tr><td class="line-number" value="932"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="933"></td><td class="line-content">          if (allQuestions.length === 0) {</td></tr><tr><td class="line-number" value="934"></td><td class="line-content">             showToast("לא נטענו שאלות. נסה לרענן את הדף.");</td></tr><tr><td class="line-number" value="935"></td><td class="line-content">             return; // Stop if no questions loaded</td></tr><tr><td class="line-number" value="936"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="937"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="938"></td><td class="line-content">          // Filter questions by topic</td></tr><tr><td class="line-number" value="939"></td><td class="line-content">          if (topic === "mix") {</td></tr><tr><td class="line-number" value="940"></td><td class="line-content">            questions = [...allQuestions];</td></tr><tr><td class="line-number" value="941"></td><td class="line-content">          } else {</td></tr><tr><td class="line-number" value="942"></td><td class="line-content">            questions = allQuestions.filter((q) =&gt; q &amp;&amp; q.topic === topic);</td></tr><tr><td class="line-number" value="943"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="944"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="945"></td><td class="line-content">          // Ensure questions are valid before starting</td></tr><tr><td class="line-number" value="946"></td><td class="line-content">          questions = questions.filter(</td></tr><tr><td class="line-number" value="947"></td><td class="line-content">            (q) =&gt;</td></tr><tr><td class="line-number" value="948"></td><td class="line-content">              q &amp;&amp;</td></tr><tr><td class="line-number" value="949"></td><td class="line-content">              q.id &amp;&amp;</td></tr><tr><td class="line-number" value="950"></td><td class="line-content">              q.question &amp;&amp;</td></tr><tr><td class="line-number" value="951"></td><td class="line-content">              Array.isArray(q.answers) &amp;&amp;</td></tr><tr><td class="line-number" value="952"></td><td class="line-content">              typeof q.correct !== "undefined" &amp;&amp;</td></tr><tr><td class="line-number" value="953"></td><td class="line-content">              q.answers.length &gt;= 2 // Need at least 2 answers</td></tr><tr><td class="line-number" value="954"></td><td class="line-content">          );</td></tr><tr><td class="line-number" value="955"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="956"></td><td class="line-content">          if (questions.length === 0) {</td></tr><tr><td class="line-number" value="957"></td><td class="line-content">            showToast(`אין שאלות זמינות לנושא "${topicNames[topic]}"!`);</td></tr><tr><td class="line-number" value="958"></td><td class="line-content">            return; // Stop if no questions for this topic</td></tr><tr><td class="line-number" value="959"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="960"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="961"></td><td class="line-content">          startGame(); // Start the game if questions are ready</td></tr><tr><td class="line-number" value="962"></td><td class="line-content">        } catch (error) {</td></tr><tr><td class="line-number" value="963"></td><td class="line-content">          console.error("Error loading questions for topic:", error);</td></tr><tr><td class="line-number" value="964"></td><td class="line-content">          document.querySelectorAll(".toast").forEach((t) =&gt; t.remove()); // Ensure loading toast is removed on error</td></tr><tr><td class="line-number" value="965"></td><td class="line-content">          showToast("חלה שגיאה בטעינת השאלות!");</td></tr><tr><td class="line-number" value="966"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="967"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="968"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="969"></td><td class="line-content">      function saveLastTopic(topic) {</td></tr><tr><td class="line-number" value="970"></td><td class="line-content">        localStorage.setItem("lastTopic", topic);</td></tr><tr><td class="line-number" value="971"></td><td class="line-content">        if (playerId) {</td></tr><tr><td class="line-number" value="972"></td><td class="line-content">          database</td></tr><tr><td class="line-number" value="973"></td><td class="line-content">            .ref(`players/${playerId}`)</td></tr><tr><td class="line-number" value="974"></td><td class="line-content">            .update({ lastTopic: topic })</td></tr><tr><td class="line-number" value="975"></td><td class="line-content">            .catch((error) =&gt;</td></tr><tr><td class="line-number" value="976"></td><td class="line-content">              console.error("Failed to save last topic:", error)</td></tr><tr><td class="line-number" value="977"></td><td class="line-content">            );</td></tr><tr><td class="line-number" value="978"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="979"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="980"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="981"></td><td class="line-content">      // --- Game Logic ---</td></tr><tr><td class="line-number" value="982"></td><td class="line-content">       function vibrate(duration) {</td></tr><tr><td class="line-number" value="983"></td><td class="line-content">        if ("vibrate" in navigator) {</td></tr><tr><td class="line-number" value="984"></td><td class="line-content">          try { navigator.vibrate(duration); } catch (e) { /* Ignore if fails, e.g., permissions */ }</td></tr><tr><td class="line-number" value="985"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="986"></td><td class="line-content">       }</td></tr><tr><td class="line-number" value="987"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="988"></td><td class="line-content">       function resetGame() {</td></tr><tr><td class="line-number" value="989"></td><td class="line-content">        correctCount = 0;</td></tr><tr><td class="line-number" value="990"></td><td class="line-content">        wrongCount = 0;</td></tr><tr><td class="line-number" value="991"></td><td class="line-content">        currentGameScore = 0; // &lt;&lt;&lt; Reset game score</td></tr><tr><td class="line-number" value="992"></td><td class="line-content">        currentQuestionIndex = 0;</td></tr><tr><td class="line-number" value="993"></td><td class="line-content">        currentQuestion = null;</td></tr><tr><td class="line-number" value="994"></td><td class="line-content">        fiftyFiftyUsed = false;</td></tr><tr><td class="line-number" value="995"></td><td class="line-content">        addTimeUsed = false;</td></tr><tr><td class="line-number" value="996"></td><td class="line-content">        skipUsed = 0;</td></tr><tr><td class="line-number" value="997"></td><td class="line-content">        mistakeDetails = [];</td></tr><tr><td class="line-number" value="998"></td><td class="line-content">        mistakenQuestions = [];</td></tr><tr><td class="line-number" value="999"></td><td class="line-content">        answerSequence = [];</td></tr><tr><td class="line-number" value="1000"></td><td class="line-content">        answeredCorrectly = [];</td></tr><tr><td class="line-number" value="1001"></td><td class="line-content">        gameTagStats = {};</td></tr><tr><td class="line-number" value="1002"></td><td class="line-content">        currentStreak = 0;</td></tr><tr><td class="line-number" value="1003"></td><td class="line-content">        longestStreak = 0;</td></tr><tr><td class="line-number" value="1004"></td><td class="line-content">        timerValue = 120;</td></tr><tr><td class="line-number" value="1005"></td><td class="line-content">        totalTime = 120;</td></tr><tr><td class="line-number" value="1006"></td><td class="line-content">        timerExpired = false;</td></tr><tr><td class="line-number" value="1007"></td><td class="line-content">        gameActive = false;</td></tr><tr><td class="line-number" value="1008"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1009"></td><td class="line-content">        fiftyFiftyButton.classList.remove("disabled");</td></tr><tr><td class="line-number" value="1010"></td><td class="line-content">        addTimeButton.classList.remove("disabled");</td></tr><tr><td class="line-number" value="1011"></td><td class="line-content">        skipButton.classList.remove("disabled");</td></tr><tr><td class="line-number" value="1012"></td><td class="line-content">        fiftyFiftyButton.disabled = false;</td></tr><tr><td class="line-number" value="1013"></td><td class="line-content">        addTimeButton.disabled = false;</td></tr><tr><td class="line-number" value="1014"></td><td class="line-content">        skipButton.disabled = false;</td></tr><tr><td class="line-number" value="1015"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1016"></td><td class="line-content">        percentageTextIngameElement.textContent = "0%";</td></tr><tr><td class="line-number" value="1017"></td><td class="line-content">        percentageProgressElement.style.strokeDashoffset = CIRCLE_CIRCUMFERENCE;</td></tr><tr><td class="line-number" value="1018"></td><td class="line-content">        percentageProgressElement.className.baseVal = "status-circle-progress red";</td></tr><tr><td class="line-number" value="1019"></td><td class="line-content">        timerTextElement.textContent = timerValue;</td></tr><tr><td class="line-number" value="1020"></td><td class="line-content">        timerProgressElement.style.strokeDashoffset = 0;</td></tr><tr><td class="line-number" value="1021"></td><td class="line-content">        timerProgressElement.style.stroke = document.body.classList.contains("dark-mode") ? "#4299e1" : "#7F9CF5";</td></tr><tr><td class="line-number" value="1022"></td><td class="line-content">        clearInterval(timerInterval);</td></tr><tr><td class="line-number" value="1023"></td><td class="line-content">        console.log("Game reset complete.");</td></tr><tr><td class="line-number" value="1024"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1025"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1026"></td><td class="line-content">      function startGame() {</td></tr><tr><td class="line-number" value="1027"></td><td class="line-content">        startScreen.style.display = "none";</td></tr><tr><td class="line-number" value="1028"></td><td class="line-content">        resultScreen.style.display = "none";</td></tr><tr><td class="line-number" value="1029"></td><td class="line-content">        gameScreen.style.display = "block";</td></tr><tr><td class="line-number" value="1030"></td><td class="line-content">        resetGame();</td></tr><tr><td class="line-number" value="1031"></td><td class="line-content">        gameActive = true; // Set game active flag</td></tr><tr><td class="line-number" value="1032"></td><td class="line-content">        questions = [...questions].sort(() =&gt; Math.random() - 0.5); // Shuffle selected questions</td></tr><tr><td class="line-number" value="1033"></td><td class="line-content">        initSequence();</td></tr><tr><td class="line-number" value="1034"></td><td class="line-content">        updatePercentage(); // Initialize percentage display</td></tr><tr><td class="line-number" value="1035"></td><td class="line-content">        loadQuestion(); // Load the first question</td></tr><tr><td class="line-number" value="1036"></td><td class="line-content">        startTimer(); // Start the countdown</td></tr><tr><td class="line-number" value="1037"></td><td class="line-content">        console.log(`Game started with ${questions.length} questions for topic: ${currentTopic}`);</td></tr><tr><td class="line-number" value="1038"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1039"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1040"></td><td class="line-content">      function initSequence() {</td></tr><tr><td class="line-number" value="1041"></td><td class="line-content">        sequenceContainer.innerHTML = "";</td></tr><tr><td class="line-number" value="1042"></td><td class="line-content">        const numCircles = Math.min(5, questions.length); // Show max 5 or total questions if fewer</td></tr><tr><td class="line-number" value="1043"></td><td class="line-content">        for (let i = 1; i &lt;= numCircles; i++) {</td></tr><tr><td class="line-number" value="1044"></td><td class="line-content">          const circle = document.createElement("div");</td></tr><tr><td class="line-number" value="1045"></td><td class="line-content">          circle.classList.add("sequence-circle");</td></tr><tr><td class="line-number" value="1046"></td><td class="line-content">          circle.textContent = i;</td></tr><tr><td class="line-number" value="1047"></td><td class="line-content">          if (i === 1) circle.classList.add("current");</td></tr><tr><td class="line-number" value="1048"></td><td class="line-content">          sequenceContainer.appendChild(circle);</td></tr><tr><td class="line-number" value="1049"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1050"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1051"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1052"></td><td class="line-content">      function shuffleAnswers(answers, correctIndex) {</td></tr><tr><td class="line-number" value="1053"></td><td class="line-content">         if (!Array.isArray(answers)) {</td></tr><tr><td class="line-number" value="1054"></td><td class="line-content">             console.error("Invalid answers array passed to shuffleAnswers:", answers);</td></tr><tr><td class="line-number" value="1055"></td><td class="line-content">             return []; // Return empty array if input is invalid</td></tr><tr><td class="line-number" value="1056"></td><td class="line-content">         }</td></tr><tr><td class="line-number" value="1057"></td><td class="line-content">         // Map to objects with original index/correctness, then shuffle</td></tr><tr><td class="line-number" value="1058"></td><td class="line-content">         const answersCopy = answers.map((answer, idx) =&gt; ({</td></tr><tr><td class="line-number" value="1059"></td><td class="line-content">             text: answer,</td></tr><tr><td class="line-number" value="1060"></td><td class="line-content">             isCorrect: idx === correctIndex,</td></tr><tr><td class="line-number" value="1061"></td><td class="line-content">         }));</td></tr><tr><td class="line-number" value="1062"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1063"></td><td class="line-content">         // Fisher-Yates Shuffle</td></tr><tr><td class="line-number" value="1064"></td><td class="line-content">         for (let i = answersCopy.length - 1; i &gt; 0; i--) {</td></tr><tr><td class="line-number" value="1065"></td><td class="line-content">             const j = Math.floor(Math.random() * (i + 1));</td></tr><tr><td class="line-number" value="1066"></td><td class="line-content">             [answersCopy[i], answersCopy[j]] = [answersCopy[j], answersCopy[i]];</td></tr><tr><td class="line-number" value="1067"></td><td class="line-content">         }</td></tr><tr><td class="line-number" value="1068"></td><td class="line-content">         return answersCopy;</td></tr><tr><td class="line-number" value="1069"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1070"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1071"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1072"></td><td class="line-content">      function loadQuestion() {</td></tr><tr><td class="line-number" value="1073"></td><td class="line-content">        if (!gameActive || (timerExpired &amp;&amp; currentQuestion)) { // Stop loading if game ended or timer ran out *while* showing a question</td></tr><tr><td class="line-number" value="1074"></td><td class="line-content">          console.log("Timer expired or game inactive, preventing next question load.");</td></tr><tr><td class="line-number" value="1075"></td><td class="line-content">           if (gameActive &amp;&amp; !currentQuestion) endGame(); // If timer ended between questions, end immediately</td></tr><tr><td class="line-number" value="1076"></td><td class="line-content">          return;</td></tr><tr><td class="line-number" value="1077"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1078"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1079"></td><td class="line-content">        // --- Mistake Handling Logic ---</td></tr><tr><td class="line-number" value="1080"></td><td class="line-content">        const readyMistakes = [];</td></tr><tr><td class="line-number" value="1081"></td><td class="line-content">        mistakenQuestions = mistakenQuestions.filter((mq) =&gt; {</td></tr><tr><td class="line-number" value="1082"></td><td class="line-content">            if (!mq || !mq.question) return false; // Skip invalid entries</td></tr><tr><td class="line-number" value="1083"></td><td class="line-content">            if (mq.delay &gt; 0) {</td></tr><tr><td class="line-number" value="1084"></td><td class="line-content">                mq.delay--;</td></tr><tr><td class="line-number" value="1085"></td><td class="line-content">                return true; // Keep in pool, decrement delay</td></tr><tr><td class="line-number" value="1086"></td><td class="line-content">            } else {</td></tr><tr><td class="line-number" value="1087"></td><td class="line-content">                readyMistakes.push(mq.question); // Ready to be asked again</td></tr><tr><td class="line-number" value="1088"></td><td class="line-content">                return false; // Remove from waiting pool</td></tr><tr><td class="line-number" value="1089"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1090"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="1091"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1092"></td><td class="line-content">        // --- Filter available questions ---</td></tr><tr><td class="line-number" value="1093"></td><td class="line-content">        let availableRegularQuestions = questions.filter(</td></tr><tr><td class="line-number" value="1094"></td><td class="line-content">            (q) =&gt; q &amp;&amp; q.id &amp;&amp; q.question &amp;&amp; // Basic validity</td></tr><tr><td class="line-number" value="1095"></td><td class="line-content">                   !answeredCorrectly.some((aq) =&gt; aq &amp;&amp; aq.id === q.id) &amp;&amp; // Not already answered correctly</td></tr><tr><td class="line-number" value="1096"></td><td class="line-content">                   !mistakenQuestions.some((mq) =&gt; mq &amp;&amp; mq.question.id === q.id) &amp;&amp; // Not waiting in the mistake pool</td></tr><tr><td class="line-number" value="1097"></td><td class="line-content">                   !readyMistakes.some((rm) =&gt; rm &amp;&amp; rm.id === q.id) // Not just moved to ready mistakes</td></tr><tr><td class="line-number" value="1098"></td><td class="line-content">        );</td></tr><tr><td class="line-number" value="1099"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1100"></td><td class="line-content">        console.log(`Available regular: ${availableRegularQuestions.length}, Ready mistakes: ${readyMistakes.length}, Waiting mistakes: ${mistakenQuestions.length}`);</td></tr><tr><td class="line-number" value="1101"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1102"></td><td class="line-content">        // --- Check if game should end ---</td></tr><tr><td class="line-number" value="1103"></td><td class="line-content">        if (availableRegularQuestions.length === 0 &amp;&amp; readyMistakes.length === 0 &amp;&amp; mistakenQuestions.length === 0) {</td></tr><tr><td class="line-number" value="1104"></td><td class="line-content">            console.log("No more questions or mistakes. Ending game.");</td></tr><tr><td class="line-number" value="1105"></td><td class="line-content">            if (gameActive) endGame(); // End the game if truly out of questions</td></tr><tr><td class="line-number" value="1106"></td><td class="line-content">            return;</td></tr><tr><td class="line-number" value="1107"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1108"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1109"></td><td class="line-content">        // --- Select the next question ---</td></tr><tr><td class="line-number" value="1110"></td><td class="line-content">        let nextQuestion = null;</td></tr><tr><td class="line-number" value="1111"></td><td class="line-content">        const showMistakeChance = 0.4; // 40% chance to show a ready mistake if available</td></tr><tr><td class="line-number" value="1112"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1113"></td><td class="line-content">        if (readyMistakes.length &gt; 0 &amp;&amp; (availableRegularQuestions.length === 0 || Math.random() &lt; showMistakeChance)) {</td></tr><tr><td class="line-number" value="1114"></td><td class="line-content">            // Prioritize mistakes if available (or if no regular questions left)</td></tr><tr><td class="line-number" value="1115"></td><td class="line-content">            const randomIndex = Math.floor(Math.random() * readyMistakes.length);</td></tr><tr><td class="line-number" value="1116"></td><td class="line-content">            nextQuestion = readyMistakes.splice(randomIndex, 1)[0]; // Get and remove from ready list</td></tr><tr><td class="line-number" value="1117"></td><td class="line-content">             console.log("Loading a mistake question:", nextQuestion.id);</td></tr><tr><td class="line-number" value="1118"></td><td class="line-content">        } else if (availableRegularQuestions.length &gt; 0) {</td></tr><tr><td class="line-number" value="1119"></td><td class="line-content">            // Load a regular question</td></tr><tr><td class="line-number" value="1120"></td><td class="line-content">            if (currentQuestionIndex &gt;= availableRegularQuestions.length) {</td></tr><tr><td class="line-number" value="1121"></td><td class="line-content">                currentQuestionIndex = 0; // Loop back if needed (though ideally we shuffle once)</td></tr><tr><td class="line-number" value="1122"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1123"></td><td class="line-content">            nextQuestion = availableRegularQuestions[currentQuestionIndex];</td></tr><tr><td class="line-number" value="1124"></td><td class="line-content">            currentQuestionIndex++; // Increment for next time</td></tr><tr><td class="line-number" value="1125"></td><td class="line-content">            console.log(`Loading regular question #${currentQuestionIndex}:`, nextQuestion.id);</td></tr><tr><td class="line-number" value="1126"></td><td class="line-content">        } else if (readyMistakes.length &gt; 0) {</td></tr><tr><td class="line-number" value="1127"></td><td class="line-content">             // Fallback: if random chance didn't pick mistake, but it's the only option left</td></tr><tr><td class="line-number" value="1128"></td><td class="line-content">             const randomIndex = Math.floor(Math.random() * readyMistakes.length);</td></tr><tr><td class="line-number" value="1129"></td><td class="line-content">             nextQuestion = readyMistakes.splice(randomIndex, 1)[0];</td></tr><tr><td class="line-number" value="1130"></td><td class="line-content">             console.log("Loading a fallback mistake question:", nextQuestion.id);</td></tr><tr><td class="line-number" value="1131"></td><td class="line-content">        } else {</td></tr><tr><td class="line-number" value="1132"></td><td class="line-content">             console.warn("Question selection logic failed - should have ended or found a question. Ending game.");</td></tr><tr><td class="line-number" value="1133"></td><td class="line-content">             if (gameActive) endGame();</td></tr><tr><td class="line-number" value="1134"></td><td class="line-content">             return;</td></tr><tr><td class="line-number" value="1135"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1136"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1137"></td><td class="line-content">        // Put remaining ready mistakes back into the waiting pool (with delay 0, essentially ready for next cycle)</td></tr><tr><td class="line-number" value="1138"></td><td class="line-content">        readyMistakes.forEach((m) =&gt; {</td></tr><tr><td class="line-number" value="1139"></td><td class="line-content">            if (!mistakenQuestions.some((mq) =&gt; mq &amp;&amp; mq.question.id === m.id)) {</td></tr><tr><td class="line-number" value="1140"></td><td class="line-content">                mistakenQuestions.push({ question: m, delay: 0 });</td></tr><tr><td class="line-number" value="1141"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1142"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="1143"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1144"></td><td class="line-content">        // --- Validate the selected question ---</td></tr><tr><td class="line-number" value="1145"></td><td class="line-content">        if (!nextQuestion || !nextQuestion.id || !nextQuestion.question || !Array.isArray(nextQuestion.answers) || typeof nextQuestion.correct === "undefined" || nextQuestion.answers.length &lt; 2) {</td></tr><tr><td class="line-number" value="1146"></td><td class="line-content">            console.error("Invalid question data selected:", nextQuestion, "Attempting to skip and load another...");</td></tr><tr><td class="line-number" value="1147"></td><td class="line-content">            // Remove the problematic question from the main 'questions' list to prevent re-selection</td></tr><tr><td class="line-number" value="1148"></td><td class="line-content">            questions = questions.filter(q =&gt; q !== nextQuestion);</td></tr><tr><td class="line-number" value="1149"></td><td class="line-content">             // Also remove from mistake pools if it was there</td></tr><tr><td class="line-number" value="1150"></td><td class="line-content">            mistakenQuestions = mistakenQuestions.filter(mq =&gt; mq.question !== nextQuestion);</td></tr><tr><td class="line-number" value="1151"></td><td class="line-content">            // Immediately try to load the *next* available question</td></tr><tr><td class="line-number" value="1152"></td><td class="line-content">            loadQuestion();</td></tr><tr><td class="line-number" value="1153"></td><td class="line-content">            return;</td></tr><tr><td class="line-number" value="1154"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1155"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1156"></td><td class="line-content">        currentQuestion = nextQuestion;</td></tr><tr><td class="line-number" value="1157"></td><td class="line-content">        currentQuestion.startTime = Date.now(); // Record when question was shown for potential time bonus calculation</td></tr><tr><td class="line-number" value="1158"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1159"></td><td class="line-content">        // Shuffle answers *safely*</td></tr><tr><td class="line-number" value="1160"></td><td class="line-content">        currentQuestion.shuffledAnswers = shuffleAnswers([...currentQuestion.answers], currentQuestion.correct); // Use spread to avoid modifying original</td></tr><tr><td class="line-number" value="1161"></td><td class="line-content">        if (!Array.isArray(currentQuestion.shuffledAnswers) || currentQuestion.shuffledAnswers.length &lt; 2) {</td></tr><tr><td class="line-number" value="1162"></td><td class="line-content">           console.error("Failed to shuffle answers or not enough answers for:", currentQuestion.id, "Skipping...");</td></tr><tr><td class="line-number" value="1163"></td><td class="line-content">           questions = questions.filter(q =&gt; q !== currentQuestion);</td></tr><tr><td class="line-number" value="1164"></td><td class="line-content">           mistakenQuestions = mistakenQuestions.filter(mq =&gt; mq.question !== currentQuestion);</td></tr><tr><td class="line-number" value="1165"></td><td class="line-content">           loadQuestion(); // Try loading another one</td></tr><tr><td class="line-number" value="1166"></td><td class="line-content">           return;</td></tr><tr><td class="line-number" value="1167"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1168"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1169"></td><td class="line-content">        // --- Display Question and Answers ---</td></tr><tr><td class="line-number" value="1170"></td><td class="line-content">        questionElement.innerHTML = ""; // Clear previous question</td></tr><tr><td class="line-number" value="1171"></td><td class="line-content">        const questionTextNode = document.createTextNode(currentQuestion.question);</td></tr><tr><td class="line-number" value="1172"></td><td class="line-content">        questionElement.appendChild(questionTextNode);</td></tr><tr><td class="line-number" value="1173"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1174"></td><td class="line-content">        // Optional: Add debug/info span (initially hidden)</td></tr><tr><td class="line-number" value="1175"></td><td class="line-content">        // const infoSpan = document.createElement("span");</td></tr><tr><td class="line-number" value="1176"></td><td class="line-content">        // infoSpan.className = "question-id-display";</td></tr><tr><td class="line-number" value="1177"></td><td class="line-content">        // infoSpan.textContent = ` (ID: ${currentQuestion.id})`; // Show ID for debugging</td></tr><tr><td class="line-number" value="1178"></td><td class="line-content">        // questionElement.appendChild(infoSpan);</td></tr><tr><td class="line-number" value="1179"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1180"></td><td class="line-content">        answersElement.innerHTML = ""; // Clear previous answers</td></tr><tr><td class="line-number" value="1181"></td><td class="line-content">        currentQuestion.shuffledAnswers.forEach((answer, index) =&gt; {</td></tr><tr><td class="line-number" value="1182"></td><td class="line-content">            const button = document.createElement("button");</td></tr><tr><td class="line-number" value="1183"></td><td class="line-content">            button.classList.add("answer-btn");</td></tr><tr><td class="line-number" value="1184"></td><td class="line-content">            button.textContent = answer.text;</td></tr><tr><td class="line-number" value="1185"></td><td class="line-content">            button.style.visibility = 'visible'; // Ensure button is visible initially</td></tr><tr><td class="line-number" value="1186"></td><td class="line-content">            button.disabled = false; // Ensure button is enabled</td></tr><tr><td class="line-number" value="1187"></td><td class="line-content">            button.addEventListener("click", () =&gt; {</td></tr><tr><td class="line-number" value="1188"></td><td class="line-content">                vibrate(50);</td></tr><tr><td class="line-number" value="1189"></td><td class="line-content">                checkAnswer(index);</td></tr><tr><td class="line-number" value="1190"></td><td class="line-content">            });</td></tr><tr><td class="line-number" value="1191"></td><td class="line-content">            answersElement.appendChild(button);</td></tr><tr><td class="line-number" value="1192"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="1193"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1194"></td><td class="line-content">        // Re-enable action buttons if they were disabled by skip/timer</td></tr><tr><td class="line-number" value="1195"></td><td class="line-content">        fiftyFiftyButton.disabled = fiftyFiftyUsed || timerExpired;</td></tr><tr><td class="line-number" value="1196"></td><td class="line-content">        addTimeButton.disabled = addTimeUsed || timerExpired;</td></tr><tr><td class="line-number" value="1197"></td><td class="line-content">        skipButton.disabled = timerExpired; // Allow skip unless timer is up</td></tr><tr><td class="line-number" value="1198"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1199"></td><td class="line-content">        updateSequence(); // Update the progress circles</td></tr><tr><td class="line-number" value="1200"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1201"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1202"></td><td class="line-content">      // --- Scoring Popup ---</td></tr><tr><td class="line-number" value="1203"></td><td class="line-content">      function createScorePopup(score) {</td></tr><tr><td class="line-number" value="1204"></td><td class="line-content">        const popup = document.createElement("div");</td></tr><tr><td class="line-number" value="1205"></td><td class="line-content">        popup.classList.add("score-popup");</td></tr><tr><td class="line-number" value="1206"></td><td class="line-content">        popup.textContent = `+${score}`;</td></tr><tr><td class="line-number" value="1207"></td><td class="line-content">        document.body.appendChild(popup);</td></tr><tr><td class="line-number" value="1208"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1209"></td><td class="line-content">        // Trigger the animation</td></tr><tr><td class="line-number" value="1210"></td><td class="line-content">        requestAnimationFrame(() =&gt; {</td></tr><tr><td class="line-number" value="1211"></td><td class="line-content">            popup.classList.add("show");</td></tr><tr><td class="line-number" value="1212"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="1213"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1214"></td><td class="line-content">        // Remove after animation</td></tr><tr><td class="line-number" value="1215"></td><td class="line-content">        setTimeout(() =&gt; {</td></tr><tr><td class="line-number" value="1216"></td><td class="line-content">            popup.classList.remove("show");</td></tr><tr><td class="line-number" value="1217"></td><td class="line-content">            setTimeout(() =&gt; {</td></tr><tr><td class="line-number" value="1218"></td><td class="line-content">                if (popup.parentNode) {</td></tr><tr><td class="line-number" value="1219"></td><td class="line-content">                    popup.parentNode.removeChild(popup);</td></tr><tr><td class="line-number" value="1220"></td><td class="line-content">                }</td></tr><tr><td class="line-number" value="1221"></td><td class="line-content">            }, 600); // Match transition duration</td></tr><tr><td class="line-number" value="1222"></td><td class="line-content">        }, 1000); // How long the popup stays visible before fading</td></tr><tr><td class="line-number" value="1223"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1224"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1225"></td><td class="line-content">       // --- Update Player Stats in Firebase ---</td></tr><tr><td class="line-number" value="1226"></td><td class="line-content">      async function updatePlayerStatsFirebase(playerId, question, isCorrect, scoreGained = 0) {</td></tr><tr><td class="line-number" value="1227"></td><td class="line-content">        if (!playerId || !question) return;</td></tr><tr><td class="line-number" value="1228"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1229"></td><td class="line-content">        const updates = {};</td></tr><tr><td class="line-number" value="1230"></td><td class="line-content">        const topic = question.topic || "unknown";</td></tr><tr><td class="line-number" value="1231"></td><td class="line-content">        const tags = Array.isArray(question.tags) ? question.tags.filter(t =&gt; t) : []; // Ensure tags is a clean array</td></tr><tr><td class="line-number" value="1232"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1233"></td><td class="line-content">        // Use Firebase Transactions for score and counts to prevent race conditions</td></tr><tr><td class="line-number" value="1234"></td><td class="line-content">        const playerRef = database.ref(`players/${playerId}`);</td></tr><tr><td class="line-number" value="1235"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1236"></td><td class="line-content">        try {</td></tr><tr><td class="line-number" value="1237"></td><td class="line-content">          await playerRef.transaction((playerData) =&gt; {</td></tr><tr><td class="line-number" value="1238"></td><td class="line-content">            if (playerData === null) {</td></tr><tr><td class="line-number" value="1239"></td><td class="line-content">              // Initialize if player data doesn't exist (shouldn't happen often after initial save)</td></tr><tr><td class="line-number" value="1240"></td><td class="line-content">              playerData = {</td></tr><tr><td class="line-number" value="1241"></td><td class="line-content">                cumulativeScore: 0,</td></tr><tr><td class="line-number" value="1242"></td><td class="line-content">                correctCount: 0,</td></tr><tr><td class="line-number" value="1243"></td><td class="line-content">                wrongCount: 0,</td></tr><tr><td class="line-number" value="1244"></td><td class="line-content">                nickname: playerNickname, // Use current nickname</td></tr><tr><td class="line-number" value="1245"></td><td class="line-content">                topicStats: {},</td></tr><tr><td class="line-number" value="1246"></td><td class="line-content">                tagStats: {}</td></tr><tr><td class="line-number" value="1247"></td><td class="line-content">              };</td></tr><tr><td class="line-number" value="1248"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1249"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1250"></td><td class="line-content">            // Overall stats</td></tr><tr><td class="line-number" value="1251"></td><td class="line-content">            playerData.cumulativeScore = (playerData.cumulativeScore || 0) + scoreGained;</td></tr><tr><td class="line-number" value="1252"></td><td class="line-content">            playerData.correctCount = (playerData.correctCount || 0) + (isCorrect ? 1 : 0);</td></tr><tr><td class="line-number" value="1253"></td><td class="line-content">            playerData.wrongCount = (playerData.wrongCount || 0) + (isCorrect ? 0 : 1);</td></tr><tr><td class="line-number" value="1254"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1255"></td><td class="line-content">            // Topic stats</td></tr><tr><td class="line-number" value="1256"></td><td class="line-content">            if (!playerData.topicStats) playerData.topicStats = {};</td></tr><tr><td class="line-number" value="1257"></td><td class="line-content">            if (!playerData.topicStats[topic]) playerData.topicStats[topic] = { correctCount: 0, wrongCount: 0 };</td></tr><tr><td class="line-number" value="1258"></td><td class="line-content">            playerData.topicStats[topic].correctCount = (playerData.topicStats[topic].correctCount || 0) + (isCorrect ? 1 : 0);</td></tr><tr><td class="line-number" value="1259"></td><td class="line-content">            playerData.topicStats[topic].wrongCount = (playerData.topicStats[topic].wrongCount || 0) + (isCorrect ? 0 : 1);</td></tr><tr><td class="line-number" value="1260"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1261"></td><td class="line-content">            // Tag stats</td></tr><tr><td class="line-number" value="1262"></td><td class="line-content">            if (!playerData.tagStats) playerData.tagStats = {};</td></tr><tr><td class="line-number" value="1263"></td><td class="line-content">            tags.forEach(tag =&gt; {</td></tr><tr><td class="line-number" value="1264"></td><td class="line-content">                if (!playerData.tagStats[tag]) playerData.tagStats[tag] = { correctCount: 0, wrongCount: 0 };</td></tr><tr><td class="line-number" value="1265"></td><td class="line-content">                playerData.tagStats[tag].correctCount = (playerData.tagStats[tag].correctCount || 0) + (isCorrect ? 1 : 0);</td></tr><tr><td class="line-number" value="1266"></td><td class="line-content">                playerData.tagStats[tag].wrongCount = (playerData.tagStats[tag].wrongCount || 0) + (isCorrect ? 0 : 1);</td></tr><tr><td class="line-number" value="1267"></td><td class="line-content">            });</td></tr><tr><td class="line-number" value="1268"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1269"></td><td class="line-content">            return playerData; // Return the modified data for Firebase to save</td></tr><tr><td class="line-number" value="1270"></td><td class="line-content">          });</td></tr><tr><td class="line-number" value="1271"></td><td class="line-content">          console.log("Player stats updated via transaction.");</td></tr><tr><td class="line-number" value="1272"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1273"></td><td class="line-content">          // Update local cumulative score *after* successful transaction</td></tr><tr><td class="line-number" value="1274"></td><td class="line-content">          cumulativePlayerScore += scoreGained;</td></tr><tr><td class="line-number" value="1275"></td><td class="line-content">          localStorage.setItem("cumulativeScoreBackup", cumulativePlayerScore.toString()); // Backup locally</td></tr><tr><td class="line-number" value="1276"></td><td class="line-content">          updateCumulativeScoreDisplay(); // Update UI immediately</td></tr><tr><td class="line-number" value="1277"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1278"></td><td class="line-content">        } catch (error) {</td></tr><tr><td class="line-number" value="1279"></td><td class="line-content">          console.error("Firebase transaction failed: ", error);</td></tr><tr><td class="line-number" value="1280"></td><td class="line-content">          // Handle error - maybe retry or notify user</td></tr><tr><td class="line-number" value="1281"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1282"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1283"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1284"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1285"></td><td class="line-content">      function checkAnswer(selectedIndex) {</td></tr><tr><td class="line-number" value="1286"></td><td class="line-content">        if (!gameActive || !currentQuestion || !currentQuestion.shuffledAnswers) return; // Ensure game/question are valid</td></tr><tr><td class="line-number" value="1287"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1288"></td><td class="line-content">        const answerTime = Date.now();</td></tr><tr><td class="line-number" value="1289"></td><td class="line-content">        const timeTakenMs = answerTime - (currentQuestion.startTime || answerTime); // Calculate time taken for this question</td></tr><tr><td class="line-number" value="1290"></td><td class="line-content">        const timeTakenSec = Math.max(0, Math.floor(timeTakenMs / 1000)); // Time in seconds</td></tr><tr><td class="line-number" value="1291"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1292"></td><td class="line-content">        const buttons = answersElement.querySelectorAll(".answer-btn");</td></tr><tr><td class="line-number" value="1293"></td><td class="line-content">        buttons.forEach(btn =&gt; btn.disabled = true); // Disable buttons immediately</td></tr><tr><td class="line-number" value="1294"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1295"></td><td class="line-content">        const correctAnswerObject = currentQuestion.shuffledAnswers.find(a =&gt; a.isCorrect);</td></tr><tr><td class="line-number" value="1296"></td><td class="line-content">        const selectedAnswerObject = currentQuestion.shuffledAnswers[selectedIndex];</td></tr><tr><td class="line-number" value="1297"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1298"></td><td class="line-content">        // Extra safety checks</td></tr><tr><td class="line-number" value="1299"></td><td class="line-content">        if (!selectedAnswerObject || typeof selectedAnswerObject.isCorrect === 'undefined' || !correctAnswerObject) {</td></tr><tr><td class="line-number" value="1300"></td><td class="line-content">            console.error("Error identifying selected or correct answer object.");</td></tr><tr><td class="line-number" value="1301"></td><td class="line-content">            // Maybe skip to next question without penalty?</td></tr><tr><td class="line-number" value="1302"></td><td class="line-content">            setTimeout(loadQuestion, 1200);</td></tr><tr><td class="line-number" value="1303"></td><td class="line-content">            return;</td></tr><tr><td class="line-number" value="1304"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1305"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1306"></td><td class="line-content">        const isCorrect = selectedAnswerObject.isCorrect;</td></tr><tr><td class="line-number" value="1307"></td><td class="line-content">        const questionNumber = correctCount + wrongCount + 1;</td></tr><tr><td class="line-number" value="1308"></td><td class="line-content">        let questionScore = 0; // Initialize score for this question</td></tr><tr><td class="line-number" value="1309"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1310"></td><td class="line-content">        // Visual feedback</td></tr><tr><td class="line-number" value="1311"></td><td class="line-content">        buttons.forEach((btn, idx) =&gt; {</td></tr><tr><td class="line-number" value="1312"></td><td class="line-content">            if (currentQuestion.shuffledAnswers[idx]?.isCorrect) {</td></tr><tr><td class="line-number" value="1313"></td><td class="line-content">                btn.classList.add("correct");</td></tr><tr><td class="line-number" value="1314"></td><td class="line-content">            } else if (idx === selectedIndex) {</td></tr><tr><td class="line-number" value="1315"></td><td class="line-content">                btn.classList.add("wrong");</td></tr><tr><td class="line-number" value="1316"></td><td class="line-content">            } else {</td></tr><tr><td class="line-number" value="1317"></td><td class="line-content">                // Fade out non-selected, incorrect answers slightly more</td></tr><tr><td class="line-number" value="1318"></td><td class="line-content">                 if (btn.style.visibility !== 'hidden') { // Don't change opacity if hidden by 50:50</td></tr><tr><td class="line-number" value="1319"></td><td class="line-content">                    btn.style.opacity = "0.5";</td></tr><tr><td class="line-number" value="1320"></td><td class="line-content">                 }</td></tr><tr><td class="line-number" value="1321"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1322"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="1323"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1324"></td><td class="line-content">        // Update stats &amp; score</td></tr><tr><td class="line-number" value="1325"></td><td class="line-content">        if (isCorrect) {</td></tr><tr><td class="line-number" value="1326"></td><td class="line-content">            correctCount++;</td></tr><tr><td class="line-number" value="1327"></td><td class="line-content">            currentStreak++;</td></tr><tr><td class="line-number" value="1328"></td><td class="line-content">            longestStreak = Math.max(longestStreak, currentStreak);</td></tr><tr><td class="line-number" value="1329"></td><td class="line-content">            answerSequence.push({ number: questionNumber, correct: true });</td></tr><tr><td class="line-number" value="1330"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1331"></td><td class="line-content">            // --- Calculate Score ---</td></tr><tr><td class="line-number" value="1332"></td><td class="line-content">            const timeBonus = Math.max(0, Math.floor((15 - timeTakenSec) / 2)); // Bonus for answering within 15s, max ~7 points</td></tr><tr><td class="line-number" value="1333"></td><td class="line-content">            const streakBonus = (currentStreak &gt; 1) ? (currentStreak -1) * STREAK_BONUS_MULTIPLIER : 0; // Bonus starts from 2nd correct answer</td></tr><tr><td class="line-number" value="1334"></td><td class="line-content">            questionScore = BASE_SCORE_PER_QUESTION + timeBonus + streakBonus;</td></tr><tr><td class="line-number" value="1335"></td><td class="line-content">            currentGameScore += questionScore;</td></tr><tr><td class="line-number" value="1336"></td><td class="line-content">            createScorePopup(questionScore); // Show visual feedback</td></tr><tr><td class="line-number" value="1337"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1338"></td><td class="line-content">            // Remove from mistake pool if it was there</td></tr><tr><td class="line-number" value="1339"></td><td class="line-content">            const mistakeIndex = mistakenQuestions.findIndex((mq) =&gt; mq &amp;&amp; mq.question.id === currentQuestion.id);</td></tr><tr><td class="line-number" value="1340"></td><td class="line-content">            if (mistakeIndex &gt; -1) {</td></tr><tr><td class="line-number" value="1341"></td><td class="line-content">                mistakenQuestions.splice(mistakeIndex, 1);</td></tr><tr><td class="line-number" value="1342"></td><td class="line-content">                console.log("Corrected a mistake, removed from pool.");</td></tr><tr><td class="line-number" value="1343"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1344"></td><td class="line-content">            // Add to correctly answered list (only if not already there)</td></tr><tr><td class="line-number" value="1345"></td><td class="line-content">            if (!answeredCorrectly.some((aq) =&gt; aq &amp;&amp; aq.id === currentQuestion.id)) {</td></tr><tr><td class="line-number" value="1346"></td><td class="line-content">                 answeredCorrectly.push(currentQuestion);</td></tr><tr><td class="line-number" value="1347"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1348"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1349"></td><td class="line-content">        } else {</td></tr><tr><td class="line-number" value="1350"></td><td class="line-content">            wrongCount++;</td></tr><tr><td class="line-number" value="1351"></td><td class="line-content">            currentStreak = 0; // Reset streak</td></tr><tr><td class="line-number" value="1352"></td><td class="line-content">            questionScore = 0; // No score for wrong answer</td></tr><tr><td class="line-number" value="1353"></td><td class="line-content">            answerSequence.push({ number: questionNumber, correct: false });</td></tr><tr><td class="line-number" value="1354"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1355"></td><td class="line-content">            // Add to mistake details for review</td></tr><tr><td class="line-number" value="1356"></td><td class="line-content">            mistakeDetails.push({</td></tr><tr><td class="line-number" value="1357"></td><td class="line-content">                question: currentQuestion.question,</td></tr><tr><td class="line-number" value="1358"></td><td class="line-content">                selected: selectedAnswerObject.text,</td></tr><tr><td class="line-number" value="1359"></td><td class="line-content">                correct: correctAnswerObject.text,</td></tr><tr><td class="line-number" value="1360"></td><td class="line-content">                tags: currentQuestion.tags || []</td></tr><tr><td class="line-number" value="1361"></td><td class="line-content">            });</td></tr><tr><td class="line-number" value="1362"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1363"></td><td class="line-content">            // Add/update in mistake pool for re-asking</td></tr><tr><td class="line-number" value="1364"></td><td class="line-content">            const mistakeIndex = mistakenQuestions.findIndex((mq) =&gt; mq &amp;&amp; mq.question.id === currentQuestion.id);</td></tr><tr><td class="line-number" value="1365"></td><td class="line-content">            const delay = Math.floor(Math.random() * 3) + 2; // Delay 2-4 questions</td></tr><tr><td class="line-number" value="1366"></td><td class="line-content">            if (mistakeIndex === -1) {</td></tr><tr><td class="line-number" value="1367"></td><td class="line-content">                 // Only add if not already answered correctly in this session</td></tr><tr><td class="line-number" value="1368"></td><td class="line-content">                 if (!answeredCorrectly.some(aq =&gt; aq &amp;&amp; aq.id === currentQuestion.id)) {</td></tr><tr><td class="line-number" value="1369"></td><td class="line-content">                    mistakenQuestions.push({ question: currentQuestion, delay: delay });</td></tr><tr><td class="line-number" value="1370"></td><td class="line-content">                    console.log(`Added mistake ${currentQuestion.id} to pool with delay ${delay}. Pool size: ${mistakenQuestions.length}`);</td></tr><tr><td class="line-number" value="1371"></td><td class="line-content">                 } else {</td></tr><tr><td class="line-number" value="1372"></td><td class="line-content">                    console.log(`Mistake ${currentQuestion.id} answered wrong, but already answered correctly earlier. Not adding back.`);</td></tr><tr><td class="line-number" value="1373"></td><td class="line-content">                 }</td></tr><tr><td class="line-number" value="1374"></td><td class="line-content">            } else {</td></tr><tr><td class="line-number" value="1375"></td><td class="line-content">                mistakenQuestions[mistakeIndex].delay = delay; // Reset delay if answered wrong again</td></tr><tr><td class="line-number" value="1376"></td><td class="line-content">                console.log(`Mistake ${currentQuestion.id} answered wrong again, resetting delay to ${delay}.`);</td></tr><tr><td class="line-number" value="1377"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1378"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1379"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1380"></td><td class="line-content">        // --- Update Tag Stats (Local for this game) ---</td></tr><tr><td class="line-number" value="1381"></td><td class="line-content">        const questionTags = Array.isArray(currentQuestion.tags) ? currentQuestion.tags.filter(t =&gt; t) : [];</td></tr><tr><td class="line-number" value="1382"></td><td class="line-content">        questionTags.forEach((tag) =&gt; {</td></tr><tr><td class="line-number" value="1383"></td><td class="line-content">            if (!gameTagStats[tag]) gameTagStats[tag] = { correct: 0, wrong: 0 };</td></tr><tr><td class="line-number" value="1384"></td><td class="line-content">            gameTagStats[tag][isCorrect ? "correct" : "wrong"]++;</td></tr><tr><td class="line-number" value="1385"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="1386"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1387"></td><td class="line-content">        // --- Update Player Stats in Firebase ---</td></tr><tr><td class="line-number" value="1388"></td><td class="line-content">        if (playerId) {</td></tr><tr><td class="line-number" value="1389"></td><td class="line-content">            updatePlayerStatsFirebase(playerId, currentQuestion, isCorrect, questionScore);</td></tr><tr><td class="line-number" value="1390"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1391"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1392"></td><td class="line-content">        updatePercentage(); // Update the accuracy circle</td></tr><tr><td class="line-number" value="1393"></td><td class="line-content">        currentQuestion = null; // Mark question as processed</td></tr><tr><td class="line-number" value="1394"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1395"></td><td class="line-content">        // --- Load Next Question or End Game ---</td></tr><tr><td class="line-number" value="1396"></td><td class="line-content">        if (timerExpired) { // If timer ran out *while* answering this question</td></tr><tr><td class="line-number" value="1397"></td><td class="line-content">            console.log("Timer expired, ending game after answering last question.");</td></tr><tr><td class="line-number" value="1398"></td><td class="line-content">            setTimeout(endGame, 1200); // End game after feedback delay</td></tr><tr><td class="line-number" value="1399"></td><td class="line-content">        } else {</td></tr><tr><td class="line-number" value="1400"></td><td class="line-content">            setTimeout(loadQuestion, 1200); // Load next question after feedback delay</td></tr><tr><td class="line-number" value="1401"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1402"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1403"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1404"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1405"></td><td class="line-content">      function updateSequence() {</td></tr><tr><td class="line-number" value="1406"></td><td class="line-content">        sequenceContainer.innerHTML = ""; // Clear existing circles</td></tr><tr><td class="line-number" value="1407"></td><td class="line-content">        const totalAnswered = answerSequence.length;</td></tr><tr><td class="line-number" value="1408"></td><td class="line-content">        const currentQNumInGame = totalAnswered + 1;</td></tr><tr><td class="line-number" value="1409"></td><td class="line-content">        const displayCount = sequenceContainer.children.length &gt; 0 ? sequenceContainer.children.length : 5; // Use existing count or default 5</td></tr><tr><td class="line-number" value="1410"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1411"></td><td class="line-content">        // Determine the first number to display (centers the current number if possible)</td></tr><tr><td class="line-number" value="1412"></td><td class="line-content">        let startNum = Math.max(1, currentQNumInGame - Math.floor(displayCount / 2));</td></tr><tr><td class="line-number" value="1413"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1414"></td><td class="line-content">        for (let i = 0; i &lt; displayCount; i++) {</td></tr><tr><td class="line-number" value="1415"></td><td class="line-content">            const displayNum = startNum + i;</td></tr><tr><td class="line-number" value="1416"></td><td class="line-content">            const circle = document.createElement("div");</td></tr><tr><td class="line-number" value="1417"></td><td class="line-content">            circle.classList.add("sequence-circle");</td></tr><tr><td class="line-number" value="1418"></td><td class="line-content">            circle.textContent = displayNum;</td></tr><tr><td class="line-number" value="1419"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1420"></td><td class="line-content">            // Find the corresponding answer in the sequence</td></tr><tr><td class="line-number" value="1421"></td><td class="line-content">            const answer = answerSequence.find((a) =&gt; a.number === displayNum);</td></tr><tr><td class="line-number" value="1422"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1423"></td><td class="line-content">            if (displayNum === currentQNumInGame) {</td></tr><tr><td class="line-number" value="1424"></td><td class="line-content">                circle.classList.add("current"); // Highlight the upcoming question number</td></tr><tr><td class="line-number" value="1425"></td><td class="line-content">            } else if (answer) {</td></tr><tr><td class="line-number" value="1426"></td><td class="line-content">                // Style based on past answer</td></tr><tr><td class="line-number" value="1427"></td><td class="line-content">                circle.classList.add(answer.correct ? "correct" : "wrong");</td></tr><tr><td class="line-number" value="1428"></td><td class="line-content">            } else {</td></tr><tr><td class="line-number" value="1429"></td><td class="line-content">                // Future questions remain default style</td></tr><tr><td class="line-number" value="1430"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1431"></td><td class="line-content">            sequenceContainer.appendChild(circle);</td></tr><tr><td class="line-number" value="1432"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1433"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1434"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1435"></td><td class="line-content">      function updatePercentage() {</td></tr><tr><td class="line-number" value="1436"></td><td class="line-content">        const total = correctCount + wrongCount;</td></tr><tr><td class="line-number" value="1437"></td><td class="line-content">        const percentage = total === 0 ? 0 : Math.round((correctCount / total) * 100);</td></tr><tr><td class="line-number" value="1438"></td><td class="line-content">        percentageTextIngameElement.textContent = `${percentage}%`;</td></tr><tr><td class="line-number" value="1439"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1440"></td><td class="line-content">        // Update progress circle</td></tr><tr><td class="line-number" value="1441"></td><td class="line-content">        const offset = CIRCLE_CIRCUMFERENCE * (1 - percentage / 100);</td></tr><tr><td class="line-number" value="1442"></td><td class="line-content">        percentageProgressElement.style.strokeDashoffset = Math.max(0, Math.min(CIRCLE_CIRCUMFERENCE, offset));</td></tr><tr><td class="line-number" value="1443"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1444"></td><td class="line-content">        // Update progress circle color</td></tr><tr><td class="line-number" value="1445"></td><td class="line-content">        let colorClass = "red";</td></tr><tr><td class="line-number" value="1446"></td><td class="line-content">        if (percentage &gt;= 75) colorClass = "green";</td></tr><tr><td class="line-number" value="1447"></td><td class="line-content">        else if (percentage &gt;= 55) colorClass = "yellow";</td></tr><tr><td class="line-number" value="1448"></td><td class="line-content">        // Ensure base class is always present</td></tr><tr><td class="line-number" value="1449"></td><td class="line-content">        percentageProgressElement.className.baseVal = `status-circle-progress ${colorClass}`;</td></tr><tr><td class="line-number" value="1450"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1451"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1452"></td><td class="line-content">      function startTimer() {</td></tr><tr><td class="line-number" value="1453"></td><td class="line-content">        timerValue = 120; // Reset timer value</td></tr><tr><td class="line-number" value="1454"></td><td class="line-content">        totalTime = 120; // Reset total time (in case AddTime was used previously)</td></tr><tr><td class="line-number" value="1455"></td><td class="line-content">        timerExpired = false; // Reset expired flag</td></tr><tr><td class="line-number" value="1456"></td><td class="line-content">        timerTextElement.textContent = timerValue;</td></tr><tr><td class="line-number" value="1457"></td><td class="line-content">        updateTimerCircle(); // Set initial circle state</td></tr><tr><td class="line-number" value="1458"></td><td class="line-content">        clearInterval(timerInterval); // Clear any existing interval</td></tr><tr><td class="line-number" value="1459"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1460"></td><td class="line-content">        timerInterval = setInterval(() =&gt; {</td></tr><tr><td class="line-number" value="1461"></td><td class="line-content">          if (!gameActive) { // Stop timer if game ended prematurely (e.g., error, manual stop)</td></tr><tr><td class="line-number" value="1462"></td><td class="line-content">              clearInterval(timerInterval);</td></tr><tr><td class="line-number" value="1463"></td><td class="line-content">              return;</td></tr><tr><td class="line-number" value="1464"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="1465"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1466"></td><td class="line-content">          if (timerValue &gt; 0) {</td></tr><tr><td class="line-number" value="1467"></td><td class="line-content">             timerValue--;</td></tr><tr><td class="line-number" value="1468"></td><td class="line-content">             timerTextElement.textContent = timerValue;</td></tr><tr><td class="line-number" value="1469"></td><td class="line-content">             updateTimerCircle();</td></tr><tr><td class="line-number" value="1470"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1471"></td><td class="line-content">             // Visual/Haptic Feedback for low time</td></tr><tr><td class="line-number" value="1472"></td><td class="line-content">             if (timerValue &lt;= 30 &amp;&amp; timerValue &gt; 0) {</td></tr><tr><td class="line-number" value="1473"></td><td class="line-content">               timerProgressElement.style.stroke = "#f56565"; // Change color to red</td></tr><tr><td class="line-number" value="1474"></td><td class="line-content">               if (timerValue === 30 || timerValue === 20 || timerValue === 10) vibrate(300);</td></tr><tr><td class="line-number" value="1475"></td><td class="line-content">               else if (timerValue &lt; 10 &amp;&amp; timerValue &gt; 0 &amp;&amp; timerValue % 2 === 0) vibrate(150); // Vibrate every 2s under 10</td></tr><tr><td class="line-number" value="1476"></td><td class="line-content">             } else if (timerValue &gt; 30) {</td></tr><tr><td class="line-number" value="1477"></td><td class="line-content">               // Reset color if AddTime pushes it back above 30</td></tr><tr><td class="line-number" value="1478"></td><td class="line-content">               timerProgressElement.style.stroke = document.body.classList.contains("dark-mode") ? "#4299e1" : "#7F9CF5";</td></tr><tr><td class="line-number" value="1479"></td><td class="line-content">             }</td></tr><tr><td class="line-number" value="1480"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="1481"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1482"></td><td class="line-content">          // Timer reaches zero</td></tr><tr><td class="line-number" value="1483"></td><td class="line-content">          if (timerValue &lt;= 0 &amp;&amp; !timerExpired) {</td></tr><tr><td class="line-number" value="1484"></td><td class="line-content">            timerExpired = true; // Set the flag **once**</td></tr><tr><td class="line-number" value="1485"></td><td class="line-content">            timerTextElement.textContent = "0"; // Ensure display shows 0</td></tr><tr><td class="line-number" value="1486"></td><td class="line-content">            console.log("Timer reached 0. Flag set. Game will end after current/next action.");</td></tr><tr><td class="line-number" value="1487"></td><td class="line-content">             vibrate([200, 100, 200]); // Longer vibration for time up</td></tr><tr><td class="line-number" value="1488"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1489"></td><td class="line-content">            // Disable action buttons immediately when timer expires</td></tr><tr><td class="line-number" value="1490"></td><td class="line-content">            fiftyFiftyButton.disabled = true;</td></tr><tr><td class="line-number" value="1491"></td><td class="line-content">            addTimeButton.disabled = true;</td></tr><tr><td class="line-number" value="1492"></td><td class="line-content">            skipButton.disabled = true;</td></tr><tr><td class="line-number" value="1493"></td><td class="line-content">            fiftyFiftyButton.classList.add("disabled");</td></tr><tr><td class="line-number" value="1494"></td><td class="line-content">            addTimeButton.classList.add("disabled");</td></tr><tr><td class="line-number" value="1495"></td><td class="line-content">            skipButton.classList.add("disabled");</td></tr><tr><td class="line-number" value="1496"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1497"></td><td class="line-content">            // If no question is currently displayed, end the game immediately</td></tr><tr><td class="line-number" value="1498"></td><td class="line-content">             if (!currentQuestion) {</td></tr><tr><td class="line-number" value="1499"></td><td class="line-content">                 console.log("Timer expired between questions. Ending game now.");</td></tr><tr><td class="line-number" value="1500"></td><td class="line-content">                 endGame();</td></tr><tr><td class="line-number" value="1501"></td><td class="line-content">             } else {</td></tr><tr><td class="line-number" value="1502"></td><td class="line-content">                 console.log("Timer expired while question is shown. Waiting for answer/skip.");</td></tr><tr><td class="line-number" value="1503"></td><td class="line-content">                 // Game will end in checkAnswer or skipButtonClickHandler after the user acts</td></tr><tr><td class="line-number" value="1504"></td><td class="line-content">             }</td></tr><tr><td class="line-number" value="1505"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="1506"></td><td class="line-content">        }, 1000);</td></tr><tr><td class="line-number" value="1507"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1508"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1509"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1510"></td><td class="line-content">      function updateTimerCircle() {</td></tr><tr><td class="line-number" value="1511"></td><td class="line-content">        // Ensure timerValue doesn't go below 0 for calculation</td></tr><tr><td class="line-number" value="1512"></td><td class="line-content">        const clampedTime = Math.max(0, timerValue);</td></tr><tr><td class="line-number" value="1513"></td><td class="line-content">        // Calculate the proportion of time remaining</td></tr><tr><td class="line-number" value="1514"></td><td class="line-content">        const timeRatio = totalTime &gt; 0 ? clampedTime / totalTime : 0;</td></tr><tr><td class="line-number" value="1515"></td><td class="line-content">        // Calculate the stroke offset</td></tr><tr><td class="line-number" value="1516"></td><td class="line-content">        const offset = CIRCLE_CIRCUMFERENCE * (1 - timeRatio);</td></tr><tr><td class="line-number" value="1517"></td><td class="line-content">        // Apply the offset, ensuring it's within bounds [0, CIRCLE_CIRCUMFERENCE]</td></tr><tr><td class="line-number" value="1518"></td><td class="line-content">        timerProgressElement.style.strokeDashoffset = Math.max(0, Math.min(CIRCLE_CIRCUMFERENCE, offset));</td></tr><tr><td class="line-number" value="1519"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1520"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1521"></td><td class="line-content">      // --- Action Buttons ---</td></tr><tr><td class="line-number" value="1522"></td><td class="line-content">      function fiftyFiftyButtonClickHandler() {</td></tr><tr><td class="line-number" value="1523"></td><td class="line-content">        // Check conditions: not used, question loaded, timer running, game active</td></tr><tr><td class="line-number" value="1524"></td><td class="line-content">        if (!fiftyFiftyUsed &amp;&amp; currentQuestion &amp;&amp; currentQuestion.shuffledAnswers &amp;&amp; !timerExpired &amp;&amp; gameActive) {</td></tr><tr><td class="line-number" value="1525"></td><td class="line-content">          vibrate(50);</td></tr><tr><td class="line-number" value="1526"></td><td class="line-content">          fiftyFiftyUsed = true;</td></tr><tr><td class="line-number" value="1527"></td><td class="line-content">          fiftyFiftyButton.classList.add("disabled");</td></tr><tr><td class="line-number" value="1528"></td><td class="line-content">          fiftyFiftyButton.disabled = true;</td></tr><tr><td class="line-number" value="1529"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1530"></td><td class="line-content">          const buttons = answersElement.querySelectorAll(".answer-btn");</td></tr><tr><td class="line-number" value="1531"></td><td class="line-content">          const incorrectButtonsIndices = [];</td></tr><tr><td class="line-number" value="1532"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1533"></td><td class="line-content">          // Find indices of incorrect, visible buttons</td></tr><tr><td class="line-number" value="1534"></td><td class="line-content">          currentQuestion.shuffledAnswers.forEach((answer, index) =&gt; {</td></tr><tr><td class="line-number" value="1535"></td><td class="line-content">             if (!answer.isCorrect &amp;&amp; buttons[index] &amp;&amp; buttons[index].style.visibility !== 'hidden') {</td></tr><tr><td class="line-number" value="1536"></td><td class="line-content">                 incorrectButtonsIndices.push(index);</td></tr><tr><td class="line-number" value="1537"></td><td class="line-content">             }</td></tr><tr><td class="line-number" value="1538"></td><td class="line-content">          });</td></tr><tr><td class="line-number" value="1539"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1540"></td><td class="line-content">          // Shuffle the indices of incorrect buttons</td></tr><tr><td class="line-number" value="1541"></td><td class="line-content">          incorrectButtonsIndices.sort(() =&gt; Math.random() - 0.5);</td></tr><tr><td class="line-number" value="1542"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1543"></td><td class="line-content">          // Hide two of them</td></tr><tr><td class="line-number" value="1544"></td><td class="line-content">          let hiddenCount = 0;</td></tr><tr><td class="line-number" value="1545"></td><td class="line-content">          for (let i = 0; i &lt; incorrectButtonsIndices.length &amp;&amp; hiddenCount &lt; 2; i++) {</td></tr><tr><td class="line-number" value="1546"></td><td class="line-content">              const btnIndex = incorrectButtonsIndices[i];</td></tr><tr><td class="line-number" value="1547"></td><td class="line-content">              if (buttons[btnIndex]) {</td></tr><tr><td class="line-number" value="1548"></td><td class="line-content">                  buttons[btnIndex].style.visibility = "hidden";</td></tr><tr><td class="line-number" value="1549"></td><td class="line-content">                  buttons[btnIndex].disabled = true; // Also disable interaction</td></tr><tr><td class="line-number" value="1550"></td><td class="line-content">                  hiddenCount++;</td></tr><tr><td class="line-number" value="1551"></td><td class="line-content">              }</td></tr><tr><td class="line-number" value="1552"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="1553"></td><td class="line-content">          console.log("50:50 used, hid " + hiddenCount + " incorrect answers.");</td></tr><tr><td class="line-number" value="1554"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1555"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1556"></td><td class="line-content">      fiftyFiftyButton.addEventListener("click", fiftyFiftyButtonClickHandler);</td></tr><tr><td class="line-number" value="1557"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1558"></td><td class="line-content">      function addTimeButtonClickHandler() {</td></tr><tr><td class="line-number" value="1559"></td><td class="line-content">        // Check conditions: not used, timer running, game active</td></tr><tr><td class="line-number" value="1560"></td><td class="line-content">        if (!addTimeUsed &amp;&amp; !timerExpired &amp;&amp; gameActive) {</td></tr><tr><td class="line-number" value="1561"></td><td class="line-content">          vibrate(50);</td></tr><tr><td class="line-number" value="1562"></td><td class="line-content">          addTimeUsed = true;</td></tr><tr><td class="line-number" value="1563"></td><td class="line-content">          addTimeButton.classList.add("disabled");</td></tr><tr><td class="line-number" value="1564"></td><td class="line-content">          addTimeButton.disabled = true;</td></tr><tr><td class="line-number" value="1565"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1566"></td><td class="line-content">          timerValue += 30;</td></tr><tr><td class="line-number" value="1567"></td><td class="line-content">          totalTime += 30; // Increase total time as well for percentage calculation</td></tr><tr><td class="line-number" value="1568"></td><td class="line-content">          timerTextElement.textContent = timerValue; // Update display</td></tr><tr><td class="line-number" value="1569"></td><td class="line-content">          updateTimerCircle(); // Update progress circle</td></tr><tr><td class="line-number" value="1570"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1571"></td><td class="line-content">          // Check if the added time pushed the timer back above the 'warning' threshold</td></tr><tr><td class="line-number" value="1572"></td><td class="line-content">          if (timerValue &gt; 30) {</td></tr><tr><td class="line-number" value="1573"></td><td class="line-content">            timerProgressElement.style.stroke = document.body.classList.contains("dark-mode") ? "#4299e1" : "#7F9CF5";</td></tr><tr><td class="line-number" value="1574"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="1575"></td><td class="line-content">           console.log("+30 seconds used. New time:", timerValue, "New total:", totalTime);</td></tr><tr><td class="line-number" value="1576"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1577"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1578"></td><td class="line-content">      addTimeButton.addEventListener("click", addTimeButtonClickHandler);</td></tr><tr><td class="line-number" value="1579"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1580"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1581"></td><td class="line-content">      function skipButtonClickHandler() {</td></tr><tr><td class="line-number" value="1582"></td><td class="line-content">        // Check conditions: question loaded, timer running, game active</td></tr><tr><td class="line-number" value="1583"></td><td class="line-content">        if (currentQuestion &amp;&amp; currentQuestion.shuffledAnswers &amp;&amp; !timerExpired &amp;&amp; gameActive) {</td></tr><tr><td class="line-number" value="1584"></td><td class="line-content">          vibrate(50);</td></tr><tr><td class="line-number" value="1585"></td><td class="line-content">          skipUsed++;</td></tr><tr><td class="line-number" value="1586"></td><td class="line-content">          console.log("Skip used. Count:", skipUsed);</td></tr><tr><td class="line-number" value="1587"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1588"></td><td class="line-content">          // Disable answer buttons and show the correct one</td></tr><tr><td class="line-number" value="1589"></td><td class="line-content">          const answerBtns = answersElement.querySelectorAll(".answer-btn");</td></tr><tr><td class="line-number" value="1590"></td><td class="line-content">          answerBtns.forEach((btn) =&gt; {</td></tr><tr><td class="line-number" value="1591"></td><td class="line-content">              btn.disabled = true; // Disable all answer buttons</td></tr><tr><td class="line-number" value="1592"></td><td class="line-content">              const answerObj = currentQuestion.shuffledAnswers.find(a =&gt; a.text === btn.textContent);</td></tr><tr><td class="line-number" value="1593"></td><td class="line-content">              if (answerObj?.isCorrect) {</td></tr><tr><td class="line-number" value="1594"></td><td class="line-content">                  btn.classList.add("correct"); // Highlight the correct answer</td></tr><tr><td class="line-number" value="1595"></td><td class="line-content">              } else {</td></tr><tr><td class="line-number" value="1596"></td><td class="line-content">                   if (btn.style.visibility !== 'hidden') { // Only fade if not hidden by 50:50</td></tr><tr><td class="line-number" value="1597"></td><td class="line-content">                       btn.style.opacity = "0.5"; // Fade out incorrect answers</td></tr><tr><td class="line-number" value="1598"></td><td class="line-content">                   }</td></tr><tr><td class="line-number" value="1599"></td><td class="line-content">              }</td></tr><tr><td class="line-number" value="1600"></td><td class="line-content">          });</td></tr><tr><td class="line-number" value="1601"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1602"></td><td class="line-content">          // Disable the skip button itself temporarily to prevent double-clicks</td></tr><tr><td class="line-number" value="1603"></td><td class="line-content">          skipButton.disabled = true;</td></tr><tr><td class="line-number" value="1604"></td><td class="line-content">          // skipButton.classList.add("disabled"); // Optionally add visual disabled state</td></tr><tr><td class="line-number" value="1605"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1606"></td><td class="line-content">          const skippedQuestion = currentQuestion; // Keep reference</td></tr><tr><td class="line-number" value="1607"></td><td class="line-content">          currentQuestion = null; // Mark question as processed (skipped)</td></tr><tr><td class="line-number" value="1608"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1609"></td><td class="line-content">           // Add the skipped question to the mistake pool with a short delay</td></tr><tr><td class="line-number" value="1610"></td><td class="line-content">          const mistakeIndex = mistakenQuestions.findIndex((mq) =&gt; mq &amp;&amp; mq.question.id === skippedQuestion.id);</td></tr><tr><td class="line-number" value="1611"></td><td class="line-content">          if (mistakeIndex === -1 &amp;&amp; !answeredCorrectly.some(aq =&gt; aq &amp;&amp; aq.id === skippedQuestion.id)) {</td></tr><tr><td class="line-number" value="1612"></td><td class="line-content">               mistakenQuestions.push({ question: skippedQuestion, delay: 1 }); // Add with short delay (1)</td></tr><tr><td class="line-number" value="1613"></td><td class="line-content">               console.log(`Added skipped question ${skippedQuestion.id} to mistake pool.`);</td></tr><tr><td class="line-number" value="1614"></td><td class="line-content">          }</td></tr><tr><td class="line-number" value="1615"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1616"></td><td class="line-content">          // Load the next question after a short delay for feedback</td></tr><tr><td class="line-number" value="1617"></td><td class="line-content">          setTimeout(() =&gt; {</td></tr><tr><td class="line-number" value="1618"></td><td class="line-content">               // Re-enable skip button for the next question (if timer allows)</td></tr><tr><td class="line-number" value="1619"></td><td class="line-content">               if (!timerExpired) {</td></tr><tr><td class="line-number" value="1620"></td><td class="line-content">                   skipButton.disabled = false;</td></tr><tr><td class="line-number" value="1621"></td><td class="line-content">                   // skipButton.classList.remove("disabled");</td></tr><tr><td class="line-number" value="1622"></td><td class="line-content">               }</td></tr><tr><td class="line-number" value="1623"></td><td class="line-content">               loadQuestion();</td></tr><tr><td class="line-number" value="1624"></td><td class="line-content">           }, 1000); // 1 second delay</td></tr><tr><td class="line-number" value="1625"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1626"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1627"></td><td class="line-content">      skipButton.addEventListener("click", skipButtonClickHandler);</td></tr><tr><td class="line-number" value="1628"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1629"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1630"></td><td class="line-content">      // --- End Game &amp; Results ---</td></tr><tr><td class="line-number" value="1631"></td><td class="line-content">      function launchConfetti() {</td></tr><tr><td class="line-number" value="1632"></td><td class="line-content">        // Use the existing confetti function, maybe add score-based intensity?</td></tr><tr><td class="line-number" value="1633"></td><td class="line-content">        const totalQuestions = correctCount + wrongCount;</td></tr><tr><td class="line-number" value="1634"></td><td class="line-content">        const percentage = totalQuestions === 0 ? 0 : Math.round((correctCount / totalQuestions) * 100);</td></tr><tr><td class="line-number" value="1635"></td><td class="line-content">        let particleCount = 100;</td></tr><tr><td class="line-number" value="1636"></td><td class="line-content">        if (percentage &gt;= 90) particleCount = 150;</td></tr><tr><td class="line-number" value="1637"></td><td class="line-content">        if (percentage &lt; 50) particleCount = 50;</td></tr><tr><td class="line-number" value="1638"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1639"></td><td class="line-content">        confetti({ particleCount: particleCount, spread: 70, origin: { y: 0.6 } });</td></tr><tr><td class="line-number" value="1640"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1641"></td><td class="line-content">        // Extra burst for high scores or perfect scores</td></tr><tr><td class="line-number" value="1642"></td><td class="line-content">        if (percentage &gt;= 80) {</td></tr><tr><td class="line-number" value="1643"></td><td class="line-content">          const end = Date.now() + 1.5 * 1000;</td></tr><tr><td class="line-number" value="1644"></td><td class="line-content">          const colors = ["#a3bffa", "#7f9cf5", "#ffffff", "#48bb78"]; // Example colors</td></tr><tr><td class="line-number" value="1645"></td><td class="line-content">          (function frame() {</td></tr><tr><td class="line-number" value="1646"></td><td class="line-content">            confetti({ particleCount: 2, angle: 60, spread: 55, origin: { x: 0, y: 0.7 }, colors: colors });</td></tr><tr><td class="line-number" value="1647"></td><td class="line-content">            confetti({ particleCount: 2, angle: 120, spread: 55, origin: { x: 1, y: 0.7 }, colors: colors });</td></tr><tr><td class="line-number" value="1648"></td><td class="line-content">            if (Date.now() &lt; end) { requestAnimationFrame(frame); }</td></tr><tr><td class="line-number" value="1649"></td><td class="line-content">          })();</td></tr><tr><td class="line-number" value="1650"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1651"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1652"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1653"></td><td class="line-content">       function saveGameResult() {</td></tr><tr><td class="line-number" value="1654"></td><td class="line-content">        // Saves daily best based on CORRECT COUNT primarily</td></tr><tr><td class="line-number" value="1655"></td><td class="line-content">        if (!playerId) return;</td></tr><tr><td class="line-number" value="1656"></td><td class="line-content">        const now = new Date();</td></tr><tr><td class="line-number" value="1657"></td><td class="line-content">        const dateStr = now.toISOString().split("T")[0];</td></tr><tr><td class="line-number" value="1658"></td><td class="line-content">        const timestamp = now.toISOString();</td></tr><tr><td class="line-number" value="1659"></td><td class="line-content">        const totalQuestions = correctCount + wrongCount;</td></tr><tr><td class="line-number" value="1660"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1661"></td><td class="line-content">        if (totalQuestions === 0 &amp;&amp; currentGameScore === 0) {</td></tr><tr><td class="line-number" value="1662"></td><td class="line-content">             console.log("Skipping save for empty game.");</td></tr><tr><td class="line-number" value="1663"></td><td class="line-content">             return; // Don't save games with no answers/score</td></tr><tr><td class="line-number" value="1664"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1665"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1666"></td><td class="line-content">        const result = {</td></tr><tr><td class="line-number" value="1667"></td><td class="line-content">          correctCount: correctCount,</td></tr><tr><td class="line-number" value="1668"></td><td class="line-content">          totalQuestions: totalQuestions,</td></tr><tr><td class="line-number" value="1669"></td><td class="line-content">          longestStreak: longestStreak,</td></tr><tr><td class="line-number" value="1670"></td><td class="line-content">          score: currentGameScore, // &lt;&lt;&lt; Include game score</td></tr><tr><td class="line-number" value="1671"></td><td class="line-content">          timestamp: timestamp,</td></tr><tr><td class="line-number" value="1672"></td><td class="line-content">          topic: currentTopic || "unknown",</td></tr><tr><td class="line-number" value="1673"></td><td class="line-content">          tools: { fiftyFifty: fiftyFiftyUsed, addTime: addTimeUsed, skips: skipUsed },</td></tr><tr><td class="line-number" value="1674"></td><td class="line-content">          // Consider adding nickname here if needed for display, but ranking uses playerID</td></tr><tr><td class="line-number" value="1675"></td><td class="line-content">          nickname: playerNickname // Add nickname for easier display in results if needed later</td></tr><tr><td class="line-number" value="1676"></td><td class="line-content">        };</td></tr><tr><td class="line-number" value="1677"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1678"></td><td class="line-content">        const resultRef = database.ref(`gameResults/${dateStr}/${playerId}`);</td></tr><tr><td class="line-number" value="1679"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1680"></td><td class="line-content">        resultRef.once("value").then((snapshot) =&gt; {</td></tr><tr><td class="line-number" value="1681"></td><td class="line-content">            const existingResult = snapshot.val();</td></tr><tr><td class="line-number" value="1682"></td><td class="line-content">            let shouldUpdate = true;</td></tr><tr><td class="line-number" value="1683"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1684"></td><td class="line-content">            // Update if new result is better (more correct answers, tie-break with score/streak)</td></tr><tr><td class="line-number" value="1685"></td><td class="line-content">            if (existingResult) {</td></tr><tr><td class="line-number" value="1686"></td><td class="line-content">              if (result.correctCount &lt; existingResult.correctCount) {</td></tr><tr><td class="line-number" value="1687"></td><td class="line-content">                shouldUpdate = false;</td></tr><tr><td class="line-number" value="1688"></td><td class="line-content">              } else if (result.correctCount === existingResult.correctCount) {</td></tr><tr><td class="line-number" value="1689"></td><td class="line-content">                 // Tie-break 1: Higher score is better</td></tr><tr><td class="line-number" value="1690"></td><td class="line-content">                 if ((result.score || 0) &lt; (existingResult.score || 0)) {</td></tr><tr><td class="line-number" value="1691"></td><td class="line-content">                     shouldUpdate = false;</td></tr><tr><td class="line-number" value="1692"></td><td class="line-content">                 } else if ((result.score || 0) === (existingResult.score || 0)) {</td></tr><tr><td class="line-number" value="1693"></td><td class="line-content">                     // Tie-break 2: Longer streak is better</td></tr><tr><td class="line-number" value="1694"></td><td class="line-content">                     if ((result.longestStreak || 0) &lt;= (existingResult.longestStreak || 0)) {</td></tr><tr><td class="line-number" value="1695"></td><td class="line-content">                         shouldUpdate = false;</td></tr><tr><td class="line-number" value="1696"></td><td class="line-content">                     }</td></tr><tr><td class="line-number" value="1697"></td><td class="line-content">                 }</td></tr><tr><td class="line-number" value="1698"></td><td class="line-content">              }</td></tr><tr><td class="line-number" value="1699"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1700"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1701"></td><td class="line-content">            if (shouldUpdate) {</td></tr><tr><td class="line-number" value="1702"></td><td class="line-content">              resultRef.set(result)</td></tr><tr><td class="line-number" value="1703"></td><td class="line-content">                .then(() =&gt; console.log("Daily best game result saved/updated."))</td></tr><tr><td class="line-number" value="1704"></td><td class="line-content">                .catch((err) =&gt; console.error("Error saving game result:", err));</td></tr><tr><td class="line-number" value="1705"></td><td class="line-content">            } else {</td></tr><tr><td class="line-number" value="1706"></td><td class="line-content">              console.log("Existing daily result is better or equal, not updating.");</td></tr><tr><td class="line-number" value="1707"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1708"></td><td class="line-content">        }).catch((err) =&gt; console.error("Error fetching existing game result:", err));</td></tr><tr><td class="line-number" value="1709"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1710"></td><td class="line-content">        // Update cumulative score in player profile (already handled by updatePlayerStatsFirebase)</td></tr><tr><td class="line-number" value="1711"></td><td class="line-content">        // We only need to ensure the final state is saved if the game ends abruptly,</td></tr><tr><td class="line-number" value="1712"></td><td class="line-content">        // but transactions should handle consistency during the game.</td></tr><tr><td class="line-number" value="1713"></td><td class="line-content">        // Let's add a final check/update here just in case.</td></tr><tr><td class="line-number" value="1714"></td><td class="line-content">         database.ref(`players/${playerId}/cumulativeScore`).set(cumulativePlayerScore)</td></tr><tr><td class="line-number" value="1715"></td><td class="line-content">             .then(() =&gt; console.log("Final cumulative score confirmed in DB."))</td></tr><tr><td class="line-number" value="1716"></td><td class="line-content">             .catch(err =&gt; console.error("Error confirming final cumulative score:", err));</td></tr><tr><td class="line-number" value="1717"></td><td class="line-content">         localStorage.setItem("cumulativeScoreBackup", cumulativePlayerScore.toString()); // Ensure local backup is current</td></tr><tr><td class="line-number" value="1718"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="1719"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1720"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1721"></td><td class="line-content">       async function getDailyRankings() {</td></tr><tr><td class="line-number" value="1722"></td><td class="line-content">            if (!playerId) return { rankings: [], currentPlayerRank: -1 };</td></tr><tr><td class="line-number" value="1723"></td><td class="line-content">            const dateStr = new Date().toISOString().split("T")[0];</td></tr><tr><td class="line-number" value="1724"></td><td class="line-content">            try {</td></tr><tr><td class="line-number" value="1725"></td><td class="line-content">                const snapshot = await database.ref(`gameResults/${dateStr}`)</td></tr><tr><td class="line-number" value="1726"></td><td class="line-content">                                        .orderByChild("correctCount") // Primary sort: correct answers (desc)</td></tr><tr><td class="line-number" value="1727"></td><td class="line-content">                                        .limitToLast(100) // Get top 100 players for the day by correct answers</td></tr><tr><td class="line-number" value="1728"></td><td class="line-content">                                        .once("value");</td></tr><tr><td class="line-number" value="1729"></td><td class="line-content">                const results = snapshot.val() || {};</td></tr><tr><td class="line-number" value="1730"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1731"></td><td class="line-content">                const resultArray = Object.entries(results).map(([pid, data]) =&gt; ({</td></tr><tr><td class="line-number" value="1732"></td><td class="line-content">                    playerId: pid,</td></tr><tr><td class="line-number" value="1733"></td><td class="line-content">                    correctCount: data.correctCount || 0,</td></tr><tr><td class="line-number" value="1734"></td><td class="line-content">                    score: data.score || 0, // Include score</td></tr><tr><td class="line-number" value="1735"></td><td class="line-content">                    longestStreak: data.longestStreak || 0,</td></tr><tr><td class="line-number" value="1736"></td><td class="line-content">                    nickname: data.nickname || `שחקן...${pid.substring(pid.length - 4)}` // Use saved nickname or generate one</td></tr><tr><td class="line-number" value="1737"></td><td class="line-content">                }));</td></tr><tr><td class="line-number" value="1738"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1739"></td><td class="line-content">                // Secondary sort: score (desc), then streak (desc)</td></tr><tr><td class="line-number" value="1740"></td><td class="line-content">                resultArray.sort((a, b) =&gt;</td></tr><tr><td class="line-number" value="1741"></td><td class="line-content">                    b.correctCount - a.correctCount || // Sort by correct count (desc)</td></tr><tr><td class="line-number" value="1742"></td><td class="line-content">                    b.score - a.score || // Then by score (desc)</td></tr><tr><td class="line-number" value="1743"></td><td class="line-content">                    b.longestStreak - a.longestStreak // Then by streak (desc)</td></tr><tr><td class="line-number" value="1744"></td><td class="line-content">                );</td></tr><tr><td class="line-number" value="1745"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1746"></td><td class="line-content">                const currentPlayerRank = resultArray.findIndex((r) =&gt; r.playerId === playerId) + 1; // Find rank (1-based)</td></tr><tr><td class="line-number" value="1747"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1748"></td><td class="line-content">                return { rankings: resultArray, currentPlayerRank: currentPlayerRank &gt; 0 ? currentPlayerRank : -1 };</td></tr><tr><td class="line-number" value="1749"></td><td class="line-content">            } catch (error) {</td></tr><tr><td class="line-number" value="1750"></td><td class="line-content">                console.error("Error fetching daily rankings:", error);</td></tr><tr><td class="line-number" value="1751"></td><td class="line-content">                return { rankings: [], currentPlayerRank: -1 }; // Return empty on error</td></tr><tr><td class="line-number" value="1752"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1753"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1754"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1755"></td><td class="line-content">        async function getOverallRankings(limit = 10) {</td></tr><tr><td class="line-number" value="1756"></td><td class="line-content">            if (!playerId) return { rankings: [], currentPlayerRank: -1 };</td></tr><tr><td class="line-number" value="1757"></td><td class="line-content">            try {</td></tr><tr><td class="line-number" value="1758"></td><td class="line-content">                const snapshot = await database.ref('players')</td></tr><tr><td class="line-number" value="1759"></td><td class="line-content">                                        .orderByChild('cumulativeScore') // Order by cumulative score</td></tr><tr><td class="line-number" value="1760"></td><td class="line-content">                                        .limitToLast(limit) // Get the top 'limit' players</td></tr><tr><td class="line-number" value="1761"></td><td class="line-content">                                        .once('value');</td></tr><tr><td class="line-number" value="1762"></td><td class="line-content">                const results = snapshot.val() || {};</td></tr><tr><td class="line-number" value="1763"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1764"></td><td class="line-content">                 const resultArray = Object.entries(results).map(([pid, data]) =&gt; ({</td></tr><tr><td class="line-number" value="1765"></td><td class="line-content">                    playerId: pid,</td></tr><tr><td class="line-number" value="1766"></td><td class="line-content">                    cumulativeScore: data.cumulativeScore || 0,</td></tr><tr><td class="line-number" value="1767"></td><td class="line-content">                    nickname: data.nickname || `שחקן...${pid.substring(pid.length - 4)}` // Use nickname or generate one</td></tr><tr><td class="line-number" value="1768"></td><td class="line-content">                 }));</td></tr><tr><td class="line-number" value="1769"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1770"></td><td class="line-content">                // Sort descending by score (Firebase returns ascending with limitToLast)</td></tr><tr><td class="line-number" value="1771"></td><td class="line-content">                resultArray.sort((a, b) =&gt; b.cumulativeScore - a.cumulativeScore);</td></tr><tr><td class="line-number" value="1772"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1773"></td><td class="line-content">                 // Find current player's rank *within this top list*</td></tr><tr><td class="line-number" value="1774"></td><td class="line-content">                const currentPlayerRank = resultArray.findIndex(r =&gt; r.playerId === playerId) + 1;</td></tr><tr><td class="line-number" value="1775"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1776"></td><td class="line-content">                return { rankings: resultArray, currentPlayerRank: currentPlayerRank &gt; 0 ? currentPlayerRank : -1 };</td></tr><tr><td class="line-number" value="1777"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1778"></td><td class="line-content">            } catch (error) {</td></tr><tr><td class="line-number" value="1779"></td><td class="line-content">                console.error("Error fetching overall rankings:", error);</td></tr><tr><td class="line-number" value="1780"></td><td class="line-content">                 return { rankings: [], currentPlayerRank: -1 }; // Return empty on error</td></tr><tr><td class="line-number" value="1781"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1782"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1783"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1784"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1785"></td><td class="line-content">        function displayRankings(element, rankings, currentPlayerRank, scoreField, rankLabelPrefix = "") {</td></tr><tr><td class="line-number" value="1786"></td><td class="line-content">             element.innerHTML = ""; // Clear previous content</td></tr><tr><td class="line-number" value="1787"></td><td class="line-content">             if (!rankings || rankings.length === 0) {</td></tr><tr><td class="line-number" value="1788"></td><td class="line-content">                 element.innerHTML = "&lt;p&gt;אין נתוני דירוג זמינים כרגע.&lt;/p&gt;";</td></tr><tr><td class="line-number" value="1789"></td><td class="line-content">                 return;</td></tr><tr><td class="line-number" value="1790"></td><td class="line-content">             }</td></tr><tr><td class="line-number" value="1791"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1792"></td><td class="line-content">             const list = document.createElement("ul");</td></tr><tr><td class="line-number" value="1793"></td><td class="line-content">             rankings.forEach((player, index) =&gt; {</td></tr><tr><td class="line-number" value="1794"></td><td class="line-content">                 const rank = index + 1;</td></tr><tr><td class="line-number" value="1795"></td><td class="line-content">                 const li = document.createElement("li");</td></tr><tr><td class="line-number" value="1796"></td><td class="line-content">                 if (player.playerId === playerId) {</td></tr><tr><td class="line-number" value="1797"></td><td class="line-content">                     li.classList.add("current-player");</td></tr><tr><td class="line-number" value="1798"></td><td class="line-content">                 }</td></tr><tr><td class="line-number" value="1799"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1800"></td><td class="line-content">                 const rankSpan = document.createElement("span");</td></tr><tr><td class="line-number" value="1801"></td><td class="line-content">                 rankSpan.className = "rank-number";</td></tr><tr><td class="line-number" value="1802"></td><td class="line-content">                 rankSpan.textContent = `#${rank}`;</td></tr><tr><td class="line-number" value="1803"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1804"></td><td class="line-content">                 const nameSpan = document.createElement("span");</td></tr><tr><td class="line-number" value="1805"></td><td class="line-content">                 nameSpan.className = "rank-name";</td></tr><tr><td class="line-number" value="1806"></td><td class="line-content">                 nameSpan.textContent = player.nickname; // Display nickname</td></tr><tr><td class="line-number" value="1807"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1808"></td><td class="line-content">                 const scoreSpan = document.createElement("span");</td></tr><tr><td class="line-number" value="1809"></td><td class="line-content">                 scoreSpan.className = "rank-score";</td></tr><tr><td class="line-number" value="1810"></td><td class="line-content">                 scoreSpan.textContent = (player[scoreField] || 0).toLocaleString(); // Display the relevant score</td></tr><tr><td class="line-number" value="1811"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1812"></td><td class="line-content">                 li.appendChild(rankSpan);</td></tr><tr><td class="line-number" value="1813"></td><td class="line-content">                 li.appendChild(nameSpan);</td></tr><tr><td class="line-number" value="1814"></td><td class="line-content">                 li.appendChild(scoreSpan);</td></tr><tr><td class="line-number" value="1815"></td><td class="line-content">                 list.appendChild(li);</td></tr><tr><td class="line-number" value="1816"></td><td class="line-content">             });</td></tr><tr><td class="line-number" value="1817"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1818"></td><td class="line-content">             element.appendChild(list);</td></tr><tr><td class="line-number" value="1819"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1820"></td><td class="line-content">             // Add a note if the current player is not in the displayed top list</td></tr><tr><td class="line-number" value="1821"></td><td class="line-content">             if (currentPlayerRank === -1 &amp;&amp; rankings.some(p =&gt; p.playerId === playerId)) {</td></tr><tr><td class="line-number" value="1822"></td><td class="line-content">                 // This case shouldn't happen with findIndex logic, but as a fallback:</td></tr><tr><td class="line-number" value="1823"></td><td class="line-content">                 element.innerHTML += `&lt;p style="font-size: 0.8rem; margin-top: 5px;"&gt;אתה ברשימה, אך הדירוג המדויק לא חושב.&lt;/p&gt;`;</td></tr><tr><td class="line-number" value="1824"></td><td class="line-content">             } else if (currentPlayerRank === -1 &amp;&amp; totalQuestions &gt; 0) { // Only show if they played</td></tr><tr><td class="line-number" value="1825"></td><td class="line-content">                  // Fetch the player's *actual* rank if they aren't in the top list (more complex, skip for now)</td></tr><tr><td class="line-number" value="1826"></td><td class="line-content">                  // For simplicity, just show their score if they aren't top N</td></tr><tr><td class="line-number" value="1827"></td><td class="line-content">                  const playerScore = scoreField === 'cumulativeScore' ? cumulativePlayerScore : currentGameScore;</td></tr><tr><td class="line-number" value="1828"></td><td class="line-content">                  element.innerHTML += `&lt;p style="font-size: 0.8rem; margin-top: 5px;"&gt;הדירוג שלך מחוץ ל-${rankings.length} הראשונים (${rankLabelPrefix}${playerScore.toLocaleString()}).&lt;/p&gt;`;</td></tr><tr><td class="line-number" value="1829"></td><td class="line-content">             }</td></tr><tr><td class="line-number" value="1830"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1831"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1832"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1833"></td><td class="line-content">      async function endGame() {</td></tr><tr><td class="line-number" value="1834"></td><td class="line-content">        if (!gameActive) return; // Prevent double execution</td></tr><tr><td class="line-number" value="1835"></td><td class="line-content">        gameActive = false;</td></tr><tr><td class="line-number" value="1836"></td><td class="line-content">        console.log("Game ended. Displaying results.");</td></tr><tr><td class="line-number" value="1837"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1838"></td><td class="line-content">        clearInterval(timerInterval);</td></tr><tr><td class="line-number" value="1839"></td><td class="line-content">        gameScreen.style.display = "none";</td></tr><tr><td class="line-number" value="1840"></td><td class="line-content">        resultScreen.style.display = "block";</td></tr><tr><td class="line-number" value="1841"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1842"></td><td class="line-content">        saveGameResult(); // Save game result and update cumulative score</td></tr><tr><td class="line-number" value="1843"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1844"></td><td class="line-content">        const totalQuestions = correctCount + wrongCount;</td></tr><tr><td class="line-number" value="1845"></td><td class="line-content">        const percentage = totalQuestions === 0 ? 0 : Math.round((correctCount / totalQuestions) * 100);</td></tr><tr><td class="line-number" value="1846"></td><td class="line-content">        const endTimeValue = timerExpired ? 0 : timerValue;</td></tr><tr><td class="line-number" value="1847"></td><td class="line-content">        const timeSpent = totalTime - endTimeValue; // Use totalTime which includes added time</td></tr><tr><td class="line-number" value="1848"></td><td class="line-content">        const avgTimePerQuestion = totalQuestions === 0 ? 0 : Math.round(timeSpent / totalQuestions);</td></tr><tr><td class="line-number" value="1849"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1850"></td><td class="line-content">        // --- Update Score Display ---</td></tr><tr><td class="line-number" value="1851"></td><td class="line-content">        scoreElement.innerHTML = `ניקוד במשחק: &lt;span class="highlight"&gt;${currentGameScore.toLocaleString()}&lt;/span&gt;&lt;br&gt;ניקוד מצטבר: ${cumulativePlayerScore.toLocaleString()}`;</td></tr><tr><td class="line-number" value="1852"></td><td class="line-content">        accuracyStatsElement.innerHTML = `נכונות: ${correctCount}/${totalQuestions} | רצף שיא: ${longestStreak} | זמן ממוצע: ${avgTimePerQuestion} שנ'`;</td></tr><tr><td class="line-number" value="1853"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1854"></td><td class="line-content">        // Result Circle Animation</td></tr><tr><td class="line-number" value="1855"></td><td class="line-content">        const resultOffset = RESULT_CIRCLE_CIRCUMFERENCE * (1 - percentage / 100);</td></tr><tr><td class="line-number" value="1856"></td><td class="line-content">        resultProgressCircleElement.style.strokeDashoffset = Math.max(0, Math.min(RESULT_CIRCLE_CIRCUMFERENCE, resultOffset));</td></tr><tr><td class="line-number" value="1857"></td><td class="line-content">        let resultColorClass = "red";</td></tr><tr><td class="line-number" value="1858"></td><td class="line-content">        if (percentage &gt;= 75) resultColorClass = "green";</td></tr><tr><td class="line-number" value="1859"></td><td class="line-content">        else if (percentage &gt;= 55) resultColorClass = "yellow";</td></tr><tr><td class="line-number" value="1860"></td><td class="line-content">        resultProgressCircleElement.setAttribute("class", `status-circle-progress ${resultColorClass}`);</td></tr><tr><td class="line-number" value="1861"></td><td class="line-content">        percentageTextResultElement.textContent = "0%"; // Start from 0</td></tr><tr><td class="line-number" value="1862"></td><td class="line-content">        let count = 0;</td></tr><tr><td class="line-number" value="1863"></td><td class="line-content">        const percentageAnim = setInterval(() =&gt; {</td></tr><tr><td class="line-number" value="1864"></td><td class="line-content">            count++;</td></tr><tr><td class="line-number" value="1865"></td><td class="line-content">            if (count &lt;= percentage) {</td></tr><tr><td class="line-number" value="1866"></td><td class="line-content">                percentageTextResultElement.textContent = `${count}%`;</td></tr><tr><td class="line-number" value="1867"></td><td class="line-content">            } else {</td></tr><tr><td class="line-number" value="1868"></td><td class="line-content">                clearInterval(percentageAnim);</td></tr><tr><td class="line-number" value="1869"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1870"></td><td class="line-content">        }, 20); // Animation speed</td></tr><tr><td class="line-number" value="1871"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1872"></td><td class="line-content">        // Tools Used</td></tr><tr><td class="line-number" value="1873"></td><td class="line-content">        let toolsText = "";</td></tr><tr><td class="line-number" value="1874"></td><td class="line-content">        if (fiftyFiftyUsed) toolsText += "50:50, ";</td></tr><tr><td class="line-number" value="1875"></td><td class="line-content">        if (addTimeUsed) toolsText += "30+, ";</td></tr><tr><td class="line-number" value="1876"></td><td class="line-content">        if (skipUsed &gt; 0) toolsText += `דילוג (${skipUsed}), `;</td></tr><tr><td class="line-number" value="1877"></td><td class="line-content">        toolsText = toolsText.endsWith(", ") ? toolsText.slice(0, -2) : toolsText;</td></tr><tr><td class="line-number" value="1878"></td><td class="line-content">        toolsUsedElement.textContent = toolsText || "לא נעשה שימוש בכלים";</td></tr><tr><td class="line-number" value="1879"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1880"></td><td class="line-content">        // --- Display Rankings ---</td></tr><tr><td class="line-number" value="1881"></td><td class="line-content">        rankingElement.innerHTML = "טוען דירוג יומי..."; // Placeholder</td></tr><tr><td class="line-number" value="1882"></td><td class="line-content">        overallRankingElement.innerHTML = "טוען דירוג כללי..."; // Placeholder</td></tr><tr><td class="line-number" value="1883"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1884"></td><td class="line-content">        try {</td></tr><tr><td class="line-number" value="1885"></td><td class="line-content">             const [dailyData, overallData] = await Promise.all([</td></tr><tr><td class="line-number" value="1886"></td><td class="line-content">                 getDailyRankings(),</td></tr><tr><td class="line-number" value="1887"></td><td class="line-content">                 getOverallRankings(10) // Get Top 10 overall</td></tr><tr><td class="line-number" value="1888"></td><td class="line-content">             ]);</td></tr><tr><td class="line-number" value="1889"></td><td class="line-content">             // Display Daily Ranking (Top 100 sorted by correct, then score, then streak)</td></tr><tr><td class="line-number" value="1890"></td><td class="line-content">             displayRankings(rankingElement, dailyData.rankings.slice(0, 10), dailyData.currentPlayerRank, 'correctCount', 'תשובות: ');</td></tr><tr><td class="line-number" value="1891"></td><td class="line-content">             // Display Overall Ranking (Top 10 sorted by cumulative score)</td></tr><tr><td class="line-number" value="1892"></td><td class="line-content">             displayRankings(overallRankingElement, overallData.rankings, overallData.currentPlayerRank, 'cumulativeScore', 'ניקוד: ');</td></tr><tr><td class="line-number" value="1893"></td><td class="line-content">        } catch (error) {</td></tr><tr><td class="line-number" value="1894"></td><td class="line-content">             console.error("Error fetching or displaying rankings:", error);</td></tr><tr><td class="line-number" value="1895"></td><td class="line-content">             rankingElement.textContent = "שגיאה בטעינת דירוג יומי.";</td></tr><tr><td class="line-number" value="1896"></td><td class="line-content">             overallRankingElement.textContent = "שגיאה בטעינת דירוג כללי.";</td></tr><tr><td class="line-number" value="1897"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1898"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1899"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1900"></td><td class="line-content">        // Mistakes Review</td></tr><tr><td class="line-number" value="1901"></td><td class="line-content">        mistakesElement.innerHTML = ""; // Clear previous</td></tr><tr><td class="line-number" value="1902"></td><td class="line-content">        if (mistakeDetails.length &gt; 0) {</td></tr><tr><td class="line-number" value="1903"></td><td class="line-content">          const uniqueMistakes = new Map();</td></tr><tr><td class="line-number" value="1904"></td><td class="line-content">          // Show only the *first* instance of each question missed</td></tr><tr><td class="line-number" value="1905"></td><td class="line-content">          mistakeDetails.forEach((mistake) =&gt; {</td></tr><tr><td class="line-number" value="1906"></td><td class="line-content">             if (!uniqueMistakes.has(mistake.question)) {</td></tr><tr><td class="line-number" value="1907"></td><td class="line-content">                 uniqueMistakes.set(mistake.question, mistake);</td></tr><tr><td class="line-number" value="1908"></td><td class="line-content">             }</td></tr><tr><td class="line-number" value="1909"></td><td class="line-content">          });</td></tr><tr><td class="line-number" value="1910"></td><td class="line-content">          uniqueMistakes.forEach((mistake) =&gt; {</td></tr><tr><td class="line-number" value="1911"></td><td class="line-content">            mistakesElement.innerHTML += `&lt;div class="mistake-block"&gt;&lt;div class="mistake-question"&gt;${mistake.question}&lt;/div&gt;&lt;div class="wrong-answer"&gt;❌ תשובתך: ${mistake.selected}&lt;/div&gt;&lt;div class="correct-answer"&gt;✅ התשובה הנכונה: ${mistake.correct}&lt;/div&gt;&lt;/div&gt;`;</td></tr><tr><td class="line-number" value="1912"></td><td class="line-content">          });</td></tr><tr><td class="line-number" value="1913"></td><td class="line-content">        } else {</td></tr><tr><td class="line-number" value="1914"></td><td class="line-content">          mistakesElement.innerHTML = totalQuestions &gt; 0 ? '&lt;p class="perfect"&gt;💯 מושלם! כל התשובות נכונות!&lt;/p&gt;' : "&lt;p&gt;לא ענית על שאלות במשחק זה.&lt;/p&gt;";</td></tr><tr><td class="line-number" value="1915"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1916"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1917"></td><td class="line-content">        // Tag Analysis (Clickable Links)</td></tr><tr><td class="line-number" value="1918"></td><td class="line-content">        tagAnalysisElement.innerHTML = "";</td></tr><tr><td class="line-number" value="1919"></td><td class="line-content">        const isDarkMode = document.body.classList.contains("dark-mode");</td></tr><tr><td class="line-number" value="1920"></td><td class="line-content">        const colorSchemes = { /* ... (keep existing color schemes) ... */</td></tr><tr><td class="line-number" value="1921"></td><td class="line-content">            light: { success: { background: "#e6fffa", text: "#2c7a7b", border: "#9ae6b4" }, moderate: { background: "#fffbeb", text: "#b7791f", border: "#f6e05e" }, failure: { background: "#fff5f5", text: "#c53030", border: "#feb2b2" }, },</td></tr><tr><td class="line-number" value="1922"></td><td class="line-content">            dark: { success: { background: "#2f855a", text: "#f0fff4", border: "#68d391" }, moderate: { background: "#b7791f", text: "#fffbeb", border: "#f6e05e" }, failure: { background: "#c53030", text: "#fff5f5", border: "#fc8181" }, },</td></tr><tr><td class="line-number" value="1923"></td><td class="line-content">        };</td></tr><tr><td class="line-number" value="1924"></td><td class="line-content">        const currentScheme = isDarkMode ? colorSchemes.dark : colorSchemes.light;</td></tr><tr><td class="line-number" value="1925"></td><td class="line-content">        const successThreshold = 75, failureThreshold = 50;</td></tr><tr><td class="line-number" value="1926"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1927"></td><td class="line-content">        const tagCloudData = Object.entries(gameTagStats).map(([tag, stats]) =&gt; {</td></tr><tr><td class="line-number" value="1928"></td><td class="line-content">            if (!tag || typeof stats !== 'object' || stats === null) return null; // Basic validation</td></tr><tr><td class="line-number" value="1929"></td><td class="line-content">            const total = (stats.correct || 0) + (stats.wrong || 0);</td></tr><tr><td class="line-number" value="1930"></td><td class="line-content">            if (total === 0) return null; // Skip tags with no answers</td></tr><tr><td class="line-number" value="1931"></td><td class="line-content">            const accuracy = Math.round(((stats.correct || 0) / total) * 100);</td></tr><tr><td class="line-number" value="1932"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1933"></td><td class="line-content">            let colors, sortOrder;</td></tr><tr><td class="line-number" value="1934"></td><td class="line-content">            if (accuracy &gt;= successThreshold) { colors = currentScheme.success; sortOrder = 1; } // High accuracy first</td></tr><tr><td class="line-number" value="1935"></td><td class="line-content">            else if (accuracy &lt; failureThreshold) { colors = currentScheme.failure; sortOrder = 3; } // Low accuracy last</td></tr><tr><td class="line-number" value="1936"></td><td class="line-content">            else { colors = currentScheme.moderate; sortOrder = 2; } // Moderate in middle</td></tr><tr><td class="line-number" value="1937"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1938"></td><td class="line-content">            let fontWeight = (stats.wrong || 0) &gt; (stats.correct || 0) ? "bold" : "normal"; // Bold if more wrong than right</td></tr><tr><td class="line-number" value="1939"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1940"></td><td class="line-content">            return { tag, colors, fontWeight, accuracy, correct: stats.correct || 0, total, sortOrder };</td></tr><tr><td class="line-number" value="1941"></td><td class="line-content">        }).filter(item =&gt; item !== null); // Remove nulls</td></tr><tr><td class="line-number" value="1942"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1943"></td><td class="line-content">        // Sort by accuracy group, then alphabetically within group</td></tr><tr><td class="line-number" value="1944"></td><td class="line-content">        tagCloudData.sort((a, b) =&gt; {</td></tr><tr><td class="line-number" value="1945"></td><td class="line-content">            if (a.sortOrder !== b.sortOrder) return a.sortOrder - b.sortOrder;</td></tr><tr><td class="line-number" value="1946"></td><td class="line-content">            return a.tag.localeCompare(b.tag, "he"); // Alphabetical within group</td></tr><tr><td class="line-number" value="1947"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="1948"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1949"></td><td class="line-content">        if (tagCloudData.length &gt; 0) {</td></tr><tr><td class="line-number" value="1950"></td><td class="line-content">          tagCloudData.forEach((item) =&gt; {</td></tr><tr><td class="line-number" value="1951"></td><td class="line-content">            const linkElement = document.createElement("a");</td></tr><tr><td class="line-number" value="1952"></td><td class="line-content">            linkElement.classList.add("tag-cloud-item");</td></tr><tr><td class="line-number" value="1953"></td><td class="line-content">            const searchTerm = encodeURIComponent(`${item.tag} ביולוגיה`);</td></tr><tr><td class="line-number" value="1954"></td><td class="line-content">            linkElement.href = `https://www.google.com/search?q=${searchTerm}`;</td></tr><tr><td class="line-number" value="1955"></td><td class="line-content">            linkElement.target = "_blank";</td></tr><tr><td class="line-number" value="1956"></td><td class="line-content">            linkElement.rel = "noopener noreferrer"; // Security best practice</td></tr><tr><td class="line-number" value="1957"></td><td class="line-content">            linkElement.style.backgroundColor = item.colors.background;</td></tr><tr><td class="line-number" value="1958"></td><td class="line-content">            linkElement.style.color = item.colors.text;</td></tr><tr><td class="line-number" value="1959"></td><td class="line-content">            linkElement.style.borderColor = item.colors.border;</td></tr><tr><td class="line-number" value="1960"></td><td class="line-content">            linkElement.style.fontWeight = item.fontWeight;</td></tr><tr><td class="line-number" value="1961"></td><td class="line-content">            linkElement.textContent = `#${item.tag}`;</td></tr><tr><td class="line-number" value="1962"></td><td class="line-content">            linkElement.title = `דיוק: ${item.accuracy}% (${item.correct}/${item.total}) - חפש '${item.tag}' בגוגל`; // Tooltip</td></tr><tr><td class="line-number" value="1963"></td><td class="line-content">            tagAnalysisElement.appendChild(linkElement);</td></tr><tr><td class="line-number" value="1964"></td><td class="line-content">          });</td></tr><tr><td class="line-number" value="1965"></td><td class="line-content">        } else {</td></tr><tr><td class="line-number" value="1966"></td><td class="line-content">          tagAnalysisElement.innerHTML = "&lt;p&gt;לא נצברו נתונים על תגיות במשחק זה.&lt;/p&gt;";</td></tr><tr><td class="line-number" value="1967"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1968"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1969"></td><td class="line-content">        // Result Buttons</td></tr><tr><td class="line-number" value="1970"></td><td class="line-content">        shareButton.onclick = () =&gt; {</td></tr><tr><td class="line-number" value="1971"></td><td class="line-content">            vibrate(50);</td></tr><tr><td class="line-number" value="1972"></td><td class="line-content">            // Updated share text to include score</td></tr><tr><td class="line-number" value="1973"></td><td class="line-content">            const shareText = `שיחקתי טריווBIO בנושא ${topicNames[currentTopic] || 'מעורב'} והשגתי ${currentGameScore.toLocaleString()} נקודות (${percentage}% דיוק) עם רצף שיא של ${longestStreak}! 🎉 סה"כ צברתי ${cumulativePlayerScore.toLocaleString()} נקודות. בואו לשחק גם!`;</td></tr><tr><td class="line-number" value="1974"></td><td class="line-content">            let currentUrl = window.location.href;</td></tr><tr><td class="line-number" value="1975"></td><td class="line-content">            if (currentUrl.endsWith('/')) {</td></tr><tr><td class="line-number" value="1976"></td><td class="line-content">                currentUrl = currentUrl.slice(0, -1); // Remove trailing slash if present</td></tr><tr><td class="line-number" value="1977"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1978"></td><td class="line-content">            const shareData = { title: "טריווBIO - תוצאת משחק", text: shareText, url: currentUrl };</td></tr><tr><td class="line-number" value="1979"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="1980"></td><td class="line-content">            if (navigator.share) {</td></tr><tr><td class="line-number" value="1981"></td><td class="line-content">                navigator.share(shareData)</td></tr><tr><td class="line-number" value="1982"></td><td class="line-content">                    .then(() =&gt; console.log("Successful share"))</td></tr><tr><td class="line-number" value="1983"></td><td class="line-content">                    .catch((error) =&gt; console.log("Error sharing", error));</td></tr><tr><td class="line-number" value="1984"></td><td class="line-content">            } else {</td></tr><tr><td class="line-number" value="1985"></td><td class="line-content">                // Fallback for browsers without navigator.share</td></tr><tr><td class="line-number" value="1986"></td><td class="line-content">                navigator.clipboard.writeText(shareText + " " + currentUrl)</td></tr><tr><td class="line-number" value="1987"></td><td class="line-content">                    .then(() =&gt; showToast("התוצאה והקישור הועתקו!"))</td></tr><tr><td class="line-number" value="1988"></td><td class="line-content">                    .catch((err) =&gt; {</td></tr><tr><td class="line-number" value="1989"></td><td class="line-content">                        console.error("Failed to copy text: ", err);</td></tr><tr><td class="line-number" value="1990"></td><td class="line-content">                        showToast("שגיאה בהעתקת התוצאה.");</td></tr><tr><td class="line-number" value="1991"></td><td class="line-content">                    });</td></tr><tr><td class="line-number" value="1992"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1993"></td><td class="line-content">        };</td></tr><tr><td class="line-number" value="1994"></td><td class="line-content">        restartButton.onclick = () =&gt; {</td></tr><tr><td class="line-number" value="1995"></td><td class="line-content">          vibrate(50);</td></tr><tr><td class="line-number" value="1996"></td><td class="line-content">          resultScreen.style.display = "none";</td></tr><tr><td class="line-number" value="1997"></td><td class="line-content">          startScreen.style.display = "block";</td></tr><tr><td class="line-number" value="1998"></td><td class="line-content">          // resetGame() is implicitly called when a new game starts via topic button</td></tr><tr><td class="line-number" value="1999"></td><td class="line-content">        };</td></tr><tr><td class="line-number" value="2000"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2001"></td><td class="line-content">        launchConfetti(); // Fire confetti!</td></tr><tr><td class="line-number" value="2002"></td><td class="line-content">      }</td></tr><tr><td class="line-number" value="2003"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="2004"></td><td class="line-content">    <span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="2005"></td><td class="line-content">  <span class="html-tag">&lt;/body&gt;</span></td></tr><tr><td class="line-number" value="2006"></td><td class="line-content"><span class="html-tag">&lt;/html&gt;</span><span class="html-end-of-file"></span></td></tr></tbody></table></body></html>