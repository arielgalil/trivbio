{
  "rules": {
    "admins": {
      ".read": "auth != null && root.child('admins').child(auth.uid).exists() && root.child('admins').child(auth.uid).val() === true",
      ".write": false
    },
    "questions": {
      ".read": "auth != null",
      ".write": "auth != null && root.child('admins').child(auth.uid).exists() && root.child('admins').child(auth.uid).val() === true"
    },
    "players": {
      ".read": "auth != null && root.child('admins').child(auth.uid).exists() && root.child('admins').child(auth.uid).val() === true",
      "$playerId": {
        ".read": "auth != null && (auth.uid === $playerId || (root.child('admins').child(auth.uid).exists() && root.child('admins').child(auth.uid).val() === true))",
        // --- שינוי כאן ---
        // אפשר כתיבה (יצירה ועדכון) אם המשתמש הוא הבעלים
        ".write": "auth != null && auth.uid === $playerId",
        "nickname": {
           // חוק זה נשאר כפי שהוא, מאפשר עדכון לכינוי אם הוא כבר קיים
           ".write": "auth != null && auth.uid === $playerId && data.exists()",
           ".validate": "newData.isString() && newData.val().length <= 25"
        },
        "darkMode": {
           // חוק זה נשאר כפי שהוא, מאפשר עדכון למצב כהה אם הוא כבר קיים
           ".write": "auth != null && auth.uid === $playerId && data.exists()",
           ".validate": "newData.isBoolean()"
        },
        "lastTopic": {
           // חוק זה נשאר כפי שהוא, מאפשר עדכון לנושא האחרון אם הוא כבר קיים
           ".write": "auth != null && auth.uid === $playerId && data.exists()",
           ".validate": "newData.isString()"
        },
        "cumulativeScore": {
          // חוק זה כבר מאפשר עדכון על ידי הבעלים
          ".write": "auth != null && auth.uid === $playerId",
          ".validate": "newData.isNumber()"
        },
        "correctCount": {
          // חוק זה כבר מאפשר עדכון על ידי הבעלים
          ".write": "auth != null && auth.uid === $playerId",
          ".validate": "newData.isNumber()"
        },
        "wrongCount": {
          // חוק זה כבר מאפשר עדכון על ידי הבעלים
          ".write": "auth != null && auth.uid === $playerId",
          ".validate": "newData.isNumber()"
        },
        "topicStats": {
          // חוק זה כבר מאפשר עדכון על ידי הבעלים
          ".write": "auth != null && auth.uid === $playerId",
          "$topic": {
            ".validate": "newData.hasChildren(['correctCount', 'wrongCount']) && newData.child('correctCount').isNumber() && newData.child('wrongCount').isNumber()"
          }
        },
        "tagStats": {
          // חוק זה כבר מאפשר עדכון על ידי הבעלים
          ".write": "auth != null && auth.uid === $playerId",
          "$tag": {
            ".validate": "newData.hasChildren(['correctCount', 'wrongCount']) && newData.child('correctCount').isNumber() && newData.child('wrongCount').isNumber()"
          }
        },
        // --- הערה לגבי ה-validate הזה ---
        // כדאי לשקול אם ה-validate הזה נחוץ. הוא דורש ש *כל* כתיבה ל-/$playerId תכיל את כל השדות הללו.
        // אם אתה מבצע עדכונים חלקיים (למשל, רק את lastTopic), ה-validate הזה עלול לגרום לשגיאות.
        // ייתכן שעדיף להסיר אותו ולהסתמך על ה-validate של השדות הספציפיים.
        // ".validate": "newData.hasChildren(['cumulativeScore', 'correctCount', 'wrongCount', 'topicStats', 'tagStats'])", // REMOVED OR COMMENTED OUT FOR FLEXIBILITY
        "$other": {
          ".write": false
        }
      }
    },
    "gameResults": {
      "$date": {
        ".read": "auth != null",
        "$playerId": {
          ".read": "auth != null",
          ".write": "auth != null && auth.uid === $playerId",
          ".validate": "newData.hasChildren(['correctCount', 'totalQuestions', 'longestStreak', 'timestamp', 'topic', 'tools','nickname']) && newData.child('correctCount').isNumber() && newData.child('totalQuestions').isNumber() && newData.child('totalQuestions').val() >= newData.child('correctCount').val() && newData.child('longestStreak').isNumber() && newData.child('timestamp').isString() && newData.child('topic').isString() && newData.child('nickname').isString() && newData.child('tools').hasChildren(['fiftyFifty', 'addTime', 'skips']) && newData.child('tools/fiftyFifty').isBoolean() && newData.child('tools/addTime').isBoolean() && newData.child('tools/skips').isNumber()"
        }
      }
    },
    "leaderboard": {
      ".read": "auth != null",
      ".write": false,
      "$playerId": {
        ".write": "auth != null && auth.uid === $playerId",
        ".validate": "newData.hasChildren(['nickname', 'cumulativeScore']) && newData.child('nickname').isString() && newData.child('cumulativeScore').isNumber()"
      }
    }
  }
}