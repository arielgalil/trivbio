{
  "rules": {
    "admins": {
      // מאפשר קריאה רק לאדמינים רשומים כדי לאמת את עצמם
      ".read": "auth != null && root.child('admins').child(auth.uid).exists() && root.child('admins').child(auth.uid).val() === true",
      // לא מאפשר כתיבה לאף אחד ישירות דרך הכללים
      ".write": false
    },
    "questions": {
      // כל משתמש מאומת (כולל אנונימי) יכול לקרוא שאלות
      ".read": "auth != null",
      // רק אדמינים יכולים לכתוב (ליצור/לעדכן/למחוק) שאלות
      ".write": "auth != null && root.child('admins').child(auth.uid).exists() && root.child('admins').child(auth.uid).val() === true"
    },
    "players": {
      // אדמינים יכולים לקרוא את כל רשימת השחקנים
      ".read": "auth != null && root.child('admins').child(auth.uid).exists() && root.child('admins').child(auth.uid).val() === true",
      "$playerId": {
        // משתמש יכול לקרוא את הנתונים של עצמו, ואדמין יכול לקרוא נתונים של כל משתמש
        ".read": "auth != null && (auth.uid === $playerId || (root.child('admins').child(auth.uid).exists() && root.child('admins').child(auth.uid).val() === true))",
        // משתמש יכול לכתוב לנתונים של עצמו (ליצירה ראשונית ועדכונים), ואדמין יכול לכתוב לנתונים של כל משתמש
        ".write": "auth != null && (auth.uid === $playerId || (root.child('admins').child(auth.uid).exists() && root.child('admins').child(auth.uid).val() === true))",

        // --- ולידציה ספציפית לשדות ---
        // (הוסרו חוקי .write מגבילים, מסתמכים על חוק ה-write הכללי למעלה)
        "nickname": {
          // בדיקה שהכינוי הוא מחרוזת לא ריקה באורך תקין
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 25"
        },
        "darkMode": { // <--- שם השדה תוקן כדי להתאים לקוד
          // בדיקה שהערך הוא בוליאני (true/false)
          ".validate": "newData.isBoolean()"
        },
        "lastTopic": {
          // בדיקה שהערך הוא מחרוזת
          ".validate": "newData.isString()"
        },
        "registrationDate": {
           // מונע שינוי אחרי יצירה, בודק פורמט תאריך
          ".write": "data.exists() ? false : (auth != null && auth.uid === $playerId)", // אפשר כתיבה רק אם הנתון לא קיים (יצירה) ורק ע"י המשתמש
          ".validate": "newData.isString() && newData.val().matches(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/)" // ולידציה של פורמט YYYY-MM-DD
        },
         "createdAt": {
             // מונע שינוי אחרי יצירה, בודק שזה חותמת זמן
            ".write": "data.exists() ? false : (auth != null && auth.uid === $playerId)", // אפשר כתיבה רק אם הנתון לא קיים (יצירה) ורק ע"י המשתמש
            ".validate": "newData.isNumber() && newData.val() === now" // וידוא שזה מספר שהוא חותמת זמן של Firebase
        },
        "cumulativeScore": {
          // בדיקה שהניקוד הוא מספר
          ".validate": "newData.isNumber()"
        },
        "correctCount": {
          // בדיקה שהספירה היא מספר
          ".validate": "newData.isNumber()"
        },
        "wrongCount": {
          // בדיקה שהספירה היא מספר
          ".validate": "newData.isNumber()"
        },
        "availableSkips": { // הוספת ולידציה לגלגלי הצלה
            // בדיקה שהמספר לא שלילי
            ".validate": "newData.isNumber() && newData.val() >= 0"
        },
        "availableFiftyFifty": { // הוספת ולידציה לגלגלי הצלה
            // בדיקה שהמספר לא שלילי
            ".validate": "newData.isNumber() && newData.val() >= 0"
        },
        "topicStats": {
          // ולידציה של מבנה הסטטיסטיקות לנושא
          "$topic": {
            ".validate": "newData.hasChildren(['correctCount', 'wrongCount']) && newData.child('correctCount').isNumber() && newData.child('wrongCount').isNumber()"
          }
        },
        "tagStats": {
          // ולידציה של מבנה הסטטיסטיקות לתגית
          "$tag": {
            ".validate": "newData.hasChildren(['correctCount', 'wrongCount']) && newData.child('correctCount').isNumber() && newData.child('wrongCount').isNumber()"
          }
        },
        // מאפשר כתיבה רק לשדות המוכרים המפורטים כאן
        "$other": {
          ".validate": "$other === 'nickname' || $other === 'darkMode' || $other === 'lastTopic' || $other === 'registrationDate' || $other === 'createdAt' || $other === 'cumulativeScore' || $other === 'correctCount' || $other === 'wrongCount' || $other === 'availableSkips' || $other === 'availableFiftyFifty' || $other === 'topicStats' || $other === 'tagStats'"
        }
      },
      // אינדקסים נשארים כפי שהם
      ".indexOn": ["nickname", "registrationDate"]
    },
    "gameResults": {
      // כל משתמש מאומת יכול לקרוא תוצאות
      ".read": "auth != null",
      "$date": {
        // ניתן להוסיף אינדקס אם תרצה לסנן תוצאות יומיות לפי קריטריון מסוים
        // ".indexOn": ["correctCount"],
        "$gameResultId": { // שימוש במזהה תוצאה ייחודי (מ-push) במקום playerId
          ".read": "auth != null",
          // מאפשר יצירה חדשה, ומאפשר עדכון רק אם ה-playerId בתוך התוצאה תואם למשתמש המאומת
          ".write": "auth != null && (!data.exists() || data.child('playerId').val() === auth.uid)",
          // ולידציה מעודכנת בהתאם לשדות שנשמרים בפונקציה saveGameResult בקוד הלקוח
          ".validate": "newData.hasChildren(['correctCount', 'totalQuestions', 'longestStreak', 'score', 'timestamp', 'topic', 'tools', 'nickname', 'playerId']) && newData.child('playerId').isString() && newData.child('playerId').val() === auth.uid && newData.child('score').isNumber() && newData.child('correctCount').isNumber() && newData.child('totalQuestions').isNumber() && newData.child('totalQuestions').val() >= newData.child('correctCount').val() && newData.child('longestStreak').isNumber() && newData.child('timestamp').isNumber() && newData.child('topic').isString() && newData.child('nickname').isString() && newData.child('tools').hasChildren(['fiftyFifty', 'addTime', 'skips']) && newData.child('tools/fiftyFifty').isNumber() && newData.child('tools/addTime').isBoolean() && newData.child('tools/skips').isNumber()"
        }
      }
    },
    "leaderboard": {
      // אינדקס חובה למיון הלוח
      ".indexOn": ["cumulativeScore"],
      // כל משתמש מאומת יכול לקרוא את הלוח
      ".read": "auth != null",
      "$playerId": {
        // רק מנהלים יכולים לכתוב ישירות ללוח הדירוג (עדיף לנהל דרך Cloud Function)
        ".write": "auth != null && root.child('admins').child(auth.uid).exists() && root.child('admins').child(auth.uid).val() === true",
        // ולידציה בסיסית אם מנהל כותב
        ".validate": "newData.hasChildren(['nickname', 'cumulativeScore']) && newData.child('nickname').isString() && newData.child('cumulativeScore').isNumber()"
      }
    }
  }
}